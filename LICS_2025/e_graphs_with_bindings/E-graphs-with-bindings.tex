\documentclass[peerreviewcls]{IEEEtran}
% \IEEEoverridecommandlockouts
% The preceding line is only needed to identify funding in the first footnote. If that is unneeded, please comment it out.
%Template version as of 6/27/2024


\usepackage{cite}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{algorithmic}
\usepackage{graphicx}
\usepackage{textcomp}
\usepackage{xcolor}

\usepackage{amsthm}

\usepackage{mathtools}
\usepackage{tikz}
\usepackage{tikz-network}
\usepackage{xspace}
\usepackage{xargs}
\usepackage{fontenc}

\usepackage{subcaption}
\usepackage{caption}

\usepackage{tikz-cd}
\usepackage{tikzit}
% to reduce tikz picture white space
\usepackage{adjustbox}

% for quotienting
\usepackage{xfrac} 


\newtheorem{theorem}{Theorem}[section]
\newtheorem{definition}[theorem]{Definition}
\newtheorem{example}[theorem]{Example}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{remark}[theorem]{Remark}

% some macros that maybe should be moved elsewhere

\newcommand\HypI[1]{\textbf{HypI}(#1)}
\newcommand\MdaCospans{\textbf{MHypI}(\Sigma)}
\newcommand{\Ecospans}{{\catname{EHypI(\Sigma)}}}
\newcommand{\MdaEcospans}{{\catname{MEHypI(\Sigma)}}}
\newcommand{\WellTypedMdaEcospans}{{\catname{MEHypI(\Sigma)}}}
% conflict
\newcommand{\hashtag}{{\#}}
\newcommand{\consistency}{{\smile}}

\input{../../macros}
\input{../../sample.tikzstyles}
\input{../../hypergraph.tikzstyles}
\input{../../hypergraph.tikzdefs}


\def\BibTeX{{\rm B\kern-.05em{\sc i\kern-.025em b}\kern-.08em
    T\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}
\begin{document}

\title{E-graphs With Bindings
}

% \author{\IEEEauthorblockN{1\textsuperscript{st} Given Name Surname}
% \IEEEauthorblockA{\textit{dept. name of organization (of Aff.)} \\
% \textit{name of organization (of Aff.)}\\
% City, Country \\
% email address or ORCID}
% \and
% }

\author{Anonymous}

\maketitle

\begin{abstract}
This is abstract.
\end{abstract}

\begin{IEEEkeywords}
component, formatting, style, styling, insert.
\end{IEEEkeywords}

\section{Introduction}

\subsection{Motivation and contribution}

E-graphs (short for \emph{equality graphs})~\cite{EggPaper} are a data structure incorporating equivalence representation and used in automated theorem proving, compiler optimisation, and program analysis. 
Using e-graphs mitigates the so-called \emph{phase-ordering problem} of term rewriting, that is the fact that the way rewrites are scheduled may enable or block further rewrites due to introduction or elimination or redexes. 
This is achieved by making rewrites on e-graphs non-destructive: an application of a rewrite rule instead of replacing the left-hand side by the right-hand side, adds the latter to the graph so that all pre-existing redexes are protected and new ones are introduced. 
Explosive growth of the graph is avoided by the clever use of sharing of vertices. 

E-graphs were first introduced in the automated theorem proving literature in the 1980s~\cite{nelson1980techniques}, but recent years have seen renewed interest particularly for optimisation and synthesis using so called \emph{equality saturation}~\cite{10.1145/1594834.1480915, griggio_proceedings_2022, EggPaper,flatt_small_2022}, the repeated application of rewrites to an e-graph until a fixpoint is reached. 
The wide range of application domains led to extensions of the e-graph formalism, for instance to account for conditional rewriting~\cite{singher2023colored} or  to combine e-graphs with database queries (\emph{relational e-matching})~\cite{zhang_relational_2022}.
Of particular interest to us is using e-graphs in the context of functional programming languages, which requires a representation of the $\lambda$-calculus using it. 
Pioneering work in this direction has been done by~\cite{koehler2022sketchguided} where
the authors outlined the two interconnected challenges of binding and capture-avoiding substitution that arise when doing equality saturation for $\lambda$-calculus with e-graphs.
A key challenge is that as e-graphs represent multiple terms at once, with as much sharing as possible, using variable names for binding means that two $\alpha$-equivalent terms can not be shared as they are not identical.

\begin{red}
DRG: UNCLEAR. Even though such simple encoding makes expressing $\beta$-reduction as a rewrite rule in terms of explicit substitution simpler, applying such rules requires computing extra free variable predicates and populates a given e-graph with extra nodes for explicit substitution.
The commonly deployed solution to quotienting terms by $\alpha$-equivalence, encoding binding using $\textit{de Brujin}$ indices, still fails to represent $\alpha$-equivalent terms as being structurally equivalent for the purpose of e-graphs. 
Consider the simple example term $\lambda . \%0 ((\lambda . \%1 \%0) 42)$ the same binder is represented with $\%0$ and $\%1$, avoids explicit substitution when implementing $\beta$-reduction at the cost of including \textit{ad hoc} operators for index shifting into the rewrite rules.
Generally, the incurred redundancy these challenges remain problematic because variable binding is not inherent to e-graphs as they do not provide an internal support for it.
There are also other inchoate approaches to adding internal support for binding which, however, make the formulation of e-graph considerably more complicated~\cite{slotted-egraphs}.
\end{red}

In this paper we take what we consider to be a principled approach to e-graphs with bindings by lifting to monoidal closed categories prior work showing how e-graphs (without binding) can be given a categorical semantics using semilattice-enriched symmetric monoidal categories, which allows e-graphs to be reconstructed as string diagrams.~\cite{ghica2024equivalencehypergraphsegraphsmonoidal}
The approach in \emph{loc. cit.} was originally motivated by the desire to support the machinery of categorial (DPO) graph rewriting for e-graphs, but by extending the semilattice-enrichment to monoidal-categories it paves the way to a natural derivation of e-graphs with binding.

\subsection{String diagrams}

We build on the technology of string diagrams, which is by now well developed in a number of areas. 
String diagrams have the advantage of being a direct bridge from the language of category theory, which in turn can be used to give semantic models to a variety of programming languages and logics, to the concrete language of graphs, all based on solid mathematical foundations. 
To solve the new problems discuss above, of dealing with binding and capture avoiding substitution, we just follow the categorical breadcrumb trail. 

The general background literature for string diagrams is summarised in~\cite{https://arxiv.org/abs/2305.08768}.
The particular context of string diagrams with bindings is given in~\cite{https://arxiv.org/abs/2305.18945}, while string diagrams for e-graphs without bindings are defined in~\cite{https://arxiv.org/abs/2406.15882}.

String diagrams provide a geometric or topological framework for understanding monoidal categories, representing objects as \emph{strings} and morphisms as \emph{nodes}, where input strings flow in and output strings flow out. 
Key structures in monoidal categories---such as the monoidal product, tensor unit, braiding, and dualities---are represented through operations like placing, weaving, or bending strings. 
This visual approach makes complex operations such as the trace intuitive and reveals insights sometimes obscured by symbolic notation. 
Originating from notations by Hotz~\cite{??} (for automata) and Penrose~\cite{??} (for tensor networks), string diagrams generalise to any monoidal category and even bicategories, offering a dual perspective to commutative diagrams through Poincar√© duality. 

As described above, string diagrams are commonly an informal yet rigorous two-dimensional syntax for the internal language of a category. 
They can be formalised by representing them as graphs or hypergraphs~\cite{https://dl.acm.org/doi/full/10.1145/3502719}, which has two further benefits. 
The first benefit is that the property of two string diagrams being equal if and only if they ``look the same'' can be spelled out as graph isomorphism, eliminating any possible ambiguity of interpretation. 
The second benefit is that equational reasoning can also be formalised as (categorical) graph rewriting, for instance double-pushout rewriting (DPO). 

Finally, to represent diagrammatically two concepts essential to both programming languages (binding) and to e-graphs (equivalence classes) we rely on the concept of \emph{functorial boxes} as introduced by Melli\`es~\cite{https://link.springer.com/chapter/10.1007/11874683_1}. 
The diagrammatic boxes require the introduction of further structure to (hyper)graphs in the form of a hierarchical layering of the graphs, as studied in \emph{loc. cit.}.

DRG TODO: ADD AN EXAMPLE OF A STRING DIAGRAM HERE BEFORE DISCUSSING IT IN THE NEXT SECTIONS. BEST WE HAVE A RUNNING EXAMPLE THAT IS RELATED TO THE DIFFICULTY OF REPRESENTING E-GRAPHS FOR LAMBDA CALCULUS. 

\subsection{E-graphs}

E-graphs can efficiently simultaneously represent several equivalent terms of an algebraic theory, generalising the DAG representation of terms to include equivalence classes.
The key concepts of e-graphs can be intuitively grasped from some simple (but non-trivial) examples, as shown in Figure~\ref{fig:e-graph-example}, a `Hello world!' of e-graphs~\cite{EggPaper}.

\begin{figure*}
\[
\adjustbox{scale=0.7}{
\tikzfig{figures/e-graph-example}
}
\]
\caption{E-graph example (top) and its equivalent string diagram representation (bottom)}
\label{fig:e-graph-example}
\end{figure*}

Each column represents a term (or term rewrite rule), its conventional e-graph, and the equivalent string diagram representation using the approach in~\cite{ghica2024equivalencehypergraphsegraphsmonoidal}. 
Note that for the initial term, $(a*2)/2$ (subfigure (a)), which is already represented efficiently in the e-graph by sharing the node `2', the string diagram version shares this node explicitly, using a contraction node
\scalebox{0.4}{
	\begin{tikzpicture}
		\begin{pgfonlayer}{nodelayer}
			\node [style=vertex] (0) at (1.5, 3.5) {};
			\node [style=none] (1) at (1.5, 3) {};
			\node [style=none] (2) at (1, 4) {};
			\node [style=none] (3) at (2, 4) {};
		\end{pgfonlayer}
		\begin{pgfonlayer}{edgelayer}
			\draw (0) to (1.center);
			\draw [bend right=45] (0) to (3.center);
			\draw [bend left=45] (0) to (2.center);
		\end{pgfonlayer}
	\end{tikzpicture}
}
. 

Nodes of an e-graph are encapsulated in dashed boxes indicating equivalence classes of nodes, or, more generally, of subgraphs rooted at these boxes.
A term graph is embedded as an e-graph by making each equivalence class have a single node.
The first rewrite rule, replacing multiplication by \emph{shift-left} creates the first non-unitary equivalence class, which includes the multiplication ($*$) and shift-left ($<\!\!<$) nodes,  now sharing the node `$a$'.
This second e-graph illustrates the other representational difference, besides sharing, between conventional e-graphs and e-hypergraphs.
In the former, edges connect directly to nodes inside the equivalence class, whereas in the latter edges connect to the equivalence class itself.
Explicit discarding (weakening) nodes, depicted with black dots with a single wire inside the dashed boxes 
\scalebox{0.4}{
	\begin{tikzpicture}
		\begin{pgfonlayer}{nodelayer}
			\node [style=vertex] (0) at (1.5, 3.5) {};
			\node [style=none] (1) at (1.5, 3) {};
		\end{pgfonlayer}
		\begin{pgfonlayer}{edgelayer}
			\draw (0) to (1.center);
		\end{pgfonlayer}
	\end{tikzpicture}
}, indicate which of the class-level edges are connected to which nodes inside the class.

The other steps, (c) to (e), represent further elaborations of the e-graph, or e-hypergraph, via the application of more rewrite rules.

A common way of dealing with $\beta$-reduction for the $\lambda$-calculus in e-graphs is by using special nodes for explicit substitution and associating them with particular rewrite rules~\cite{EggPaper,koehler2022sketchguided}.
The auxiliary nature of these nodes is revealed by the fact that after rewrites they must be removed from the graph. 
We will see how in the categorically-directed representation these nodes are not necessary because explicit substitution is simply modelled categorically as composition, a significant simplification.

\subsection{Conventional vs. categorical e-graphs with binding}

Before diving into the technical details let us compare how substitution works in conventional e-graphs as compared to our proposed approach.
In Figure~\ref{fig:e-graph-substitution} we show successive iterations of a conventional e-graph for $(\lambda x . (y + y) + x) 1$ following the $\beta$-reductions.
A subterm for an explicit substitution must be introduced, which is deemed equivalent to the top-level application term, to be rewritten using the rules for explicit substitution at the top of each column.
At the end, all explicit substitution nodes can be removed.

The same example is given in Figure~\ref{fig:e-string-substitution} using string diagrams. 
The $\lambda$-abstraction is represented by a rounded box and the bound variable is the dangling wire.
The application node is depicted as 
\adjustbox{scale=0.15}{\begin{tikzpicture}
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (1, 6.75) {};
		\node [style=none] (1) at (1.25, 7.75) {};
		\node [style=none] (2) at (2, 8) {};
		\node [style=none] (3) at (2.75, 7.75) {};
		\node [style=none] (4) at (3, 6.75) {};
		\node [style=none] (5) at (1.5, 6.75) {};
		\node [style=none] (6) at (2.5, 6.75) {};
		\node [style=none] (7) at (2, 9) {};
		\node [style=none] (8) at (1.5, 5.75) {};
		\node [style=none] (9) at (2.5, 5.75) {};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw [style=new edge style 2] (3.center)
			 to [in=60, out=-30, looseness=0.75] (4.center)
			 to (0.center)
			 to [in=-150, out=120, looseness=0.75] (1.center)
			 to [in=-180, out=45, looseness=0.75] (2.center)
			 to [in=135, out=0, looseness=0.75] cycle;
		\draw (2.center) to (7.center);
		\draw (5.center) to (8.center);
		\draw (9.center) to (6.center);
	\end{pgfonlayer}
\end{tikzpicture}
}. 
The reduction is now simply the re-attachment of wires, and the overall process is visibly simpler. 
DRG UNCLEAR: Note how we avoided re-attachment for subterms as they did not use the bound variable wire, unlike in the case $[x \mapsto 1](y+y)$ before.

DRG UNCLEAR: A common solution to replace explicit variable names in e-graphs is by using De Brujin indices~\cite{koehler2022sketchguided}.
The issue with this approach is that it interferes with sharing as equivalent subterms can be structurally different.
Consider the example $\lambda f . f ((\lambda x . f x) 2)$ which is represented as $\lambda . \%0 ((\lambda . \%1 \%0) 2)$ using De Brujin indices.
Notice how two different occurrences of the same bound variable $f$ are represented differently by $\%0$ and $\%1$ which means they can not be shared in an e-graph.
A string diagrammatic representation of the same term makes it possible for $f$ to be shared as demonstrated below.

DRG USE WRAP-BOX. 
\[
\adjustbox{scale=0.6}{
    \tikzfig{figures/de-brujin-string}
}
\]

Using De Brujin indices when performing $\beta$-reduction also introduces the complexity of representing the reduction as a rewrite rule.
Special shifting operators need to be introduced on the right-hand side of a rewrite rule which makes it not merely syntactic~\cite{koehler2022sketchguided}.


\textcolor{red}{Add example showing that using De Brujin indices with e-graphs breaks sharing}

\textcolor{red}{Add example showing $\beta$-reduction in e-graphs compared to string diagrams}


\begin{figure*}
    \[
        % \hspace{1.3cm}
        \adjustbox{width=\textwidth}{
        \tikzfig{figures/e-graph-substitution}
        }
    \]
    \caption{E-graph explicit substitution example.}
    \label{fig:e-graph-substitution}
  \end{figure*}
  
  \begin{figure*}
    \[
        % \hspace{1.3cm}
        \adjustbox{width=\textwidth}{
        \tikzfig{figures/e-string-substitution-2}
        }
    \]
    \caption{String diagrammatic substitution example.}
    \label{fig:e-string-substitution}
  \end{figure*}

\input{sections/categorical_semantics}

\section{Combinatorial semantics}


We can extend the definition of e-hypergraphs for $\catname{SLat}$-enriched symmetric monoidal categories~\cite{ghica2024equivalencehypergraphsegraphsmonoidal} to accommodate new structure brought by closedness.

\begin{definition}
Closed monoidal signature $\Sigma$ is a pair $(\Sigma_{O},\Sigma_{M})$ of signatures for objects and signatures for morphisms with sources and targets in $\text{obj}_{\Sigma_{O}}$ defined as
\begin{itemize}
  \item $I$ (monoidal unit) is in $\text{obj}_{\Sigma_{O}}$
  \item For every $o \in \Sigma_{O}$, $o \in \text{obj}_{\Sigma_{O}}$;
  \item For every $o_1$ and $o_2$ $ \in \text{obj}_{\Sigma_{O}}$, $o_1 \otimes o_2 \in \text{obj}{\Sigma_{O}}$ and $o_1 \multimap o_2 \in \text{obj}_{\Sigma_{O}}$
\end{itemize}
\end{definition}

\begin{definition}
 Closed symmetric monoidal theory ($\catname{CSMT}$) over a closed monoidal signature $\Sigma$ and equations $\mathcal{E}$ denoted as $\catname{CSMT}(\Sigma, \mathcal{E})$ is given by a set of terms $T$
 \begin{align*}
 T \coloneq\; &t : A \to B \in \Sigma_{M} \;|\; t_1 \otimes t_2 : A \otimes C \to B \otimes D \text{ for } t_{1} : A \to B, t_{2} : C \to D \in T\\
            & \;|\; t_{1};t_{2} : A \to C \text{ for } t_{1} : A \to B, t_{2} : B \to C \in T \; | \;  \Lambda(t) : A \to X \multimap B \text{ for } t : A \otimes X \to B \\
            &  \;|\; \text{eval}(t_1 \otimes t_2) : B \text{ for } t_1 : X \multimap B, t_2 : X \in T \\
            &  \;|\; \text{sym}_{A,B} \;|\; id_{A}
 \end{align*}
 quotiented by the laws of a closed symmetric monoidal category.
\end{definition}
% \question{Maybe types and terms combined is not a good idea}
\begin{definition}

We define an e-hypergraph $\mathcal{G}$ over a closed symmetric monoidal signature $\Sigma$ as a tuple $(V,E,s,t, l_{V}, l_{E} \textcolor{red}{<}, \textcolor{blue}{<},\consistency)$ where
\begin{itemize}
  \item $V$ is a set of vertices;
  \item $E = \textcolor{gray}{E} \cup \textcolor{red}{E} \cup \textcolor{blue}{E}$ is a set of hyperedges that include \textit{plain} edges and two types of \textit{hierarchical} edges respectively;
  \item $s,t : E \to V^{*}$ are source and target functions;
  \item $l_{E} : E \to \Sigma_{M} + 1$, $l_{V} : V \to \text{obj}_{\Sigma_{O}}$ are \textit{label} functions;
  \item $\textcolor{red}{<} : V + E \to \textcolor{red}{E}$ and $\textcolor{blue}{<} : V + E \to \textcolor{blue}{E}$ are partial \textit{child} functions that are disjoint: if $\textcolor{red}{<}(x)$ is defined then $\textcolor{blue}{<}(x)$ is undefined and vice-versa;
  \item $\consistency = \bigcup_{p} \consistency_{p}$, where $\consistency_{p}$ is a \textit{consistency} relation defined on each set $\{x \in V + E \;|\; p \;\textcolor{red}{<^{\mu}}\; x\}$;
\end{itemize} 
\end{definition}

$\textcolor{red}{E}$ will contain edges that encode the equivalence classes and $\textcolor{blue}{E}$ the ones that defined the lambda abstraction.
All the above functions and relations must satisfy the obvious properties (TODO: add them).

Similarly, we have a category of (extended) cospans formed by such e-hypergraphs where morphisms are of the form
\[
n \xrightarrow{f_{\text{ext}}} n' \xrightarrow{f_{\text{int}}} \mathcal{G} \xleftarrow{g'_{\text{int}}} m' \xleftarrow{g_{\text{ext}}} m
\]

where $n$ and $m$ are external input and output interfaces respectively and $n'$, $m'$ are input and output internal interfaces.
$n,n',m,m'$ are discrete ordered e-hypergraphs.
We further require that $f_{\text{ext}}$ and $g_{\text{ext}}$ are monos and all vertices in the image of $f_{\text{ext}};f_{\text{int}}$ (respectively, $g_{\text{ext}};g_{\text{int}}$) are top-level.

To build a correspondence between terms of a closed SMC and e-hypergraphs with interfaces (above) we restrict the cospans of the latter to monogamous cospans.

\begin{definition}
  We call a cospan 
  \[
n \xrightarrow{f_{\text{ext}}} n' \xrightarrow{f_{\text{int}}} \mathcal{G} \xleftarrow{g'_{\text{int}}} m' \xleftarrow{g_{\text{ext}}} m
\]
\textit{weak} monogamous if
\begin{itemize}
  \item in- and out- degrees of every vertex is at most 1;
  \item $f_{\text{int}}$ and $g_{\text{int}}$ are monos;
  \item Vertices with in-degree (respectively, out-degree) of 0 are precisely the image of $f_{\text{int}}$ (respectively, $g_{\text{int}}$).
\end{itemize}

\end{definition}


\begin{definition}[Isomorphic cospans]
Consider a relation 
\[
R = \{ x R y \text{ if } f_{\text{int}}(x) \consistency f_{\text{int}}(y) \;\text{or}\; \exists z \;\text{s.t.}\; z \textcolor{blue}{<^{\mu}} f_{\text{int}}(x) \text{ and } z \textcolor{blue}{<}^{\mu} f_{\text{int}}(y)\}
\]
for $x, y \in n'$.
And let $S$ be its reflexive closure.
The latter partitions $n'$ into non-empty subsets $\{p_{j}\}^{k}_{j=1}$.
We get an analogous partition for $m'$.

Two extended cospans are isomorphic if there exist isomorphisms $\alpha$, $\beta$ and $\gamma$ making the following diagram commute and such that $\alpha$ and $\gamma$ preserve order within each $p_j$.
\[
\scalebox{0.8}{
    \tikzfig{../../figures/combinatorial_semantics/isomorphic_e_cospans}
}
\]
\end{definition}


Consider an example of isomorphic and non-isomorphic cospans below and their respective string diagrams

\begin{figure}
  \begin{subfigure}[c]{0.4\linewidth}
    \[
    \adjustbox{scale=0.6}{
    \tikzfig{./figures/closed_iso_example_1}
    }
    \]
  \end{subfigure}
  \hfill
  \begin{subfigure}[c]{0.4\linewidth}
    \[
    \adjustbox{scale=0.6}{
    \tikzfig{./figures/closed_iso_example_2}
    }
    \]
  \end{subfigure}
\end{figure}

\begin{definition}

We define ordered sets of \textit{input} (respectively, \textit{output}) vertices of a hierarchical edge $e$ as the vertices $v_{i}$ such that $e < v_{i}$ which are in the image of $f_{\text{int}}$ (respectively, $g_{\text{ext}}$) with the induced ordering.
\end{definition}

\begin{definition}

Given an ordered set $S$ of labelled vertices we can form words formed by concatenating the labels.
We will denote such words as $w(S)$.
\end{definition}

\begin{definition}
We call a monogamous cospan
\[
  n \xrightarrow{f_{\text{ext}}} n' \xrightarrow{f_{\text{int}}} \mathcal{G} \xleftarrow{g'_{\text{int}}} m' \xleftarrow{g_{\text{ext}}} m
\]
\textit{well-typed} if all hierarchical edges of $\mathcal{G}$ are well-typed in the sense below.
\begin{itemize}
  \item For each $e \in \textcolor{red}{E}$ consider sets $I$ and $O$ of its input and output vertices partitioned according to $\consistency_{e}$.
        $e$ is well-typed if for each element $S$ of the partition of $I$ $w(S) = w(s(e))$ and similarly for $O$ and $t(e)$.
  \item For each $e \in \textcolor{blue}{E}$ consider sets $I$ and $O$ of its input and output vertices.
        $e$ is well-typed if there exists an object $B \in \text{obj}_{\Sigma_{O}}$ such that $[...s(e), B] = w(I)$ and $B \multimap w(O) = w(t(e))$
\end{itemize}
\end{definition}



\bibliographystyle{acm}
\bibliography{../../bibliography}

\end{document}
