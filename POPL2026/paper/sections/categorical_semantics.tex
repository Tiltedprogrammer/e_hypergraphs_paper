\section{Categorical semantics of E-Graphs with Bindings}%
\label{sec:categorical}

This section introduces preliminaries on symmetric monoidal semilattice-enriched categories generated by monoidal theories, and the string diagram formalism used to represent them.
We also show a specific case of closed monoidal semilattice-enriched categories and how the closed structure interacts with the enrichment.

Given a category $\mathbb{C}$  with objects $A,B \in \mathbb{C}$ we denote by $\mathbb{C}(A,B)$ the corresponding Hom set.
We write the identity morphism on $A$ as $\id_A$.
We commonly write $f;g$ for composition in diagrammatic order.
Composition in the usual order is written $g \circ f$.
We denote the tensor product of an symmetric monoidal category $\mathbb{C}$ by $\otimes$,  its unit by $I$, and its symmetry natural transformation as $\sym$ \cite{maclane}.
We adopt the convention that $\otimes$ binds more tightly than $(;\!)$.
We elide all associativity and unit isomorphisms associated with monoidal categories, and often omit subscripts on identities and natural transformations where it can be inferred.
Given two adjoint functors $F\colon \mathbb{A} \to \mathbb{B}$ and $G\colon \mathbb{B} \to \mathbb{A}$ with $F$ being left-adjoint, we write $F \dashv G\colon \mathbb{B} \to \mathbb{A}$ for this adjunction.

First, recall some basic definitions.
\begin{definition}
	A monoidal signature $\Sigma = (\Sigma_{O}, \Sigma_{M}, t)$ is given by a set of objects (called types) $\Sigma_{O}$, a set of generators (operations) $\Sigma_{M}$ and a type assignment function $t\colon \Sigma_{M} \to \Sigma_{O}^{*} \times \Sigma_{O}^{*}$ assigning lists of input and output types to a given operation.
\end{definition}

\begin{definition}
	A set of $\Sigma$-terms generated by monoidal signature $\Sigma$ is given by the following grammar:
	\[
		\tau \coloneqq \phi \;|\; \id_{I} \;|\; \id_{A} \;|\; \sym_{A,B} \;|\; \tau_{1};\tau_{2} \;|\; \tau_{1} \otimes \tau_{2},
	\]
	where $\phi$ ranges over the set of operators $\Sigma_{M}$ and $A,B$ range over the set of objects $\Sigma_{O}$.
\end{definition}

Identities and symmetries of complex types, e.g.\ $\id_{A \otimes B}$ and $\sym_{A \otimes B, C}$, are given by the composition and tensoring of $\id_{A}$ and $\sym_{A,B}$ as, e.g.\ $\id_{A \otimes B} = \id_{A} \otimes \id_{B}$ and $\sym_{A \otimes B, C} = (\id_{A} \otimes \sym_{B,C});(\sym_{A,C} \otimes \id_{B})$.

\begin{definition}
	A free symmetric monoidal category $\catname{S}(\Sigma)$ is given by a set of $\Sigma$-terms quotiented by the axioms of a symmetric monoidal category.
	The objects are lists of types from $\Sigma_{O}$ with tensoring given by list concatenation.
\end{definition}

\begin{definition}
	A symmetric monoidal theory $\catname{SMT}(\Sigma, \mathcal{E})$ is given by a set of $\Sigma$-terms quotiented by a set of equations $\mathcal{E}$ consisting of pairs of appropriately typed $\Sigma$ terms $l = r$.
\end{definition}

\begin{definition}
	A categorical presentation of  $\catname{SMT}(\Sigma, \mathcal{E})$ is a free symmetric monoidal category $\catname{S}(\Sigma, \mathcal{E})$ given by a set of $\Sigma$ terms quotiented by the laws of a symmetric monoidal category and equations of $\mathcal{E}$.
\end{definition}

We can similarly consider \emph{closed} terms that give rise to a free \emph{closed} symmetric monoidal category.

\begin{definition}%
	\label{def:closed}
	A (right) closed monoidal category is a monoidal category $\catname{C}$ satisfying that for
	every pair of objects $B,C$ there is an object $B \multimap C$ and a morphism $\textbf{ev}_{B,C} : (B \multimap C) \otimes B \to
		C$, and for every triple of objects $A,B,C$ there is an operation $\Lambda_{A,B,C} : \catname{C}(A \otimes B,C) \to
		\catname{C}(A,B \multimap{} C)$ such that for all $f : A \otimes B \to C$ and $g : Z \to A$ the following equations hold:
	\begin{itemize}
		\item $f = \Lambda_{A,B,C}(f) \otimes \id_{B}; \textbf{ev}_{B,C}$
		\item $\id_{B \multimap{} C} = \Lambda_{B \multimap{} C,B,C}(\textbf{ev}_{B,C})$
		\item $\Lambda_{Z,B,C}(g \otimes \id_{B}; f) = g;\Lambda_{A,B,C}(f)$
	\end{itemize}
\end{definition}

This is equivalent to defining a (right) closed monoidal category as one admitting an adjunction $- \otimes B \dashv B \multimap{} -$ for every object $B$.
If the tensor is symmetric, then the monoidal category is said to be simply \emph{closed}.

\begin{definition}
	Closed $\Sigma$-terms are defined inductively by first defining a family of objects $obj_{\Sigma_{O}}$.
	\begin{itemize}
		\item A designated $I$ is in $obj_{\Sigma_{O}}$.
		\item If $A \in obj_{\Sigma_{O}}$ and $B \in obj_{\Sigma_{O}}$, then $A \otimes B \in obj_{\Sigma_{O}}$ and $A \multimap B \in obj_{\Sigma_{O}}$.
	\end{itemize}
	A family of closed $\Sigma$ terms is then defined by:
	\begin{itemize}
		\item $\phi : A \to B \in \Sigma_{M}$ is a closed $\Sigma$-term;
		\item if $A$ and $B$ are $obj_{\Sigma_{O}}$, then $\id_{A}$ and $\sym_{A,B}$ are closed $\Sigma$-terms;
		\item if $f : A \to B$ and $g : B \to C$ are closed $\Sigma$-terms, then so is $f;g : A \to C$;
		\item if $f : A \to B$ and $g : C \to D$ are closed $\Sigma$-terms, then so is $f \otimes g : A \otimes C \to B \otimes D$;
		\item if $A$ and $B$ are $obj_{\Sigma_{O}}$, then $\textbf{ev}_{A,B} : A \multimap B \otimes A \to B$ is a closed $\Sigma$-term;
		\item if $h : X \otimes A \to B$ is a closed $\Sigma$-term, then $\Lambda_{X,A,B}(h) : X \to (A \multimap B)$ is a closed $\Sigma$-term.
	\end{itemize}
\end{definition}

\begin{definition}
	The free closed symmetric monoidal category $\catname{CS}(\Sigma)$ is given by a set of closed $\Sigma$-terms quotiented by the laws of a symmetric monoidal category and the equations from~\autoref{def:closed}.
	We can similarly consider a free closed symmetric monoidal category that is induced by a $\catname{SMT}(\Sigma, \mathcal{E})$ over closed $\Sigma$-terms which we will denote with $\catname{CS}(\Sigma, \mathcal{E})$.
\end{definition}

To encode equivalences between morphisms (or $\Sigma$-terms), the Hom sets of the corresponding free categories can be endowed with the additional structure of a semilattice induced by an idempotent, commutative and associative operator \textit{join} $+$ as presented by~\citet{tiurin2025equivalencehypergraphsdporewriting}.
This is modelled by enrichment in semilattices, yielding $\catname{SLat}$-categories where $\catname{SLat}$ is a category of \textit{unbounded} semilattices and homomorphisms between them (see~\autoref{sec:appendix:slat}).

\begin{definition}[$\catname{SLat}$-category]%
	\label{def:slat-cat}
	A $\catname{SLat}$-category $\mathbb{C}$ is defined by the following data:
	\begin{itemize}
		\item a set of objects $\mathbb{C}$;
		\item for every pair of objects $A,B \in \mathbb{C}$ --- a Hom semilattice $\mathbb{C}(A,B) \in \catname{SLat}$;
		\item for every triple of objects $A,B,C \in \mathbb{C}$ --- a composition morphism
		      $\circ\colon \mathbb{C}(B,C) \otimes \mathbb{C}(A,B) \to \mathbb{C}(A,C)$ of $\catname{SLat}$;
		\item for every object $A \in \mathbb{C}$ --- a unit morphism
		      $u_{A}\colon I \to \mathbb{C}(A,A)$, where $I$ is the monoidal unit $\{*\}$ for $\catname{SLat}$\footnote{Semilattice homomorphisms $\{*\} \to P$ are in bijection with the elements of $P$ as a set, so this is an element of the underlying set of $\mathbb{C}(A,A)$.}.
	\end{itemize}
	such that particular coherence diagrams enforcing that composition is associative and unital commute.
\end{definition}
$\catname{SLat}$ is sufficiently close to $\catname{Set}$ that Hom semilattices can be thought of as the ordinary notion of Hom sets with additional semilattice structure; unit morphisms are as usual, and composition works similarly to composition in categories with an extra condition of respecting the join: as it is a semilattice homomorphism, we require that $(f + g); h = f;h + g;h$ and $f;(g+h) = f;g + f;h$.

\begin{definition}[$\catname{SLat}$-functor]
	Let $\mathbb{C}$ and $\mathbb{D}$ be two $\catname{SLat}$-categories.
	An $\catname{SLat}$-functor $F\colon \mathbb{C} \to \mathbb{D}$ is defined by the following data:
	\begin{itemize}
		\item a mapping on objects $A$ of $\mathbb{C}$ to $F A$ of $\mathbb{D}$;
		\item for each pair of objects $A, B$ of $\mathbb{C}$, a morphism in $\catname{SLat}$ $F_{A,B}\colon \mathbb{C}(A,B) \to \mathbb{D}(FA,FB)$;
	\end{itemize}
	such that certain coherence diagrams, enforcing the preservation of composition and units, commute.
\end{definition}
As before, this is like an ordinary functor, except with an additional requirement that its action on morphisms respects the join: $F(f + g) = F(f) + F(g)$.

The collection of $\catname{SLat}$-categories and $\catname{SLat}$-functors form an $\catname{SLat}$-category $\catname{SLat}\text{--}\catname{Cat}$\footnote{More generally, if we were to define $\catname{SLat}$-natural transformations, we could view $\catname{SLat}\text{--}\catname{Cat}$ as a symmetric monoidal 2-category~\cite{Kelly2022BASICCO}.}, and for any pair of $\catname{SLat}$-categories $\mathbb{C}$ and $\mathbb{D}$, the product $\catname{SLat}$-category $\mathbb{C} \times \mathbb{D}$ is defined analogously to categories.

\begin{definition}[Symmetric monoidal $\catname{SLat}$-category]%
	\label{def:enriched-prop}
	A symmetric monoidal $\catname{SLat}$-category is given by a $\catname{SLat}$-category $\mathbb{C}$ that additionally has
	\begin{itemize}
		\item a unit object $I \in \mathbb{C}$;
		\item a $\catname{SLat}$-functor tensor $\otimes\colon \mathbb{C} \times \mathbb{C} \to \mathbb{C}$;
	\end{itemize}
	such that particular coherence diagrams analogous to those for symmetric monoidal categories commute.
\end{definition}
This is completely analogous to a symmetric monoidal category, with the fact that the tensor is an $\catname{SLat}$-functor ensuring compatibility with the join: $f \otimes (g+h) = f \otimes g + f \otimes h $ and $ (f+g) \otimes h = f \otimes h + g \otimes h$.
As before, we take $\otimes$ to bind more tightly than $+$.

\begin{proposition}(A specialised case of Proposition 6.4.7~\cite{Borceux_1994} and Theorem 5.7.1~\cite{cruttwell2008normed})
	There is a 2-adjunction
	% https://q.uiver.app/#q=WzAsMixbMCwwLCJcXGNhdG5hbWV7U0xhdHR9LVxcY2F0bmFtZXtDYXR9Il0sWzIsMCwiXFxjYXRuYW1le0NhdH0iXSxbMSwwLCJGIiwyLHsiY3VydmUiOjR9XSxbMCwxLCJHIiwyLHsiY3VydmUiOjR9XSxbMiwzLCIiLDAseyJsZXZlbCI6MSwic3R5bGUiOnsibmFtZSI6ImFkanVuY3Rpb24ifX1dXQ==
	% \[\begin{tikzcd}
	% 	\catname{SLatt}\text{--}\catname{Cat}\arrow[rr, "\mathcal{U}", bend left] & \hspace{-1em}\top & \catname{Cat} \arrow[ll, "\mathcal{F}", bend left]
	% 	\end{tikzcd}
	% \]
	\vspace{-1mm}
	\[
		\mathcal{F} \dashv \mathcal{U} : \catname{SLat}\text{--}\catname{Cat} \to \catname{Cat}
		\vspace{-1mm}
	\]
	that is induced by the usual (symmetric monoidal) free-forgetful adjunction

	% \[\begin{tikzcd}
	% 	\catname{SLatt} \arrow[rr, "U", bend left] & \top & \catname{Set} \arrow[ll, "F", bend left]
	% 	\end{tikzcd}
	% \]
	\vspace{-1mm}
	\[
		F \dashv U : \catname{SLat} \to \catname{Set}.
		\vspace{-1mm}
	\]
	Moreover, $\mathcal{F}$ and $\mathcal{U}$ preserve symmetric monoidal structure, sending symmetric monoidal categories to symmetric monoidal $\catname{SLat}$-categories and vice versa.
\end{proposition}
In particular, the 2-functor $\mathcal{F}$ turns every category $\mathbb{C}_0 \in \catname{Cat}$ freely into a semilattice-enriched category $\mathbb{C} \in \catname{SLat}\text{--}\catname{Cat}$ by making every Hom set of $\mathbb{C}_0$ into the free semilattice on that set along $F$.
Being a 2-functor, it preserves dualities (in the 2-categorical sense): it lifts an adjunction in between categories in $\catname{Cat}$ into an $\catname{SLat}$-adjunction between their free semilattice-enriched correspondants.
We take closure, in the sense of~\autoref{def:closed}, to be defined generally for $\catname{SLat}$-categories by an analogous $\catname{SLat}$-adjunction $- \otimes B \dashv B \multimap -$ for every object $B$.
Thus, applying the 2-functor $\mathcal{F}$ to $\catname{CS}(\Sigma)$ we get a closed symmetric monoidal $\catname{SLat}$-category $\catname{CS}(\Sigma)^{+}$ by this lifting.
We can similarly derive $\catname{SLat}$-enriched versions of  $\Lambda_{A,B,C}$ and $\textbf{ev}_{A,B}$ morphisms using the lifted adjunction as $\textbf{ev}_{A,B} = \varepsilon_{A}$ and $\Lambda_{A,B,C}(f) = \eta_A; (B \multimap{} f)$.
The following distributivity law can then be derived, forming the basis of encoding equivalences inside abstractions:
\begin{equation}
	\begin{aligned}
		\Lambda_{A,B,C}(f + g) & = \eta_A;(B \multimap (f + g))                    \\
		                       & = \eta_A;(B \multimap f + B \multimap g)          \\
		                       & = \eta_A;(B \multimap f) + \eta_A;(B \multimap g) \\
		                       & = \Lambda_{A,B,C}(f) + \Lambda_{A,B,C}(g).
	\end{aligned}%
	\label{law:distributivity}
\end{equation}

Similar to $\catname{CS}(\Sigma)$, $\catname{CS}(\Sigma)^{+}$ can be freely generated from a set of closed $\Sigma^{+}$-terms as follows.
Every closed $\Sigma$-term is also a $\Sigma^{+}$-term.
Given two closed $\Sigma^{+}$-terms $f\colon A \to B$ and $g\colon A \to B$, $f + g\colon A \to B$ is also a closed $\Sigma^{+}$-term.
Terms of $\catname{CS}(\Sigma)^{+}$ are quotiented by the laws of closed symmetric monoidal $\catname{SLat}$-categories, including the distributivity law (\autoref{law:distributivity}).
The same applies in the presence of equations for $\catname{CS}(\Sigma,\mathcal{E})^{+}$.

To aid reasoning, we introduce a new language of string diagrams for closed symmetric monoidal $\catname{SLat}$-categories, using a hierarchical \enquote{dashed box} structure to capture the join operation on morphisms (as was done by~\citet{tiurin2025equivalencehypergraphsdporewriting}) as well as another hierarchical \enquote{rounded box} for $\lambda$-abstraction.
\autoref{fig:egraph-strings} displays the generators of this language, which is the usual string diagrammatic syntax~\cite{Selinger_2010} plus the syntax for $\lambda$-abstraction as established by~\citet{ghica2024stringdiagramslambdacalculifunctional} and syntax for semilattice enrichment as introduced by~\citet{tiurin2025equivalencehypergraphsdporewriting}; the first component denotes an empty diagram.

% rotated the diagrams
% Note the orientation of string diagrams are now from top to bottom as opposed to what was used in~\nameref{sec:introduction}: the latter was mimicking the orientation of e-graphs, \textit{i.e.}, traditional orientation for expression trees.

% \autoref{fig:string-equations} displays the additional equations which these diagrams satisfy, in addition to the standard equations of symmetric monoidal categories. 
% The first four equations are those displayed in\autoref{def:enriched-prop},  while the final four axiomatize $+$ as an \textit{n-ary} associative, commutative and idempotent operation.  We overload the binary notation $+$ for our $n$-ary notation.  
% We will later prove the intuitive fact that these diagrams are sound and complete with respect to their intended categorical semantics, noting that similar diagrammatic languages using boxes to express choice have been used before~\cite{duncan_generalised_2009}. 

% In~\cite{ghica2024stringdiagramslambdacalculifunctional} it was shown that e-graphs over some signature $\Sigma$ can be represented as morphisms of a semilattice-enriched free Cartesian symmetric monoidal category over the same signature.
% We argue that restricting the categorical domain to free semilattice-enriched closed symmetric monoidal categories gives rise to structures that naturally support binding and equivalence classes of morphisms.
% That is, morphisms (string diagrams) of such category can both encode variable binding and equivalence between subterms (sub-diagrams).
% We call these string diagrams, or more precisely, the combinatorial representation of that will follow, e-graphs with bindings.

\begin{figure*}
	\[
		\adjustbox{scale=0.65}{
			\tikzfig{./figures/egraph-strings-2}
		}
	\]
	\captionsetup{skip=0pt, belowskip=-2ex}
	\caption{String diagrams for closed symmetric monoidal $\catname{SLat}$-categories.}
	\label{fig:egraph-strings}
\end{figure*}

\subsection{Categorical foundations for slotted e-graphs}

Slotted e-graphs~\cite{slotted-egraphs} extend the traditional signature employed by e-graphs by an explicit construct for binding ($\text{bind}\; \$x\; tc$) and variables (\emph{slots}).
	Their syntax is generated by the following grammar:
	\begin{alignat*}{2}
		\text{(functional symbols)} &        &                            & \; f, g, \ldots ;                                                                       \\
		\text{(slots)}              &        &                            & \; \$x, \$y, \ldots ;                                                                   \\
		\text{(term children)}      &        & tc               \Coloneqq & \; t \mid tc_{1}, \ldots, tc_{n} \mid \text{bind}\; \$x\; tc \mid \$x ; \qquad n \geq 1 \\
		\text{(terms)}              & \qquad & t                \Coloneqq & \; f \mid f(tc) .
	\end{alignat*}
	The traditional congruence relation maintained be e-graphs for a set of equations $E$ are given below (plus the obvious rules for transitivity, symmetry and reflexivity of $\cong$):
	\begin{mathpar}
		\inferrule*[right=start]
		{a = b \in E}
		{E \vdash a \cong b}
		\quad
		\inferrule*[right=cong. (variadic)]
		{E \vdash tc_i \cong tc'_i,\; i = 1, \ldots, k}
		{E \vdash tc_1, \ldots, tc_k \cong tc'_1, \ldots, tc'_k}
		\quad
		\inferrule*[right=cong. (f)]
		{E \vdash tc \cong tc'}
		{E \vdash f(tc_1) \cong f(tc')}
	\end{mathpar}
	Slotted e-graphs extend these with the following:
	\begin{equation}%
		\label{eq:cong-bind}
		\inferrule*[right=cong. (bind)]
		{E \vdash tc \cong tc'}
		{E \vdash \text{bind}\; \$x\; tc \cong \text{bind}\; \$x\; tc'},
	\end{equation}
	plus the rules for equivalence of terms up to renaming of slots.
	The earlier work of~\citet{tiurin2025equivalencehypergraphsdporewriting} that introduced free semilattice enrichment to describe e-graphs using morphism terms used the join operation $+$ of a semilattice to denote the equivalence of morphism subterms.
	For example, the e-graph (b) from~\autoref{fig:e-graph-example} can be written as a term as
	\[(a \otimes ((2;\comonoid) \otimes (1;id));\sym);((* \otimes \counit + (id \otimes \counit \otimes id);<\!\!<) \otimes id);/~,\] where $+$ encodes the equivalence of the subterms rooted at $*$ and $<\!\!<$
	We can see that the first three rules (plus reflexivity, symmetry, and transitivity) above correspond to idempotence, commutativity and associativity of $+$ and the fact that $+$ respect the composition $(;)$.
	%  and tensoring $\otimes$ (traditional e-graphs do not have tensoring as they are defined for algebraic signatures).
	Moreover, we can also justify~\autoref{eq:cong-bind} from a purely categorical perspective, by the free enrichment as per~\autoref{law:distributivity}.
	We do not require the additional rules regarding renaming as string diagrams are essentially a nameless representation of terms.
	There is a distinction here though, as some renaming rules are not consistent with string diagrams: slotted e-graph try to represent, e.g., terms $(a + b)$ and $(c + d)$ as a single entity (up to renaming of free variables), which is not the case for string diagrams (unless we do closure conversion --- see~\autoref{fig:extended-egraphs}).

% The above distributivity law closely correspond to one of the congruences maintained by a slotted e-graph, namely

% \[
% \text{bind}\;s_1\; x \cong \text{bind}\;s_2\;y \;\; \text{if}\; x \cong_{\alpha} y
% \]
% The congruence intuitively says that if $x$ and $y$ are congruent (up to $\alpha$-equivalence), then the enclosing binders are also congruent.
% While this is a \textit{natural} congruence to define when constructing an e-graph with support for binders, in our framework it follows from the free enrichment by a purely categorical argument justifying that it is the \textit{right} congruence to define.
