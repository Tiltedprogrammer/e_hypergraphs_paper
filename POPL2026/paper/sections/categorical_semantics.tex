\section{Categorical semantics of E-Graphs with Bindings}
\label{sec:categorical}

This section introduces preliminaries on semilattice-enriched symmetric monoidal categories generated by monoidal theories, and the string diagram formalism used to represent them.
We also show a specific case of semilattice-enriched closed monoidal categories and how the closed structure interacts with the enrichment structure.

Given a category $\mathbb{C}$  with objects $A,B \in \mathbb{C}$ we denote by $\mathbb{C}(A,B)$ the corresponding hom-set.  
We write the identity morphism on $A$ as $\id_A$.  
We commonly write $f;g$ for composition in diagrammatic order.  
Composition in the usual order is written $g \circ f$.  
We denote the tensor product of an SMC $\mathbb{C}$ by $\otimes$,  its unit by $I$, and its symmetry natural transformation as $\sym$ \cite{maclane}.  
We adopt the convention that $\otimes$ binds more tightly than $(;\!)$.  
We elide all associativity and unit isomorphisms associated with monoidal categories,  and often omit subscripts on identities and natural transformations where it can be inferred.
Given two adjoint functors $F : \mathbb{A} \to \mathbb{B}$ and $G : \mathbb{B} \to \mathbb{A}$ with $F$ being left-adjoint, we write $F \dashv G : \mathbb{B} \to \mathbb{A}$ for this adjunction.


First, recall some basic definitions.
\begin{definition}
A \textit{monoidal} \textit{signature} $\Sigma = (\Sigma_{O}, \Sigma_{M}, t)$ is given by a set of objects (called types) $\Sigma_{O}$, a set of generators (operations) $\Sigma_{M}$ and a type assignment function $t : \Sigma_{M} \to \Sigma_{O}^{*} \times \Sigma_{O}^{*}$ assigning lists of input and output types to a given operation.
\end{definition}

\begin{definition}
A set of $\Sigma$-terms generated by monoidal signature $\Sigma$ is given by the following grammar:
\[
\tau \coloneqq \phi \;|\; \id_{I} \;|\; \id_{A} \;|\; \sym_{A,B} \;|\; \tau_{1};\tau_{2} \;|\; \tau_{1} \otimes \tau_{2},
\]
where $\phi$ ranges over the set of operators $\Sigma_{M}$ and $A,B$ range over the set of objects $\Sigma_{O}$.
\end{definition}

Identities and symmetries of complex types, \textit{e.g.}, $\id_{A \otimes B}$ and $\sym_{A \otimes B, C}$, are given by the composition and tensoring of $\id_{A}$ and $\sym_{A,B}$ as, $\textit{e.g.}$, $\id_{A \otimes B} = \id_{A} \otimes \id_{B}$ and $\sym_{A \otimes B, C} = (\id_{A} \otimes \sym_{B,C});(\sym_{A,C} \otimes \id_{B})$.

\begin{definition}
A free symmetric monoidal category $\catname{S}(\Sigma)$ is given by a set of $\Sigma$-terms quotiented by the axioms of a symmetric monoidal category.
The objects are lists of types from $\Sigma_{O}$ with tensoring given by list concatenation.
\end{definition}

\begin{definition}
A symmetric monoidal theory $\catname{SMT}(\Sigma, \mathcal{E})$ is given by a set of $\Sigma$-terms quotiented by a set of equations $\mathcal{E}$ consisting of pairs of appropriately typed $\Sigma$ terms $l = r$.
\end{definition}

\begin{definition}
A categorical presentation of  $\catname{SMT}(\Sigma, \mathcal{E})$ is a free symmetric monoidal category $\catname{S}(\Sigma, \mathcal{E})$ given by a set of $\Sigma$ terms quotiented by the laws of a symmetric monoidal category and equations of $\mathcal{E}$.
\end{definition}

We can similarly consider \textit{closed} terms that give rise to a free \textit{closed} symmetric monoidal category.

\begin{definition}
\label{def:closed}
A monoidal (right) closed category is a monoidal category $\catname{C}$ satisfying that for
every pair of objects $B,C$ there is an object $B \multimap C$ and a morphism $\textbf{ev}_{B,C} : (B \multimap C) \otimes B \to
C$, and for every triple of objects $A,B,C$ there is an operation $\Lambda_{A,B,C} : \catname{C}(A \otimes B,C) \to
\catname{C}(A,B \multimap{} C)$ such that for all $f : A \otimes B \to C$ and $g : Z \to A$ the following equations hold:
\begin{itemize}
\item $f = \Lambda_{A,B,C}(f) \otimes \id_{B}; \textbf{ev}_{B,C}$
\item $\id_{B \multimap{} C} = \Lambda_{B \multimap{} C,B,C}(\textbf{ev}_{B,C})$
\item $\Lambda_{Z,B,C}(g \otimes \id_{B}; f) = g;\Lambda_{A,B,C}(f)$
\end{itemize}
\end{definition}

This definition is equivalent to defining a (right) closed category through a pair of adjoint functors $- \otimes B$ and $B \multimap{} -$.
If the tensor is symmetric, then the category is said to be simply \textit{closed}.

\begin{definition}
\textit{Closed} $\Sigma$-terms are defined inductively by first defining a family of objects $obj_{\Sigma_{O}}$.
\begin{itemize}
\item A designated $I$ is in $obj_{\Sigma_{O}}$.
\item If $A \in obj_{\Sigma_{O}}$ and $B \in obj_{\Sigma_{O}}$, then $A \otimes B \in obj_{\Sigma_{O}}$ and $A \multimap B \in obj_{\Sigma_{O}}$.
\end{itemize}
A family of closed $\Sigma$ terms is then defined as
\begin{itemize}
    \item $\phi : A \to B \in \Sigma_{M}$ is a closed $\Sigma$-term.
    \item If $A$ and $B$ are $obj_{\Sigma_{O}}$, then $\id_{A}$ and $\sym_{A,B}$ are closed $\Sigma$-terms.
    \item If $f : A \to B$ and $g : B \to C$ are closed $\Sigma$-terms, then so is $f;g : A \to C$. 
    \item If $f : A \to B$ and $g : C \to D$ are closed $\Sigma$-terms, then so is $f \otimes g : A \otimes C \to B \otimes D$.
    \item If $A$ and $B$ are $obj_{\Sigma_{O}}$, then $\textbf{ev}_{A,B} : A \multimap B \otimes A \to B$ is a closed $\Sigma$-term.
    \item If $h : X \otimes A \to B$ is a closed $\Sigma$-term, then $\Lambda_{X,A,B}(h) : X \to (A \multimap B)$ is a closed $\Sigma$-term.
\end{itemize}
\end{definition}

\begin{definition}
The free closed symmetric monoidal category $\catname{CS}(\Sigma)$ is given by a set of closed $\Sigma$-terms quotiented by the laws of a symmetric monoidal category and the equations from Definition~\ref{def:closed}.
We can similarly consider a free closed symmetric monoidal category that is induced by an $\catname{SMT}(\Sigma, \mathcal{E})$ over closed $\Sigma$-terms which we will denote with $\catname{CS}(\Sigma, \mathcal{E})$.
\end{definition}

To encode equivalences between morphisms (or $\Sigma$-terms), the hom-sets of the corresponding free categories can be endowed with the additional structure of a semilattice induced by an idempotent, commutative and associative operator \textit{join} $+$ as presented in~\cite{ghica2024equivalencehypergraphsegraphsmonoidal}.
This endowment turns such categories into $\catname{SLat}$-enriched categories where $\catname{SLat}$ is a category of \textit{unbounded} semilattices and homomorphisms between them (see Appendix~\ref{sec:appendix:slat}).

\begin{definition}[Semilattice-enriched category~\cite{Borceux_1994}]
\label{def:slat-cat}
    A semilattice-enriched category $\mathbb{C}$ is defined by the following data:
    \begin{itemize}
        \item a set of objects $\mathbb{C}$
        \item for every pair of objects $A,B \in \mathbb{C}$ --- a hom-object (or, hom-semilattice) $\mathbb{C}(A,B) \in \catname{SLat}$
        \item for every triple of objects $A,B,C \in \mathbb{C}$ --- a composition morphism 
        $\circ: \mathbb{C}(B,C) \otimes \mathbb{C}(A,B) \to \mathbb{C}(A,C)$
        \item for every object $A \in C$ --- a unit morphism 
        $u_{A} : I \to \mathbb{C}(A,A)$, where $I$ is the monoidal unit for $\catname{SLat}$.
    \end{itemize}
    such that particular coherence diagrams commute.
\end{definition}
As the composition is a semilattice homomorphism (morphism of $\catname{SLat}$), we require that 
$
(f + g); h = f;h + g;h$ and $f;(g+h) = f;g + f;h
$.

\begin{definition}[$\catname{SLat}$-functor]
	Let $\mathbb{C}$ and $\mathbb{D}$ be two $\catname{SLat}$-categories.
	An $\catname{SLat}$-functor $F : \mathbb{C} \to \mathbb{D}$ is defined by the following data.
	\begin{itemize}
	  \item A mapping $F : \mathbb{C} \to \mathbb{D}$
	  \item An object-indexed family of morphisms in $\catname{SLat}$ $F_{A,B} : \mathbb{C}(A,B) \to \mathbb{D}(FA,FB)$
	\end{itemize}
	such that certain coherence diagrams commute~\cite{Borceux_1994}.
	$F$ being a morphism in $\catname{SLat}$ has a property $F(f + g) = F(f) + F(g)$.
\end{definition}


\begin{definition}[Semilattice-enriched SMC~\cite{enriched_monoidal}]\label{def:enriched-prop}
    A \textit{semilattice enriched strict SMC}  $\mathbb{C}$ is given by a semilattice-enriched category $\mathbb{C}$ as above that additionally has
    \begin{itemize}
    \item a unit object $I_{C} \in \mathbb{C}$
    \item for every pair of objects $A,B \in \mathbb{C}$ --- an object $A \otimes B \in \mathbb{C}$
    \item for all $A,B,C,D$ --- a tensor morphism $ - \otimes_{C} - : \mathbb{C}(A,C) \otimes \mathbb{C}(B,D) \to \mathbb{C}(A \otimes B, C \otimes D)$
    \end{itemize}
    such that particular coherence diagrams commute.
    \end{definition}
    The latter morphism being in $\catname{SLat}$ implies that for $\otimes$ we have 
    $
    f \otimes (g+h) = f \otimes g + f \otimes h $ and $ (f+g) \otimes h = f \otimes h + g \otimes h
    $.
    As before, we take $\otimes$ to bind more tightly than $+$.

    Then, the axioms of $\catname{SLat}$-SMC consist of equations in Definitions~\ref{def:enriched-prop}~\ref{def:slat-cat} and associativity, commutativity, and idempotence equations for $+$.
    
    \begin{proposition}(A specialised case of Proposition 6.4.7~\cite{Borceux_1994})
        There is a 2-adjunction 
        % https://q.uiver.app/#q=WzAsMixbMCwwLCJcXGNhdG5hbWV7U0xhdHR9LVxcY2F0bmFtZXtDYXR9Il0sWzIsMCwiXFxjYXRuYW1le0NhdH0iXSxbMSwwLCJGIiwyLHsiY3VydmUiOjR9XSxbMCwxLCJHIiwyLHsiY3VydmUiOjR9XSxbMiwzLCIiLDAseyJsZXZlbCI6MSwic3R5bGUiOnsibmFtZSI6ImFkanVuY3Rpb24ifX1dXQ==
        % \[\begin{tikzcd}
        % 	\catname{SLatt}\text{--}\catname{Cat}\arrow[rr, "\mathcal{U}", bend left] & \hspace{-1em}\top & \catname{Cat} \arrow[ll, "\mathcal{F}", bend left]
        % 	\end{tikzcd}
        % \]
        \vspace{-1mm}
        \[
        \mathcal{F} \dashv \mathcal{U} : \catname{SLat}\text{--}\catname{Cat} \to \catname{Cat}
        \vspace{-1mm}
        \]
        that is induced by the usual free-forgetful adjunction 
        
        % \[\begin{tikzcd}
        % 	\catname{SLatt} \arrow[rr, "U", bend left] & \top & \catname{Set} \arrow[ll, "F", bend left]
        % 	\end{tikzcd}
        % \]
        \vspace{-1mm}
        \[
        F \dashv U : \catname{SLat} \to \catname{Set}
        \vspace{-1mm}
        \]        
    \end{proposition}
In particular, 2-functor $\mathcal{F}$ turns every category $\mathbb{C'} \in \catname{Cat}$ into a free semilattice enriched $\mathbb{C} \in \catname{SLat}\text{--}\catname{Cat}$ by making every hom-set of $\mathbb{C'}$ into a free semilattice on this set.
Being a 2-functor, it also lifts an adjunction in $\catname{Cat}$ $F \dashv G$ into an $\catname{Slat}$-adjunction.
Thus, applying the functor to $\catname{CS}(\Sigma)$ we get a closed symmetric monoidal $\catname{Slat}$-category $\catname{CS}(\Sigma)^{+}$ by lifting the adjunction $(- \otimes B, B \multimap{} -, \eta, \varepsilon)$.
We can similarly derive $\catname{SLat}$-enriched versions of  $\Lambda_{A,B,C}$ and $\textbf{ev}_{A,B}$ morphisms using the lifted adjunction as $\textbf{ev}_{A,B} = \varepsilon_{A}$ and $\Lambda_{A,B,C}(f) = \eta; (B \multimap{} f)$.
The following distributivity law can then be derived, forming the basis of encoding equivalences inside abstractions.
\begin{equation}
\begin{aligned}
\Lambda_{A,B,C}(f + g) &= \eta;(B \multimap (f + g))\\
                       &= \eta;(B \multimap (f) + B \multimap (g))\\
                       &= \eta;(B \multimap (f)) + \eta;(B \multimap (g))\\
                       &= \Lambda_{A,B,C}(f) + \Lambda_{A,B,C}(g)
\end{aligned}
\end{equation}
\label{law:distributivity}

\begin{remark}

The above distributivity law closely correspond to one of the congruences maintained by a slotted e-graph, namely

\[
\text{bind}\;s_1\; x \cong \text{bind}\;s_2\;y \;\; \text{if}\; x \cong_{\alpha} y
\]
The congruence intuitively says that if $x$ and $y$ are congruent (up to $\alpha$-equivalence), then the enclosing binders are also congruent.
While this is a \textit{natural} congruence to define when constructing an e-graph with support for binders, in our framework it follows from the free enrichment by a purely categorical argument justifying that it is the \textit{right} congruence to define.
\end{remark}

Similar to $\catname{CS}(\Sigma)$, $\catname{CS}(\Sigma)^{+}$ can be freely generated from a set of closed $\Sigma^{+}$-terms, the latter being defined as follows.
Every closed $\Sigma$-term is also a $\Sigma^{+}$-term. 
Given two closed $\Sigma^{+}$-terms $f : A \to B$ and $g : A \to B$, $f + g : A \to B$ is also a closed $\Sigma^{+}$-term.
Terms of $\catname{CS}(\Sigma)^{+}$ are quotiented by the laws of closed $\catname{SLat}$-SMC, including the distributivity law~\ref{law:distributivity}.


To aid reasoning, we introduce a new language of string diagrams for closed $\catname{SLat}$-SMCs, using a hierarchical ``box'' structure to capture the join operation on morphisms as well as another hierarchical ``box'' for lambda abstraction.
It was already discussed in the introduction how this is  used in the translation of equivalence classes from the e-graph to the string diagrammatic setting and in interpreting $\lambda$-terms.
Fig. \ref{fig:egraph-strings} displays the generators of this language which is the usual string diagrammatic syntax~\cite{Selinger_2010} plus the syntax for lambda abstraction as established in~\cite{ghica2024stringdiagramslambdacalculifunctional} and syntax for semilattice-enrichment as introduced in~\cite{ghica2024equivalencehypergraphsegraphsmonoidal}; the first component denotes an empty diagram.
Note the orientation of string diagrams are now from top to bottom as opposed to what was used in~\nameref{sec:introduction}: the latter was mimicking the orientation of e-graphs, \textit{i.e.}, traditional orientation for expression trees.
% Fig. \ref{fig:string-equations} displays the additional equations which these diagrams satisfy, in addition to the standard SMC equations. 
% The first four equations are those displayed in Definition \ref{def:enriched-prop},  while the final four axiomatize $+$ as an \textit{n-ary} associative, commutative and idempotent operation.  We overload the binary notation $+$ for our $n$-ary notation.  
% We will later prove the intuitive fact that these diagrams are sound and complete with respect to their intended categorical semantics, noting that similar diagrammatic languages using boxes to express choice have been used before~\cite{duncan_generalised_2009}. 

% In~\cite{ghica2024stringdiagramslambdacalculifunctional} it was shown that e-graphs over some signature $\Sigma$ can be represented as morphisms of a semilattice-enriched free Cartesian symmetric monoidal category over the same signature.
% We argue that restricting the categorical domain to free semilattice-enriched closed symmetric monoidal categories gives rise to structures that naturally support binding and equivalence classes of morphisms.
% That is, morphisms (string diagrams) of such category can both encode variable binding and equivalence between subterms (sub-diagrams).
% We call these string diagrams, or more precisely, the combinatorial representation of that will follow, e-graphs with bindings.

\begin{figure*}
\[
\adjustbox{scale=0.65}{
\tikzfig{./figures/egraph-strings}
}
\]
\captionsetup{skip=0pt, belowskip=-2ex}
\caption{String diagrams for closed semilattice-enriched symmetric monoidal categories.}
\label{fig:egraph-strings}
\end{figure*}