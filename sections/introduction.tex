% !TEX root = ../main.tex

\newcommand\mylet[2]{\textsf{let } #1 = #2 \textsf{ in }}





\section{Introduction}

Rewrite-driven program optimization consists of applying a sequence of semantics-preserving rewrites which may improve speed of execution, resource usage, \textit{etc}. Because early application of some rewrites can enable or block the subsequent application of others, the choice of application order hugely impacts the quality of the resulting optimization.  This long-standing issue is known as the \textit{phase-ordering problem}, with a \textit{phase} referring to a particular set of rewrites, for example,  those implementing constant propogation, loop unfolding, or unreachable code elimination. Typical approaches to this problem use heuristics to make an ad-hoc choice of ordering. 

A recently proposed,  alternative solution to this problem is \textit{equality saturation} 
\cite{10.1145/1594834.1480915}: instead of maintaining a \textit{single},  putatively optimized program which is rewritten \textit{destructively} at each step, we can maintain a \textit{set} of equivalent programs, where each rewrite step \textit{non-destructively} grows the set.  Upon reaching a fixed point ({saturation}),  a \textit{globally} optimal program can then be extracted.% from the set,  which now represents all equivalent ways to express the program with respect to the given rewrites.  
The use of \textit{equality graphs (e-graphs)} \cite{EggPaper} -- a generalization of the typical directed acylcic graph (DAG) representation of terms to include equivalence classes -- to compactly represent the set of equivalent programs is what makes the technique tractable in practise, where the naive approach is clearly unfeasible. 

While equality saturation is a state-of-the-art optimization technique, the formal mathematical theory of e-graphs is perhaps underdeveloped. In this paper, we contribute a categorical understanding of e-graphs and their rewriting. Considering programs as represented by terms of an arbitrary algebraic theory, we demonstrate a correspondence between e-graphs and (string diagrams for) simple \textit{semilattice-enriched} Cartesian categories, where the semilattice \textit{join} allows us to consider formal sets of terms (string diagrams, morphisms). 

However, we do not develop the categorical perspective purely for its own sake: rephrasing the formalism of e-graphs in terms of algebraic theories and Cartesian categories suggests a natural generalization to monoidal theories. Therefore, our theoretical development leads to new potential domains of application, including optimziation of string diagrams representing digital \cite{ghica_compositional_2023} and quantum circuits
\cite{coecke_interacting_2011,ZX} and potentially to computational linguistics \cite{wazni_quantum_2022,coecke_lambek_2013}.  We also suggest how our approach will allow future  generalization to include rewriting for the $\lambda$-calculus,  in a novel approach \textit{cf.} \textit{e.g.,}
\cite{koehler2022sketchguided}. % latest egraph. 

With consideration of future implementations, we 
additionally provide a combinatorial representation of our enriched string diagrams in terms of (hierarchical)  hypergraphs, which we call \textit{e-hypergraphs}.  We give a specification of e-hypergraph rewriting via a suitable extension of the double pushout (DPO) rewriting framework 
\cite{dpo, bonchi_string_2022-1,bonchi_string_2022-2,bonchi_string_2022}, and prove the representation sound and complete with respect to our categorical semantics.  As a corollary, we also formalize the rewriting theory of standard e-graphs in this way.  %Finally, we touch on the question of efficient implementation of rewriting for e-hypergraphs. 

\subsection{E-graphs}

\begin{figure}\label{fig:egraph-strings}
\[
    \tikzfig{categorical-semantics/egraph-strings}
\]
\caption{String diagrams for semilattice enriched symmetric monoidal categories.}
\end{figure}

\begin{figure}\label{fig:e-graph-example}
\[
    \scalebox{0.5}{
    \tikzfig{categorical-semantics/egraph-translation}
    }
\]
\caption{Example translation of e-graphs into string diagrams for semilattice enriched (traced) Cartesian categories.}
\end{figure}

\begin{figure}\label{fig:let-calculus}
\begin{align*}
    (a*2)/2 \\
    \mylet{y}{a*2} y/2 \\ 
    \mylet{y}{\{a*2,a<\!\!<1\}} y/2 \\
    \mylet{y}{\{a*2,a<\!\!<1\}} \{y/2, a*(2/2)\} \\
    \mylet{x}{\{2/2, 1\}} \mylet{y}{\{a*2, a <\!\!< 1\}} \{y/2, a*x\} \\
    \textsf{letrec } z = (\mylet{x}{\{2/2, 1\}} \mylet{y}{\{z*2, z <\!\!< 1\}} \{a, y/2, z*x\}) \textsf{ in } z
\end{align*}
\caption{Example term calculus corresponding to the string diagrams of Figure \ref{fig:e-graph-example}}
\end{figure}

E-graphs are a data structure which can efficiently represent many equivalent terms of an algebraic theory.  They generalize the typical DAG representation of terms to include equivalence classes. 
A sequence of examples, taken from \cite{EggPaper}, are given in the first row of Figure \ref{fig:e-graph-example}. Here,  nodes (solid boxes) have children given by equivalence classes (dashed boxes) of nodes instead of just a single node.  Note, the equivalence classes relate nodes whose corresponding \textit{sub-trees} denote equivalent terms. 

Beginning with the e-graph (a), corresponding to the DAG representation of the term $(a*2)/2$, each subsequent e-graph (b)-(e) uses the given rewrite rule to add information: creating new nodes and edges, or merging equivalence classes. The final e-graph, (e), contains a cycle, and represents infinitely many terms: $a, a*1, (a*1)*1, $... 

\subsection{Semantics via Semilattice Enriched Categories}

Recalling the correspondence between DAG representations of algebraic terms and the corresponding string diagrammatic representation of morphisms of a suitable Cartesian category, 
one can easily see the correspondence between (acyclic) e-graphs and morphisms of a suitably enriched Cartesian category by considering string diagrams 
\cite{noauthor_09083347_nodate,joyal_geometry_1991, mellies_functorial_2006}. In Figure \ref{fig:egraph-strings} we have extended the usual string diagrammatic notation for symmetric monoidal categories with an additional generator which has the  typing rule below, left, corresponding to taking formal sums of morphisms.
The ability to take formal sums is used to model the equivalence class structure of e-graphs.  
\[
\infer{\phi_1 + \ldots + \phi_n: A \to B}{\{\phi_i: A \to B\}_{i \in \{1,\ldots,n\}}}
\qquad
\infer{\Gamma \vdash \{t_1, \ldots, t_n\}: A}{\{\Gamma \vdash t_i: A\}_{i \in \{1, \ldots, n\}}}
\]
To aid understanding, in Figure \ref{fig:let-calculus} we give an example of a representation of the string diagrams in Figure \ref{fig:e-graph-example} using an informal let-calculus, which is standard except for its augmentation with the typing rule above, right, corresponding to semilattice enrichment. The new construct forms a set of terms and satisfies the following additional congruence: $K\{\{t_1, \ldots, t_n\}\} = \{K\{t_1\}, \ldots, K\{t_n\}\}$. 

String diagrams are read from bottom-to-top and we consider additional generators for the duplication and deletion transformations of a Cartesian category.  Note, further, that in the Cartesian case we can restrict to generators $c$ with a single output. 

The translation from e-graphs to our enriched string diagrams is illustrated informally below. 
Note how the typing constraints of the $+$ constructor are satisfied in the image of the translation by discarding in each component unnecessary inputs.
\[
    \tikzfig{categorical-semantics/egraph-translation-1}
\]

Examples of this translation are given in the second row of Figure \ref{fig:e-graph-example}. In particular, note that the translation of the \textit{cyclic} e-graph (e)
requires the use of a categorical \textit{trace}, generating a cycle. In this paper, we focus on \textit{acyclic} e-graphs and their corresponding catgeories; but the above example illustrates that the extension to the cyclic case appears routine.

Note how the natural level of generality for our string diagrams is not Cartesian, but monoidal: the generators of a Cartesian category are required in order to embed e-graphs, but are orthogonal to the addition of formal sums. Thus we generalize e-graphs from algebraic to monoidal theories, giving rise to a  host of new potential applications, which we outline in the conclusion of this paper.   

\subsection{Combinatorial Representation of Enriched String Diagrams}

In order to \textit{implement} our generalized version of e-graphs, we will  perform rewriting not on terms representing morphisms of a category, but on combinatorial representations of the corresponding string diagrams.  String diagrams can be considered equivalently as either topological objects (\textit{i.e.}, taken modulo "connectivity") or as a 2-dimensional syntax quotiented by the equations of an SMC. For example, we have the following equivalences between diagrams. 
%\[(f_1 \otimes f_2) ; (g_1 \otimes g_2) = (f_1 ; g_1) \otimes (f_2 ; g_2)\] 
\[
	\tikzfig{categorical-semantics/interchange}
\]

Unfortunately, this makes string diagrams relatively unamenable to efficient implementation as a data structure, due to the difficulty of calculating the quotient. 
Nevertheless, there is a body of work dealing with this issue by representing string diagrams as combinatorial objects -- namely, (appropriately generalized) hypergraphs 
\cite{bonchi_string_2022-1,bonchi_string_2022-2,bonchi_string_2022}.  Here, the generators $c_i$ become vertices which are connected via hyper-edges.  Thus the expected quotient becomes simply hypergraph isomorphism.  With appropriate restrictions on the form these hypergraphs can take, this approach can be used to \textit{characterize} the free symmetric monoidal category generated by some $c_i$. 

We are interested in not just the free SMC over a set of generators, but rather in \textit{(symmetric) monoidal theories} which involve considering extra equations between morphisms: for instance, the rewrite rules $(a)-(e)$ of Figure \ref{fig:e-graph-example}. These can be seen as equations between string diagrams, and thus between their hypergraph representations.  Because the generating equations can be applied in any context, we are lead to the notion of \textit{(hyper)graph rewriting}: given an equation $l=r$, we require some way to identify (a sub-hypergraph corresponding to) $l$ in any hypergraph $G$ and replace it with (a sub-hypergraph corresponding to) $r$.
We make use of the standard approach to giving specifications of such graph rewriting, known as \textit{double pushout (DPO) rewriting}.

Our application requires a generalization of these concepts from hypergraphs to \textit{e-hypergraphs}, which we define as a hypergraph with two additional relations denoting the hierarchical structure introduced by \textit{e-boxes} (\textit{i.e.,} the generator for semilattice enrichment) and the separation of the components of each e-box.
Giving the appropriate definitions is slightly delicate matter, and constitutes the main body of the paper. 

\subsection{Soundness and Completeness}
The main technical result of the paper is a proof soundness and completeness of the combinatorial representation for semilattice enriched SMCs, extending the results of \cite{bonchi_string_2022-2} for plain SMCs. While the structural equalities of SMCs are factored out in the representation,  important structural equalities arising from the enrichment (see the equations of Figure \ref{fig:string-equations}) are not, and should not be: they represent the un/sharing of subdiagrams with respect to the e-box structure,  which is precisely what allows for the compact representation of equivalence classes.  Instead, we consider DPO-rewrites implementing both the structural equalities for enrichment (which involve the e-box structure) and the equalities arising from the generating monoidal theory (which do not).  

Quotienting e-hypergraphs by the induced equivalence gives rise to a sound and complete model of semilattice enriched SMCs.  That is, we exhibit a translation functor $\llbracket-\rrbracket$ from the free semilattice enriched SMC over a symmetric monoidal theory to our (quotiented) category of e-hypergraphs such that 
morphisms $f = g$ if and only if there exists a sequence of DPO-rewrites (each induced by a structural equality or the monoidal theory) between their translations: $\llbracket f \rrbracket \rightsquigarrow_{DPO} \llbracket g \rrbracket$. 

%\subsection{E-matching and E-rewriting}
%
%Having defined e-hypergraphs and shown them to correctly model the rewriting of string diagrams for semilattice enriched SMCs, we note that the naive implementation of DPO-rewriting is inefficient: to find a redex within an e-hypergraph involves finding a structurally equivalent e-hypergraph which contains the redex as a subgraph. In general, this involves unsharing the e-box structure before a redex becomes available.  Thus, we define a notion of \textit{e-matching} for e-hypergraphs: that is, to find redexes working modulo the e-box structure. In particular, we wish to locate the smallest subgraph $G' \subseteq G$ "containing" (in an appropriate sense) the redex $L$. Given this,  \textit{e-rewriting} $L \to R$, intended to achieve equality saturation, is simple to define due to its non-destructive nature: we rewrite $G' \to G' + R$ in $G$.  
%\begin{figure}
%\[
%	\tikzfig{combinatorial_semantics/example-rewriting}
%\]
%\caption{Example application of e-rewriting for rewrite $(x*y)/z \to x*(y/z)$: find an appropriate minimal sub-e-hypergraph containing the redex $(x*y)/z$ and non-destructively add the reduct $x*(y/z)$.  REDO THIS}
%\end{figure}

\subsection{Related Work}

Although e-graphs were first developed in the 80's \cite{nelson1980techniques}, there has recently been an explosion of interest in them for the purpose of building program optimizers and synthesizers, especially due to recent work on the equality saturation technique \cite{10.1145/1594834.1480915, griggio_proceedings_2022, EggPaper,flatt_small_2022}.  This includes interest in various extensions of the e-graph formalism, for example to account for conditional rewriting \cite{singher2023colored},  to reason about rewriting for the $\lambda$-calculus \cite{koehler2022sketchguided},  and to combine techniques of e-graphs and database queries ("relational e-matching") \cite{zhang_relational_2022}.  We are hopeful that our novel perspective on e-graphs can be extended to give foundations to these investigations.  Some further avenues for investigation, including potential applications, are given in the conclusion of this paper. 

Our use of string diagrams is also central to the intuition behind our work.  The string diagrams we work with are left essentially as informal reasoning devices, however there exists a breadth of work on similar diagrammatic formalisms for similar classes of categories.  We mention here work on hierarchical string diagrams \cite{ghica_hierarchical_2023},  functorial boxes \cite{mellies_functorial_2006},  proof nets for compact closed categories with biproducts \cite{duncan_generalised_2009}, and recent work on tape diagrams for rig categories with biproducts \cite{bonchi_tape_nodate}. 


