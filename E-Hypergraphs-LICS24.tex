%%
%% This is file `sample-sigconf.tex',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% samples.dtx  (with options: `sigconf')
%%
%% IMPORTANT NOTICE:
%%
%% For the copyright see the source file.
%%
%% Any modified versions of this file must be renamed
%% with new filenames distinct from sample-sigconf.tex.
%%
%% For distribution of the original source see the terms
%% for copying and modification in the file samples.dtx.
%%
%% This generated file may be distributed as long as the
%% original source files, as listed above, are part of the
%% same distribution. (The sources need not necessarily be
%% in the same archive or directory.)
%%
%%
%% Commands for TeXCount
%TC:macro \cite [option:text,text]
%TC:macro \citep [option:text,text]
%TC:macro \citet [option:text,text]
%TC:envir table 0 1
%TC:envir table* 0 1
%TC:envir tabular [ignore] word
%TC:envir displaymath 0 word
%TC:envir math 0 word
%TC:envir comment 0 0
%%
%%
%% The first command in your LaTeX source must be the \documentclass
%% command.
%%
%% For submission and review of your manuscript please change the
%% command to \documentclass[manuscript, screen, review]{acmart}.
%%
%% When submitting camera ready or to TAPS, please change the command
%% to \documentclass[sigconf]{acmart} or whichever template is required
%% for your publication.
%%

\documentclass[sigconf]{acmart}


\usepackage{tikz}
\usepackage{tikz-network}
\usepackage{xspace}
\usepackage{xargs}
\usepackage[
  colorinlistoftodos,
  prependcaption,
  % disable,
]{todonotes}
\usepackage{fontenc}

%\usepackage{minted}

\usepackage{subcaption}

\usepackage{hyperref}


\input{preamble}
\input{macros}
\input{sample.tikzstyles}
\input{hypergraph.tikzstyles}
\input{hypergraph.tikzdefs}


\definecolor{applegreen}{rgb}{0.55, 0.71, 0.0}
\definecolor{americanrose}{rgb}{1.0, 0.01, 0.24}
\definecolor{atomictangerine}{rgb}{1.0, 0.6, 0.4}
\definecolor{azure}{rgb}{0.0, 0.5, 1.0}

% These are for comments
\newcommand\question[1]{{\color{azure}#1}}
\newcommand\update[1]{{\color{americanrose}#1}}

% \usepackage{mathtools,mathrsfs}
\usepackage{tikz-cd}
\usepackage{tikzit}
% to reduce tikz picture white space
\usepackage{adjustbox}

% for quotienting
% \usepackage{faktor}
\usepackage{xfrac} 

\usepackage{import}

% category names
%\newcommand{\MdaCospans}{{\catname{MACsp_{D}(Hyp_{\Sigma})}}}

\newcommand\HypI[1]{\textbf{HypI}(#1)}
\newcommand\MdaCospans{\textbf{MHypI}(\Sigma)}
\newcommand{\Ecospans}{{\catname{EHypI(\Sigma)}}}
\newcommand{\MdaEcospans}{{\catname{MEHypI(\Sigma)}}}
\newcommand{\WellTypedMdaEcospans}{{\catname{MEHypI(\Sigma)}}}
% conflict
\newcommand{\hashtag}{{\#}}
\newcommand{\consistency}{{\smile}}
% There is already a remark in the preamble, but it does
% not work for some reason
\newtheorem{remark}{Remark}

\makeatletter
\newsavebox{\@brx}
\newcommand{\llangle}[1][]{\savebox{\@brx}{\(\m@th{#1\langle}\)}%
  \mathopen{\copy\@brx\kern-0.5\wd\@brx\usebox{\@brx}}}
\newcommand{\rrangle}[1][]{\savebox{\@brx}{\(\m@th{#1\rangle}\)}%
  \mathclose{\copy\@brx\kern-0.5\wd\@brx\usebox{\@brx}}}
\makeatother


%%
%% \BibTeX command to typeset BibTeX logo in the docs
\AtBeginDocument{%
  \providecommand\BibTeX{{%
    Bib\TeX}}}

%% Rights management information.  This information is sent to you
%% when you complete the rights form.  These commands have SAMPLE
%% values in them; it is your responsibility as an author to replace
%% the commands and values with those provided to you when you
%% complete the rights form.
\setcopyright{acmlicensed}
\copyrightyear{2024}
\acmYear{2024}
\acmDOI{XXXXXXX.XXXXXXX}

%% These commands are for a PROCEEDINGS abstract or paper.
\acmConference[LICS '24]{Logic in Computer Science}{July 8--12,
  2024}{Tallinn, Estonia}
%%
%%  Uncomment \acmBooktitle if the title of the proceedings is different
%%  from ``Proceedings of ...''!
%%
%%\acmBooktitle{Woodstock '18: ACM Symposium on Neural Gaze Detection,
%%  June 03--05, 2018, Woodstock, NY}
\acmISBN{978-1-4503-XXXX-X/18/06}


%%
%% Submission ID.
%% Use this when submitting an article to a sponsored event. You'll
%% receive a unique submission ID from the organizers
%% of the event, and this ID should be used as the parameter to this command.
%%\acmSubmissionID{123-A56-BU3}

%%
%% For managing citations, it is recommended to use bibliography
%% files in BibTeX format.
%%
%% You can then either use BibTeX with the ACM-Reference-Format style,
%% or BibLaTeX with the acmnumeric or acmauthoryear sytles, that include
%% support for advanced citation of software artefact from the
%% biblatex-software package, also separately available on CTAN.
%%
%% Look at the sample-*-biblatex.tex files for templates showcasing
%% the biblatex styles.
%%

%%
%% The majority of ACM publications use numbered citations and
%% references.  The command \citestyle{authoryear} switches to the
%% "author year" style.
%%
%% If you are preparing content for an event
%% sponsored by ACM SIGGRAPH, you must use the "author year" style of
%% citations and references.
%% Uncommenting
%% the next command will enable that style.
%%\citestyle{acmauthoryear}

\begin{document}

\title{Equivalence Hypergraphs: E-Graphs for Monoidal Theories}

\author{Anonymous}
%\email{}
%\orcid{}
%\affiliation{
%  \institution{}
%  \streetaddress{}
%  \city{}
%  \state{}
%  \country{
%  \postcode{}
%}

%\renewcommand{\shortauthors}{}

\begin{abstract}
The technique of equipping graphs with an equivalence relation, called equality saturation, has recently proved both powerful and practical in program optimisation, particularly for SMT solvers. 
We give a categorical semantics to these structures, called \emph{e-graphs}, in terms of Cartesian categories enriched over a semilattice. 
We show how this semantics can be generalised to monoidal categories, which opens the door to new applications of e-graph techniques, from algebraic to monoidal theories.
Finally, we present a sound and complete combinatorial representation of morphisms in such a category, based on a generalisation of hypergraphs (\emph{e-hypergraphs}).
They have the usual advantage that many of their structural equations are absorbed into a general notion of isomorphism. 
\end{abstract}

%%
%% The code below is generated by the tool at http://dl.acm.org/ccs.cfm.
%% Please copy and paste the code instead of the example below.
%%

\begin{CCSXML}
<ccs2012>
   <concept>
       <concept_id>10003752.10010124.10010131.10010137</concept_id>
       <concept_desc>Theory of computation~Categorical semantics</concept_desc>
       <concept_significance>300</concept_significance>
       </concept>
   <concept>
       <concept_id>10003752.10003809.10010031</concept_id>
       <concept_desc>Theory of computation~Data structures design and analysis</concept_desc>
       <concept_significance>300</concept_significance>
       </concept>
   <concept>
       <concept_id>10002950.10003624.10003633.10003637</concept_id>
       <concept_desc>Mathematics of computing~Hypergraphs</concept_desc>
       <concept_significance>300</concept_significance>
       </concept>
   <concept>
       <concept_id>10003752.10003790.10003798</concept_id>
       <concept_desc>Theory of computation~Equational logic and rewriting</concept_desc>
       <concept_significance>300</concept_significance>
       </concept>
 </ccs2012>
\end{CCSXML}

\ccsdesc[300]{Theory of computation~Categorical semantics}
\ccsdesc[300]{Theory of computation~Data structures design and analysis}
\ccsdesc[300]{Mathematics of computing~Hypergraphs}
\ccsdesc[300]{Theory of computation~Equational logic and rewriting}

\keywords{e-graphs, categorical semantics, enriched category theory,  hypergraph rewriting,  DPO rewriting.}

%\received{20 February 2007}
%\received[revised]{12 March 2009}
%\received[accepted]{5 June 2009}

\newcommand\id{\textsf{id}}
\newcommand\sym{\textsf{sym}}

\maketitle

%-------------------- INTRODUCTION

\section{Introduction}


Rewrite-driven program optimisation consists of the application of a sequence of semantics-preserving rewrites which may improve the cost of execution, such as time or space (memory). 
Because the application of some rewrites can either enable or block the subsequent application of others, the choice of application order significantly impacts the quality of the resulting optimisation.  This long-standing issue is known as the \textit{phase-ordering problem}, with a \textit{phase} referring to a particular set of rewrites. Typical approaches to this problem use heuristics to determine an ordering. 

A recently proposed,  alternative solution is \textit{equality saturation} 
\cite{10.1145/1594834.1480915}: instead of maintaining a \textit{single},  putatively optimised program which is rewritten \textit{destructively} at each step, a \textit{set} of equivalent programs is maintained instead, whereas each rewrite step \textit{non-destructively} grows the set.  Upon reaching a fixed point (\textit{saturation}),  a \textit{globally} optimal program can then be extracted from this set.
A naive approach is clearly unfeasible, since the size of this set grows exponentially with the number of rewrites. 
However, \textit{equality graphs (e-graphs)} \cite{EggPaper} are a data structure that can represent this set compactly, thus making the set tractable in practical applications. 

Although equality saturation is already a state-of-the-art algorithmic optimisation technique, there is an opportunity to better understand its mathematical foundations. 
We propose to address this issue via a categorical axiomatisation for e-graphs and their rewriting. 
Considering programs as represented by terms of an arbitrary algebraic theory, we demonstrate a correspondence between e-graphs and (string diagrams for) simple \textit{semilattice-enriched} Cartesian categories. 
The approach we take is guided by the established methodology of creating a correspondence between string diagrams and graph rewriting, as encountered in a large body of research. 
The starting innovation of our approach is the semilattice-enrichment. 
The \textit{join} operator lifts the formalism so that it can now operate with (non-empty) \textit{sets} of terms (string diagrams, morphisms); the rest of the paper is about working out the mathematical implications of introducing this enrichment to string diagrams and their concrete combinatorial represetation. 

Although our primary interest is theoretical, we believe that phrasing e-graphs in the more general language of category theory will open the door to new potential domains of applications that now use string diagrams and which require the application of optimisation techniques \cite{Selinger_2010, Hasegawa-traced}. 
This may include areas as diverse as digital \cite{ghica_compositional_2023} and quantum circuits
\cite{coecke_interacting_2011,ZX}, functional programs~\cite{ghica_hierarchical_2023}, or computational linguistics \cite{wazni_quantum_2022,coecke_lambek_2013}.  
However, in this work we offer little to the e-graph practitioner, as we focus exclusively on foundational aspects, introducing no new applications or improved e-graph algorithmics. 

A final contribution of this work is giving a concrete combinatorial representation of enriched string diagrams in terms of (hierarchical)  hypergraphs, which we call \textit{e-hypergraphs}.  We also give a specification of e-hypergraph rewriting via a suitable extension of the double pushout (DPO) rewriting framework 
\cite{dpo, bonchi_string_2022-1,bonchi_string_2022-2,bonchi_string_2022},  proving the representation \textit{sound and complete} with respect to our categorical semantics.  As a corollary, this also provides a formalisation of the rewriting theory of e-graphs as encountered in the literature. 

\subsection{E-graphs}


\begin{figure*}
\[
	\hspace{1.3cm}
    \scalebox{0.65}{
    \tikzfig{categorical-semantics/egraph-translation}
    }
\]
\caption{Example translation of acyclic e-graphs into string diagrams for semilattice enriched Cartesian categories. }
\label{fig:e-graph-example}
\end{figure*}

E-graphs are a data structure which can efficiently represent many equivalent terms of an algebraic theory.  They generalise the typical DAG representation of terms to include equivalence classes. 
The key concepts of e-graphs can be intuitively grasped from some simple (but non-trivial) examples, as shown in Figure~\ref{fig:e-graph-example}.
This example is a `Hello world!' of e-graphs, presented first in~\cite{EggPaper}.

Each column represents a term (or term rewrite rule), the conventional e-graph representation, and the equivalent e-string diagram representation, an e-hypergraph. 
The initial term, $(a*2)/2$, is already represented efficiently in the e-graph by sharing the node 2.
The string diagram version is slightly different than conventional e-graphs by representing the sharing of the node 2 explicitly, using a sharing (contraction) node. 

Nodes are encapsulated in dashed boxes indicating equivalence classes of nodes, or, more generally, of subgraphs. 
Initially each equivalence class has a single node. 
The first rewrite rule, replacing multiplication by the more efficient \emph{shift-left} operator creates the first non-unitary equivalence class, which includes the multiplication ($*$) and shift-left ($<\!\!<$) operator nodes, with a new sharing, that of node $a$. 
This second e-graph illustrates the other difference, besides sharing, between conventional e-graphs and e-hypergraphs, namely the fact that in the former edges connect directly to nodes inside the equivalence class, whereas in the latter edges connect to the equivalence class itself. 
Explicit discarding (weakening) nodes indicate which of the class-level edges are connected to which nodes inside the class. 

The other steps, (c) to (e), represent further elaborations of the e-graph, or e-hypergraph, via the application of more rules. 
Note that in the final e-graph, (e), a cycle is introduced, making it the representation of infinitely many terms: $a, a*1, (a*1)*1, \ldots$. 
From the saturated graph the optimal term consisting of only the node $a$ can be then extracted, discarding everything else. 

\subsection{Semilattice Enriched Categories}

\begin{figure}
\[
	\scalebox{0.65}{
	\tikzfig{categorical-semantics/egraph-strings}
	}
\]
\caption{String diagrams for semilattice enriched symmetric monoidal categories.}
\end{figure}\label{fig:egraph-strings}
CHRIS: DONT USE PHI/PSI FOR DIAGRAMS, USE F,G 

Recalling the correspondence between DAG representations of algebraic terms and  string-diagrams for morphisms of a suitable Cartesian category
makes perspicuous the correspondence between (acyclic) e-graphs and morphisms of a suitably enriched Cartesian category, taken as string diagrams~\cite{Selinger_2010,joyal_geometry_1991, mellies_functorial_2006}. We extend the usual vocabulary of string diagrams for symmetric monoidal categories with the additional generator  
\[
\infer{\phi_1 + \ldots + \phi_n: A \to B}{\{\phi_i: A \to B\}_{i \in \{1,\ldots,n\}}}
\]
The ability to take formal (non-empty) joins of morphisms is used to model the equivalence class structure of e-graphs.  

String diagrams are read from bottom-to-top; we consider additional generators for the duplication and deletion transformations of a Cartesian category.  Note, further, that in the Cartesian case we can restrict to generating morphisms $c$ to have a single output,  without loss of generality,  by applying the universal properties of the Cartesian product.  This means the (informal) translation given below is fully general for acyclic e-graphs. 

The translation from e-graphs to enriched string diagrams is illustrated informally below,
noting how the typing constraints of the $+$ constructor are satisfied in the image of the translation by discarding in each component all unnecessary inputs.
\[
    \tikzfig{categorical-semantics/egraph-translation-1}
\]
Examples of this translation are given in the second row of Figure \ref{fig:e-graph-example}. In particular, note that the translation of the \textit{cyclic} e-graph (e)
requires the use of a categorical \textit{trace}, generating a cycle. In this paper, we focus on \textit{acyclic} e-graphs and their corresponding catgeories; but the above example illustrates that the extension to the cyclic case seems to be routine. As it would involve needless additional presentational complexity we leave it as further work. 

Note that the motivating example of our work, e-graphs, requires the Cartesian structure. 
However, we will see how all the core of the theory of e-hypergraph rewriting only requires the monoidal structure. 
Thus we can readily generalise e-graphs from algebraic to monoidal theories, giving rise to a  host of new potential applications, which we briefly outline in the conclusion of this paper.   

\subsection{Combinatorial Representation of Enriched String Diagrams}

In order to \textit{implement} generalised e-graphs, rewriting must be performed on concrete representations of the corresponding string diagrams.  String diagrams can be considered equivalently as either topological objects (\textit{i.e.}, taken modulo ``connectivity'') or as a 2-dimensional syntax quotiented by the equations of an SMC. For example, we have the following equivalences between diagrams. 
%\[(f_1 \otimes f_2) ; (g_1 \otimes g_2) = (f_1 ; g_1) \otimes (f_2 ; g_2)\] 
\[
	\scalebox{0.6}{
	\tikzfig{categorical-semantics/interchange}
	}
\]
This representation makes string diagrams unamenable to efficient implementation due to the difficulty of calculating the quotient. 
A large body of research work shows how this issue can be solved by taking a different approach, representing string diagrams as hypergraphs~\cite{bonchi_string_2022-1,bonchi_string_2022-2,bonchi_string_2022}.  Here, the generators $c_i$ become vertices, connected via hyper-edges.  Thus the expected quotient becomes simply hypergraph isomorphism. With appropriate restrictions on the form these hypergraphs can take, this approach can be used to \textit{characterise} the free symmetric monoidal category generated by some~$c_i$. 

We are interested not only in the free SMC over a set of generators, but also in \textit{(symmetric) monoidal theories} with extra equations such as, for instance, the rewrite rules (b)--(e) of Figure \ref{fig:e-graph-example}. These can be seen as equations between string diagrams, and thus rewrites of their hypergraph representations.  Because the generating equations can be applied in any context, we are lead to the notion of \textit{(hyper)graph rewriting}: given an equation $l=r$, we require some way to identify (a sub-hypergraph corresponding to) $l$ in any hypergraph $G$ and replace it with (a sub-hypergraph corresponding to) $r$.
The standard methodology to giving specifications of such graph rewriting, known as \textit{double pushout (DPO) rewriting} \cite{???} is still applicable.
However, these concepts must be now generalised from hypergraphs to \textit{e-hypergraphs}, hypergraphs with two additional relations denoting the hierarchical structure introduced by so-called \textit{e-boxes}: the generator for semilattice enrichment, and the separation of the components of each e-box.
Giving the appropriate definitions turns out to be a technical matter of some complexity, and constitutes the main body of the paper. 

\subsection{Soundness and Completeness}
The main technical result of the paper is a proof of soundness and completeness of the combinatorial representation for semilattice enriched SMCs, extending the results of \cite{bonchi_string_2022-2} for plain SMCs. While the structural equalities of SMCs are factored out in the representation,  important structural equalities arising from the enrichment (see the equations of Figure \ref{fig:string-equations}) are not, and should not be. They represent the un/sharing of subdiagrams with respect to the e-box structure,  which is precisely what allows for the compact representation of equivalence classes.  Instead, we consider DPO-rewrites implementing both the structural equalities for enrichment (which involve the e-box structure) and the equalities arising from the generating monoidal theory (which do not).  

Quotienting e-hypergraphs by the induced equivalence gives rise to a sound and complete model of semilattice enriched SMCs.  That is, we exhibit a translation functor $\llbracket-\rrbracket$ from the free semilattice enriched SMC over a symmetric monoidal theory to our (quotiented) category of e-hypergraphs such that 
morphisms $f = g$ if and only if there exists a sequence of DPO-rewrites (each induced by a structural equality or the monoidal theory) between their translations: $\llbracket f \rrbracket \rightsquigarrow_{DPO} \llbracket g \rrbracket$. 

DAN: THIS NEEDS EXPANDING. EXPLAINING IN PLAIN WORDS SOME OF THE THEORETICAL PROPERTIES OF E-GRAPHS AND THE CATEGORICAL STATEMENT. 

%\subsection{E-matching and E-rewriting}
%
%Having defined e-hypergraphs and shown them to correctly model the rewriting of string diagrams for semilattice enriched SMCs, we note that the naive implementation of DPO-rewriting is inefficient: to find a redex within an e-hypergraph involves finding a structurally equivalent e-hypergraph which contains the redex as a subgraph. In general, this involves unsharing the e-box structure before a redex becomes available.  Thus, we define a notion of \textit{e-matching} for e-hypergraphs: that is, to find redexes working modulo the e-box structure. In particular, we wish to locate the smallest subgraph $G' \subseteq G$ "containing" (in an appropriate sense) the redex $L$. Given this,  \textit{e-rewriting} $L \to R$, intended to achieve equality saturation, is simple to define due to its non-destructive nature: we rewrite $G' \to G' + R$ in $G$.  
%\begin{figure}
%\[
%	\tikzfig{combinatorial_semantics/example-rewriting}
%\]
%\caption{Example application of e-rewriting for rewrite $(x*y)/z \to x*(y/z)$: find an appropriate minimal sub-e-hypergraph containing the redex $(x*y)/z$ and non-destructively add the reduct $x*(y/z)$.  REDO THIS}
%\end{figure}

\subsection{Related Work}

Although e-graphs were first developed in the 80's \cite{nelson1980techniques}, there has recently been an explosion of interest in them for the purpose of building program optimisers and synthesisers, especially due to recent work on the equality saturation technique \cite{10.1145/1594834.1480915, griggio_proceedings_2022, EggPaper,flatt_small_2022}.  This includes interest in various extensions of the e-graph formalism, for example to account for conditional rewriting \cite{singher2023colored},  to reason about rewriting for the $\lambda$-calculus \cite{koehler2022sketchguided},  and to combine techniques of e-graphs and database queries (``relational e-matching'') \cite{zhang_relational_2022}.  We are hopeful that our novel perspective on e-graphs can be extended to give uniform foundations to these investigations.  Some further avenues for investigation, including potential applications, are given in the conclusion of this paper. 

Our use of string diagrams is also central to the intuition behind our work.  There is a breadth of work on similar string diagrammatic formalisms,  including hierarchical string diagrams \cite{ghica_hierarchical_2023} and functorial boxes \cite{mellies_functorial_2006},  proof nets for compact closed categories with biproducts \cite{duncan_generalised_2009}, and recent work on tape diagrams for rig categories with biproducts \cite{bonchi_tape_nodate}. 

CHRIS: CITE HASEGAWA - TRACE MONOIDAL CATEGORIES, AND PERDIX. 
Hierarchical (hyper-)graphs are a well-studied area of research \cite{plump:hierarchical-graphs, montanari:gs-lambda, palacz:hierarchical-transform, Gaducci:hierarchical-graphs, Ghica:hierarchical}. 
DAN: THIS NEEDS TO BE CAREFULLY EXPANDED TO NOT OFFEND POTENTIAL REVIEWERS. 

\section{Categorical Semantics of E-Graphs}
In this section,  we introduce the required preliminaries on semilattice enriched symmetric monoidal categories generated by monoidal theories,  and the string diagrammatic formalism we will use to represent them.  

Given a $\mathbb{C}$  with objects $A,B \in \mathbb{C}$ we denote by $\mathbb{C}(A,B)$ the corresponding hom-set.  We write the identity morphism on $A$ as $\id_A$,  or simply $A$.  We commonly write $f;g$ for composition in diagram order.  Composition in the usual order is written $g \circ f$.  We denote the tensor product of a \textit{symmetric monoidal category (SMC)} $\mathbb{C}$ by $\otimes$,  its unit by $1$ and its symmetry natural transformation as $\sym$ \cite{maclane}.  We adopt the convention that $\otimes$ binds more tightly than $(;\!)$.  We elide all associativity and unit isomorphisms associated with monoidal categories,  and often omit subscripts on identities and natural transformations where it can be inferred.  We denote by $\textsf{SLatt}$ the category of semilattices.  


\subsection{Symmetric Monoidal Theories and PROPs. }

A presentation of an algebraic theory is traditionally given by a \textit{signature} of $n$-ary operations and a set of \textit{equations}---formally,  pairs of terms freely generated over the signature.  We are interested here in symmetric monoidal theories, which are generalizations of algebraic theories where the operations of the signature may have arbitrary \textit{co-arities}.  First,  we generalize the notion of a signature. 
\begin{definition}[Monoidal signature]
A \textit{(monoidal) signature} $\Sigma$ is given by a set of \textit{generators} $c: n \to m$,  with \textit{arity} $n$ and \textit{coarity} $m$.  %A \textit{signature homomorphism} $h: \Sigma \to \Gamma$ is a function from $\Sigma$ to $\Gamma$ which preserves the (co-)arities of elements. 
\end{definition}

A categorical presentation of a monoidal signature is given by a freely generated products and permutations category.  
\begin{definition}[Products and permutations category]
A \textit{products and permutations category (PROP)} is a strict symmetric monoidal category with natural numbers as objects,  and such that $n \otimes m = n+m$.  A \textit{PROP functor} is a strict SMC-functor which is additionally identity-on-objects. 
We denote the free \textit{products and permutations category} over a monoidal signature $\Sigma$ by $\textbf{PROP}(\Sigma)$.  
\end{definition}
The free category $\textbf{PROP}(\Sigma)$ can be syntactically constructed from taking (typed) categorical combinator terms freely constructed from generators $c \in \Sigma$, $\textsf{id}_1$, $\sigma_{1,1}$, $(;\!)$ and $\otimes$, quotiented by the axioms of a symmetric monoidal category.  

An equation associated with a monoidal signature is a pair of parallel morphisms of the form above, leading to the following definition of a symmetric monoidal theory. 
\begin{definition}[Symmetric Monoidal Theory]
A \textit{presentation of a symmetric monoidal theory} $(\Sigma, \mathcal{E})$ is given by a pair of a monoidal signature $\Sigma$ and a set $\mathcal{E}$ of pairs of parallel morphisms $f,g: n \to m$ of $\textbf{PROP}(\Sigma)$.
A \textit{symmetric monoidal theory} $\textbf{SMT}(\Sigma,\mathcal{E})$ generated by a presentation $(\Sigma, \mathcal{E})$ is given by $\textbf{PROP}(\Sigma)$ quotiented by the least congruence including $\mathcal{E}$.
\end{definition}

It will often be convenient to give presentations of SMTs in terms of string diagrams.
\begin{example}
The SMT of \textit{commutative comonoids} is given by the following generators, ${\Delta, !}$, depicted in string diagrammatic form:
\[
	\scalebox{0.8}{
  	 \tikzfig{categorical-semantics/Cartesian-equipment}
	}
\]
together with the following associativity, commutativity and unitality equations, again given in terms of string diagrams. 
\[
	\scalebox{0.6}{
	\tikzfig{categorical-semantics/Cartesian-theory}	
	}
\]
The Cartesian SMT is given by a set of generators $\Sigma_C$, together with the generators and equations of the SMT of commutative monoids, and the following additional naturality equations, for every $c \in \Sigma_C$
\[
	\scalebox{0.6}{
	\tikzfig{categorical-semantics/Cartesian-naturality}
	}
\]
By Fox's Theorem~\cite{fox},  $\textbf{SMT}(\Sigma_C, \mathcal{E}_C)$ is equivalent to the free Cartesian category over $\Sigma_C$. 
\end{example}

\subsection{Free Semilattice Enrichment: Formal Joins}

We will use enrichment to axiomatize the e-box structure as the ``join" of two morphisms $f,g: A \to B$ as $f + g: A \to B$. Note, in particular,  that semilattices do not require a unit for $+$. This is important, since, in any commutative monoid enriched category,  if there exists a categorical product, then it must be a categorical biproduct \cite{maclane}---a degeneracy we wish to avoid.  More precisely our hom-sets will be given the structure of a semilattice.  
Generally,  we may define a category \textit{enriched} in any other monoidal category $M$ (\textit{e.g.},  \textbf{SLatt}).  In this case,  hom-sets are generalized to hom-objects of $M$ (\textit{e.g.},  a semilattice) and composition 
\[
	\circ: Hom(B,C) \otimes Hom(A,B) \to Hom(A,C)
\]
is defined as a $M$-morphism.  In other words,  composition must respect the additional structure on hom-sets.  
In our case,  the category we wish to enrich is also monoidal,  so we additionally ask that the monoidal structure also respects this structure.  Technically, this amounts to asking that the tensor product is an enriched functor. 
We omit further details of the general case of enrichment here, and instead work with the following more concrete defintion, where $M = \textbf{SLatt}$.  

\begin{definition}[Semilattice-enriched PROP]\label{def:enriched-prop}
A \textit{semilattice enriched strict SMC (PROP)}  $\mathbb{C}$ is given by an SMC (PROP) $(\mathbb{C}, \otimes, 1,+)$ where every hom-set additionally has the structure of a semilattice $(\mathbb{C}(A,B), +)$ -- that is,  a set equipped with an associative,  commutative,  and idempotent operation -- which respects the composition and tensor product in the following ways,  for all appropriately typed morphisms. 
\begin{align*}
f ; (g+h) &= f;g + f;h &
(f+g) ; h &= f;h + g;h \\
f \otimes (g+h) &= f \otimes g + f \otimes h & 
(f+g) \otimes h &= f \otimes h + g \otimes h,
%\item A set $ob(\mathbb{C})$ of objects;
%\item For every pair $A,B \in ob(\mathbb{C})$, a hom-semigroup $Hom(A,B)$;
%\item An element $\textsf{id}_{A,B} \in Hom(A,B)$; 
\end{align*}
Note,  we take $(;\!)$ and $\otimes$ to bind more tightly than $+$.
A \textit{semilattice enriched strict SMC (PROP) functor} $F: (\mathbb{C}, \otimes, 1,+) \to (\mathbb{D}, \otimes, 1,+)$ is given by a strict SMC (PROP) functor on the underlying SMCs (PROPs) which additionally satisfies $F(f+g) = F(f)+F(g)$.  We denote the \textit{freely enriched PROP (SMT)} over a monoidal signature $\Sigma$ as $\textbf{PROP}^+(\Sigma)$ ($\textbf{SMT}^+(\Sigma, \mathcal{E})$,  respectively). 
\end{definition}

The free category $\textbf{PROP}^+(\Sigma)$ can be syntactically constructed from taking (typed) $\Sigma^+$-terms  -- namely, those freely constructed from generators $c \in \Sigma$, $\textsf{id}_1$, $\sigma_{1,1}$, $(;\!)$ and $\otimes$ (and $f+g$, respectively) -- quotiented by the axioms of an enriched symmetric monoidal category.  

To aid reasoning, we introduce a new language of string diagrams for semilattice enriched SMCs, using a hierarchical ``box'' structure to capture the join operation on morphisms.  It was already discussed in the introduction how this is  used in the translation of equivalence classes from the e-graph to the string diagrammatic setting. 

Figure \ref{fig:egraph-strings} displays the generators of this language and Figure \ref{fig:string-equations} displays the additional equations which these diagrams satisfy, in addition to the standard SMC equations. 
The first four equations are those displayed in Definition \ref{def:def:enriched-prop},  while the final four axiomatize $+$ as an \textit{n-ary} associative, commutative and idempotent operation.  We overload the binary notation $+$ for our $n$-ary notation.  
We use string diagrams informally in this paper, but it is intuitively clear that these diagrams are sound and complete with respect to their intended categorical semantics. 
Indeed, similar diagrammatic languages using boxes to express choice have been used before~\cite{duncan_generalised_2009}. 

\begin{figure*}
\[  
    \scalebox{0.75}{
	\tikzfig{categorical-semantics/egraph-strings-equations}
    }
\]
\caption{Equations for a  semilattice enriched symmetric monoidal category}
\label{fig:string-equations}
\end{figure*}

\section{String Diagram Rewrite Theory}\label{sec:combinatorial-semantics}

In this section,  we recall the fundamental definitions and results of string diagram rewrite theory for symmetric monoidal categories,  building to the recapitulation of the correspondence between string diagram rewriting and an appropriate notion of double pushout (DPO) rewriting of certain hypergraphs,  as established in~\cite{bonchi_string_2022-1, bonchi_string_2022-2}.  

First,  we fix some notation.  Let $(-)^*$ be the free monoid monad over \textsf{Set}.  
We extend this to the case of relations $R \subseteq V \times V$,  so that we denote by $R^{*} \subseteq V^* \times V^*$ the element-wise extension of $\psi$ to a relation on ordered sequences. 
We elide associativity and unit isomorphisms associated with coproducts $(+)$,  and denote by $\iota_j: X_{j} \rightarrow X_{1} + \ldots X_{j} + \ldots X_{n}$ the $j^{\text{th}}$ injection,  and $[f,g]: A_1 + A_2 \to B$ the co-pairing of two morphisms $f: A_1 \to B$ and $g:A_2 \to B$. 
We denote by $A +_{f,g} B$ the pushout of the span $A \xleftarrow{f} C \xrightarrow{g} B$.

\subsection{Hypergraphs}

In ~\cite{bonchi_string_2022-1},  hypergraphs \textit{with interfaces} and their DPO rewriting are shown to be sound and complete for SMTs including a Frobenius algebra. 
Hypergraphs generalize graphs by allowing edges to have multiple sources and targets. 
When interpreting string diagrams as hypergraphs,  morphisms are interpreted as edges,  and wires as vertices.  
However,  there is also a need to specify which vertices are to be considered as \textit{input} and \textit{outputs},  corresponding to the dangling wires at the bottom and top of a string diagram. 
This gives rise to the definition of a hypergraph with interfaces.  
Subsequent work \cite{bonchi_string_2022-2} builds on this correspondence to give a restriction of hypergraphs with interfaces (called \textit{monogamous} directed acyclic),  leading to a correspondence between symmetric monoidal string diagrams and the category of such hypergraphs.


\begin{definition}[Category of hypergraphs]\label{def:hypergraph}
A \emph{hypergraph $\mathcal{G}$ over a signature $\Sigma$} is a tuple $(V,E,s,t,l)$,  where $V$ is a finite set of nodes, $E$ is a finite set of edges, $s : E \to V^{*}$ is a source function, $t : E \to V^{*}$ is a target function,  and $l : E \to \Sigma$ is a labelling function that assigns each edge a generator from monoidal signature $\Sigma$.  The labelling function must respect the typing of the generator: for all edges $e$,  $|s(e)| = m$ and $|t(e)| = n$,  where $l(e) : m \to n$.  We call a hypergraph \textit{discrete} if its set of edges is empty.   
A \emph{hypergraph homomorphism} $\phi: \mathcal{F} \to \mathcal{G}$ is given by a pair of functions $\phi_V : V_{\mathcal{F}} \to V_{\mathcal{G}}, \phi_E : E_{\mathcal{F}} \to E_{\mathcal{G}}$ such that the following hold. 
\begin{enumerate}
    \item $\phi_V^*(s_{\mathcal{F}}(e)) = s_{\mathcal{G}}(\phi_E(e))$
    \item $\phi_V^*(t_{\mathcal{F}}(e)) = t_{\mathcal{G}}(\phi_E(e))$
    \item $l_{\mathcal{F}}(e) = l_{\mathcal{G}}(\phi_E(e))$
\end{enumerate}
We denote by $\catname{Hyp(\Sigma)}$ the category of hypergraphs over $\Sigma$ and hypergraph homomorphisms. 
\end{definition}
Note that $\catname{Hyp(\Sigma)}$ has all finite colimits and, in particular,  the coproduct is given by the disjoint union of hypergraphs.
The initial object is given by the empty hypergraph.  

\begin{definition}[Symmetric monoidal category of cospans]
Let $\mathbb{C}$ be a category with all finite colimits.  A cospan from $X$ to $Y$ is a pair of arrows $X \xrightarrow{} A \xleftarrow{} Y$  in $\mathbb{C}$.  This \textit{category of cospans of $\mathbb{C}$},  denoted $\catname{Csp(\mathbb{C})}$,  has as objects those of $\mathbb{C}$ and as arrows isomorphism classes of cospans.
%Two cospans $X \xrightarrow{} A \xleftarrow{} Y$ and $X \xrightarrow{} B \xleftarrow{} Y$ are isomorphic if the following diagram commutes and $\alpha$ is iso.
%\[
%\begin{tikzcd}
%                                               & A \arrow[dd, "\alpha"] &                                                \\
%X \arrow[ru, bend left] \arrow[rd, bend right] &                        & Y \arrow[ld, bend left] \arrow[lu, bend right] \\
%                                               & B                      &                                               
%\end{tikzcd}
%\]
%For $X \in \mathbb{C}$ an $id$-cospan is $X \xrightarrow{id_X} X \xleftarrow{id_X} X$.
Composition of cospans $X \xrightarrow{f} A \xleftarrow{g} Y$ and $Y \xrightarrow{h} B \xleftarrow{i} Z$ is given by pushout: $X \xrightarrow{f} A +_{g,h} B \xleftarrow{i} Z$,  with identity given by the cospan of identities.  Its monoidal product is given by the coproduct of $\mathbb{C}$ as follows: 
\begin{multline*}
    (A \xrightarrow{f} \mathcal{G} \xleftarrow{g} B) \otimes (A' \xrightarrow{f'} \mathcal{G'} \xleftarrow{g'} B') \coloneq\\ A + A' \xrightarrow{f+f'} \mathcal{G} + \mathcal{G'} \xleftarrow{g+g'} B + B'  , 
\end{multline*}
and its unit by the initial object of $\mathbb{C}$.
Symmetry is inherited from $\mathbb{C}$ as the coproduct~\cite{MonoidalCoproduct}.
\end{definition}


Then, morphisms of $\textbf{PROP}(\Sigma)$ can be interpreted as particular cospans of discrete hypergraphs,  which we call hypergraphs with interfaces~\cite{bonchi_string_2022-2}.
\begin{definition}[Hypergraphs with interfaces]
\label{def:cspd}
Define the category of \emph{hypergraphs with interfaces} $\catname{HypI(\Sigma)}$ as the full sub-category of $\catname{Csp(Hyp(\Sigma))}$ with discrete hypergraphs as objects.
\end{definition}

In particular, this means that any morphism in $\catname{HypI(\Sigma)}$ is of the form $n \xrightarrow{f} \mathcal{G} \xleftarrow{g} m$,
where $n,\;m$ are discrete hypergraphs and $\mathcal{G}$ is an arbitrary hypergraph.  The morphisms $f$ and $g$ into $\mathcal{G}$ will specify which vertices are to be considered as inputs and outputs,  respectively.   

\begin{definition}[Degree,  path,  acyclic] 
The \emph{in-degree} of a node $v$ in a hypergraph $\mathcal{G}$ is the number of hyperedges $e \in {E_\mathcal{G}}$ such that $v \in s(e)$.  Similarly, the out-degree of $v$ is the number of edges $e \in E_\mathcal{G}$ such that $v \in t(e)$.
A \emph{path} from $e_0$ to $e_{n-1}$ of length $n$ in a hypergraph $\mathcal{G}$ is an ordered sequence of edges $[e_0, e_1, \ldots, e_{n-1}] \in E_\mathcal{G}^*$ such that for all $i < n - 1$ some node $v \in t(e_i)$ is also in $s(e_{i+1})$.
A hypergraph is \emph{directed acyclic} if it contains no paths of length $n > 0$ that start and end in the same edge.
\end{definition}

In order to represent only morphisms of $\textbf{PROP}(\Sigma)$,  it is necessary to restrict our attention to the following subset of hypergraphs with interfaces. 
\begin{definition}[Category of MDA Hypergraphs with Interfaces]
\label{def:monogamy_hyp}
We call a cospan $n \xrightarrow{f} \mathcal{G} \xleftarrow{g} m$ in $\HypI{\Sigma}$ \emph{monogamous directed acyclic (MDA)} if:
\begin{enumerate}
    \item $\mathcal{G}$ is a directed acyclic hypergraph;
    \item $f$ and $g$ are monomorphisms;
    \item the in-degree and out-degree of every vertex is at most $1$;
    \item vertices with in-degree $0$ are precisely the image of $f$; and
    \item vertices with out-degree $0$ are precisely the image of $g$.
\end{enumerate}
We denote by $\MdaCospans$ the subcategory of $\HypI{\Sigma}$ of MDA-cospans. 
\end{definition}
Note that $\MdaCospans$ remains a symmetric monoidal category with the same equipment as before.  In fact,  due to 
\cite{bonchi_string_2022-2},  we have the following theorem which says the category $\MdaCospans$ is in fact \textit{equivalent} to $\textbf{PROP}(\Sigma)$. 
\begin{theorem}[Corollary 26~\cite{bonchi_string_2022-2}]
    $\textbf{PROP}(\Sigma) \cong \MdaCospans$
\end{theorem}

\subsection{DPOI-Rewriting for Hypergraphs with Interfaces}
The correspondence of the previous section means that the symmetric monoidal equations of $\textbf{SMT}(\Sigma, \mathcal{E})$ are absorbed in the hypergraph representation.  The equations $\mathcal{E}$ are then to be considered as rewrite rules on string diagrams,  which are then modelled as DPO-rewrites on hypergraphs with interfaces. 
DPO rewriting is a standard technique for formalising graph rewriting categorically. 
In this section we recall standard results of double-pushout (DPO) rewriting of hypergraphs,  as well as the specific notion of DPO rewriting which is sound and complete for arbitrary SMTs,  which is called \textit{convex} rewriting. 

The intuitive notion of (hyper-)graph rewriting is  as expected: given a rewrite rule $\mathcal L \rightsquigarrow \mathcal R$ and a graph $\mathcal{G}$,  we expect to find an occurrence of $\mathcal L$ within $\mathcal{G}$,  remove it,  and then plug $\mathcal R$ into the hole to recover the rewritten graph $\mathcal{H}$.  In DPO rewriting,  such a rewrite rule is formalized as a span $\mathcal L \xleftarrow{} \mathcal K \xrightarrow{} \mathcal R$ in some appropriate category of graphs,  where $\mathcal K$ is some invariant that should be maintained during rewriting.
A typical DPO square looks as follows,  where the two marked squares are pushouts. 
% \[
% \begin{tikzcd}
% \mathcal L \arrow[d, "m"'] & \mathcal K \arrow[d] \arrow[l] \arrow[r] & \mathcal R \arrow[d]   \\
% \mathcal G^{\urcorner}     & \mathcal C \arrow[l] \arrow[r] & ^{\ulcorner} \mathcal H
% \end{tikzcd}
% \]
\[
    \scalebox{0.8}{
        \tikzfig{combinatorial_semantics/DPO_square}
    }
\]

The morphism $\mathcal L \to \mathcal G$ is called a \textit{match},  defined whenever there is a corresponding \textit{pushout complement}---the pair of morphisms $\mathcal K \to \mathcal C \to \mathcal G$ completing the top half of the pushout square defined by $\mathcal K \xrightarrow{} \mathcal L \xrightarrow{} \mathcal G$. When the morphisms involved in the rewrite rule are monomorphisms,  as is usually required,  constructing $\mathcal C$ can be intuitively understood as finding an occurrence of $\mathcal L$ in $\mathcal G$ and removing from this occurrence everything that has no pre-image in $\mathcal K$.  The final graph $\mathcal H$ is the recovered by inserting into the hole everything from $\mathcal R$ that has no pre-image in $\mathcal K$--hence the two pushouts: one for deletion and one for insertion.  In this case,  we say that $\mathcal G$ is rewritten into $\mathcal H$ via the rewrite rule $\mathcal L \xleftarrow{} \mathcal K \xrightarrow{} \mathcal R$.

To express the rewriting of (hyper-)graphs with interfaces,  \textit{i.e.},  the ones that represent morphisms in $\HypI{\Sigma}$, the DPO formalism has been extended to double-pushout rewriting with \textit{interfaces}  (DPOI).
In the case of $ \catname{Hyp(\Sigma)}$,  we wish rewrite rules to be pairs of discrete cospans of hypergraphs with matching interfaces: $n \xrightarrow{} \mathcal L \xleftarrow{} m$, $n \xrightarrow{} \mathcal R \xleftarrow{} m$.  By noting that a cospan $0 \xrightarrow{} \mathcal L \xleftarrow{[f,g]} n + m$ encodes the same data as a cospan $n \xrightarrow{f} \mathcal L \xleftarrow{g} m$ (Remark 3.14~\cite{bonchi_string_2022-1}) we can formulate a rewrite rule as a single span $\mathcal L \xleftarrow{} n+m \xrightarrow{} \mathcal R$,  and we can do similarly for the discrete cospans giving the interface to $\mathcal G$ and $\mathcal H$.  Thus we reach the following variant of DPO rewriting. 
\begin{definition}[DPOI rewriting]\label{def:dpoi}
Given a span of morphisms $\mathcal G \xleftarrow{} n+m \xrightarrow{} \mathcal H$ in $\textbf{Hyp}(\Sigma)$,  we say \textit{$\mathcal G$ rewrites to $\mathcal H$ with interface $n+m$ via rewrite rule $\mathcal L \xleftarrow{} i+j \xrightarrow{} \mathcal R$} if there exists an object $\mathcal C$ and morphisms which complete the following commutative diagram such that the two marked squares are pushouts.
% \[
% \begin{tikzcd}
% \mathcal L \arrow[d, "m"'] & i+j \arrow[d] \arrow[l] \arrow[r] & \mathcal R \arrow[d]   \\
% \mathcal{G}^{\urcorner}     & \mathcal C \arrow[l] \arrow[r]                      & ^{\ulcorner}\mathcal H \\
%                   & n+m \arrow[lu] \arrow[u] \arrow[ru]          &              
% \end{tikzcd}
% \]
\[
    \scalebox{0.8}{
        \tikzfig{combinatorial_semantics/DPOI_square_Hyp}
    }
\]
\end{definition}
We need to restrict the notions of pushout complement and of match in order to preserve monogamy and directed acylcicity.  

\begin{definition}[Boundary complement]
\label{def:boundary_original}
For monogamous cospans $i \xrightarrow{a_1} L \xleftarrow{a_2} j$ and $n \xrightarrow{b_1} \mathcal G \xleftarrow{b_2} m$
and mono $f : \mathcal L \to \mathcal G$, a pushout complement as depicted in the square below

% \begin{figure}[h!]
%     \centering
%     \includegraphics[width=0.4\linewidth]{figures/combinatorial_semantics/boundary_complement.png}
% \end{figure}

% https://q.uiver.app/#q=WzAsNSxbMCwwLCJMIl0sWzIsMCwiaStqIl0sWzAsMiwiR157XFx1cmNvcm5lcn0iXSxbMiw0LCJuK20iXSxbMiwyLCJMXntcXGJvdH0iXSxbMyw0LCJbZF8xLGRfMl0iLDJdLFszLDIsIltiXzEsYl8yXSJdLFswLDIsImYiLDJdLFsxLDAsImEgPSBbYV8xLGFfMl0iLDJdLFsxLDQsImMgPSBbY18xLGNfMl0iXSxbNCwyLCJnIl1d
% \[\begin{tikzcd}
% 	\mathcal L && {i+j} \\
% 	\\
% 	{\mathcal G^{\urcorner}} && {\mathcal{L}^{\bot}} \\
% 	\\
% 	&& {n+m}
% 	\arrow["{[d_1,d_2]}"', from=5-3, to=3-3]
% 	\arrow["{[b_1,b_2]}", from=5-3, to=3-1]
% 	\arrow["f"', from=1-1, to=3-1]
% 	\arrow["{[a_1,a_2]}"', from=1-3, to=1-1]
% 	\arrow["{[c_1,c_2]}", from=1-3, to=3-3]
% 	\arrow[from=3-3, to=3-1]
% \end{tikzcd}\]

\[
    \scalebox{0.8}{
        \tikzfig{combinatorial_semantics/DPOI_boundary_complement}
    }
\]

is called a boundary complement if $[c_1, c_2]$ is mono and there exist $d_1 : n \to \mathcal{L}^{\bot}$ and $d_2 : m \to \mathcal{L}^{\bot}$ making the above triangle commute and such that
\[
    n + j \xrightarrow{[d_1,c_2]} \mathcal{L}^{\bot} \xleftarrow{[d_2,c_1]} m + i
\]
is a monogamous cospan. 
\end{definition}
%\begin{remark}
%    Note how the requirement for $i \xrightarrow{} L \xleftarrow{} j$ and $n \xrightarrow{} G \xleftarrow{} m$ being monogamous, i.e. morphisms in $\MdaCospans$, is a part of the above definition.
%\end{remark}
Intuitively,  requiring boundary complements ensures that inputs are glued exclusively to outputs and vice-versa in the two pushout squares.

\begin{definition}[Convex match]
We call a subgraph $\mathcal{H}$ of a hypergraph $\mathcal{G}$ a \emph{convex subgraph} if for all $v_i, v_j \in V_{\mathcal{H}}$ every path from $v_i$ to $v_j$ is also in $\mathcal{H}$.
We call a match $m : \mathcal L \to \mathcal G$ a \emph{convex match} if it is mono and its image is a convex subgraph of $\mathcal G$. 
   
\end{definition}

\begin{definition}[Convex DPOI rewriting]
\label{def:convex_dpo}
Let $\mathfrak{R}$ be a set of DPOI rewrite rules. 
Then, given $\mathcal G \xleftarrow{} n+m$ and $\mathcal H \xleftarrow{} n + m$ in $\catname{Hyp(\Sigma)}$, $\mathcal G$ rewrites convexly into $\mathcal H$ with interface $n + m$ --- notation $(\mathcal G \xleftarrow{} n + m ) \Rrightarrow_{\mathfrak{R}}  (\mathcal H \xleftarrow{} n + m )$ --- if there exist rule $\mathcal L \xleftarrow{} i + j \xrightarrow{} \mathcal R$ in $\mathcal{R}$ and object $C$ and cospan arrows $i+j \xrightarrow{} \mathcal C \xleftarrow{} n+m$ such that the DPOI diagram of Definition \ref{def:dpoi} commutes and its marked squares are pushouts 
and the following conditions hold
\begin{itemize}
    \item $m : L \to \mathcal G$ is a convex match;
    \item $i + j \to \mathcal C \to \mathcal G$ is a boundary complement in the leftmost pushout.
\end{itemize}
\end{definition}
%By requiring convex matching and boundary complements we ensure that the original cospans above are monogamous, e.g., $n \xrightarrow{} G \xleftarrow{} m$.

CHRIS: WANT TO STATE THE CORRESPONDENCE THEOREM WITH SMTS HERE? NEED TO DEFINE $\lceil-\rceil$ AND INTERPRETATION? Hmm
DAN: I THINK THIS PRELIMINARY SECTION IS VERY LONG. UNLESS WE USE THIS THEOREM IN THE PAPER LATER CAN WE JUST STATE IT INFORMALLY, WITHOUT INTRODUCING THIS NOTATION? IF THE NOTATION IS USED, IT MUST BE DEFINED. 
\begin{theorem}[Theorem 35~\cite{bonchi_string_2022-2}]
For any $f,g \in \mathbf{SMT}(\Sigma, \mathcal{E})$,  we have that 
\[
	f = g \iff \llangle \lceil f \rceil \rrangle \Rrightarrow^*_{\mathfrak{R}} \llangle \lceil g \rceil \rrangle~, 
\]
where $\mathfrak{R} = \llangle \lceil \mathcal{E} \rceil \rrangle$ and $ \Rrightarrow^*_{\mathfrak{R}}$ denotes the existence of a sequence of convex rewrites. 
\end{theorem}
\section{E-Hypergraphs}\label{sec:e-hypergraphs}

Hierarchical (hyper-)graphs are a well-studied area of research \cite{plump:hierarchical-graphs, montanari:gs-lambda, palacz:hierarchical-transform, Gaducci:hierarchical-graphs, Ghica:hierarchical}.  In this section,  we follow analogous steps to those used to achieve a combinatorial representation of $\textbf{PROP}(\Sigma)$ by $\mathbf{MHypI}(\Sigma)$,  but in the semilattice enriched setting.  First we define an \textit{e-hypergraph},  which supports a hierarchical notion of ``e-box'' with distinct components. Then,  we extend this notion with interfaces via a generalization of the cospan construction.  Finally,  we restrict the morphisms under consideration to those satisfying the MDA condition,  as in the previous section.  An example diagram representing e-hypergraphs with interfaces can be found in Figure \ref{fig:A+B}.

Note that here,  and in the rest of the paper,  we will restrict to dealing with signatures $\Sigma$ containing only morphisms $f: n \to m$ where either $n$ or $m$ are non-zero.  This is a restriction we make in order to avoid complications to the technical development of DPOI rewriting for e-hypergraphs given in the subsequent section,  and we explain it further there. 

In the following,  we elide the obvious injections of $V$ and $E$ into $V+E$. 

\begin{definition}[E-hypergraphs]
\label{def:e-homo}    
An \emph{e-hypergraph $\mathcal{G}$ over a signature $\Sigma$} is a tuple $(V,E,s,t,l,<,\consistency)$,  where $(V,E,s,t)$ is an unlabelled hypergraph;  $l :E \to \Sigma + 1$ is a labelling function modified to include an extra value $\bot$ in its codomain; $<$ is a strict partial order on $V + E$ called the \textit{child relation}.  We define the following additional notation.  For $x \in V + E$,  the set of \emph{parents} and \emph{children} of $x$,  respectively: 
\[
	[x) = \{x' ~|~ x' <_c x\; \} \qquad (x] = \{x' ~|~  x <_{c} x'\}
\]
We will denote the unique immediate parent $e$ of $x$ by writing $e <^{\mu} x$.
We call edges $e$ such that $l(e) = \bot$ \textit{hierarchical},  and edges $e$ and nodes $v$ such that $[e) = \varnothing$ and $[v) = \varnothing$ \emph{top-level}.
We require that the child relation satisfies the following conditions:
\begin{enumerate}
	\item each parent set contains exclusively hierarchical edges;
	\item Each $x$ has at most one immediate parent;
	\item if $v \in s(e)$ then $e' <^{\mu} e$ iff $e' <^{\mu} v$.
\end{enumerate}
We additionally define an equivalence relation $\consistency_p$,  called the \textit{consistency relation},  on each set $\{x \in V + E ~|~ p <^\mu c\}$ of elements which share the same parent.  
We collect the union of all these equivalence relations into on relation $\consistency = \bigcup_{p} \consistency_p$,  which is defined on a subset of $V+E$. 
The consistency equivalence relation must additionally satisfy that if $v \in s(e)$ or $v \in t(e)$ then $v \consistency e$. 
\label{def:consistency_properties}
\end{definition}
Intuitively,  the child relation equips the hypergraph with a hierarchical structure: certain edges,  labelled with $\bot$,  are meant to interpret the dashed e-boxes of  string diagrams.  
These edges can be designated as "parents" to sub-hypergraphs,  which interpret the various components of the e-boxes.  These components are distinguished by the consistency relation, which partitions the sub-hypergraph below the hierarchical edge.  
Technically,  condition $(3)$ on the child relations says that $<^{\mu}$ respects connectivity of edges and vertices,  and similarly for conditions $(1)$ of the consistency relation. 
\begin{definition}[E-hypergraph homomorphism]
An \textit{e-hypergraph homomorphism} $\phi: \mathcal{F} \to \mathcal{G}$ of e-hypergraphs $\mathcal{F},\mathcal{G}$ is a pair of functions $\phi_V : V_{\mathcal{F}} \to V_{\mathcal{G}}, \phi_E : E_{\mathcal{F}} \to E_{\mathcal{G}}$ such that
\begin{enumerate}
    \item $\phi$ is a hypergraph homomorphism
    \item for $v \in V_{\mathcal{F}}$,  if $v$ is not top-level then 
	\[
        \phi_{E}(<_{\mathcal{F}}^{\mu}(v)) = <_{\mathcal{G}}^{\mu}(\phi_{V}(v))
        \] 
        and for $e \in E_{\mathcal{F}}$,  if $e$ is not top-level then 
        \[
        \phi_{E}(<_{\mathcal{F}}^{\mu}(e)) = <_{\mathcal{G}}^{\mu}(\phi_{E}(e))  
        \] 
    % \item
    % $x_1 \#_{\mathcal{F}} x_2$ iff $\phi(x_1) \#_{\mathcal{G}} \phi(x_2)$, where $x_1, x_2 \in \mathcal{F}$
        \item for all $x_1, x_2 \in \mathcal{F}$,  $x_1 \consistency_{\mathcal{F}} x_2$ implies $\phi(x_1) \consistency_{\mathcal{G}} \phi(x_2)$. 
%    Or, written functionally, when $x \in E_{\mathcal{F}}$
%    \[
%        \langle \phi_{V};i_{V_{\mathcal{G}}}, \phi_{E};i_{E_{\mathcal{G}}} \rangle^{*}(\consistency_{\mathcal{F}}^{\mu}(i_{E_{\mathcal{F}}}(x)))
%        \subseteq
%        \consistency_{\mathcal{G}}^{\mu}(\phi_{E};i_{E_{\mathcal{G}}}(x))
%    \]
%    , where $\phi_{V};i_{V_{\mathcal{G}}} : V_{\mathcal{F}} \to V_{\mathcal{G}} + E_{\mathcal{G}}$%, and similarly for $\phi_{E};i_{E_\mathcal{G}}$ so that $\langle \phi_{V};i_{V_{\mathcal{G}}}, \phi_{E};i_{E_{\mathcal{G}}} \rangle : V_{\mathcal{F}} + E_{\mathcal{F}} \to  V_{\mathcal{G}} + E_{\mathcal{G}}$.
%    And, when $x \in V_{\mathcal{F}}$
%    \[
%        \langle \phi_{V};i_{V_{\mathcal{G}}}, \phi_{E};i_{E_{\mathcal{G}}} \rangle^{*}(\consistency_{\mathcal{F}}^{\mu}(i_{V_{\mathcal{F}}}(x)))
%        \subseteq
%        \consistency_{\mathcal{G}}^{\mu}(\phi_{V};i_{V_{\mathcal{G}}}(x))
%    \]
    % Or, on per-component basis, if $i_{E_{\mathcal{F}}}(x_1) \in \hashtag_{\mathcal{F}}(i_{E_{\mathcal{F}}}(x_2))$ then $i_{E_{\mathcal{G}}}(\phi_{E}(x_1)) \in \hashtag_{\mathcal{G}}(i_{E_{\mathcal{G}}}(\phi_{E}(x_2)))$ and similarly for other types of $x_1,x_2$.
\end{enumerate}
If we further have that if $[x_1) = \varnothing$ then $[\phi(x_1)) = \varnothing$ we call the homomorphism \textit{strict}.
\end{definition}
The conditions on e-hypergraph homomorphisms require to preserve immediate parents and the conflict relation.  
\begin{definition}[Category of e-hypergraphs]
The \emph{category of e-hypergraphs},  denoted  $\catname{EHyp(\Sigma)}$,  has e-hypergraphs as objects and e-hypergraph homomorphisms as morphisms.  
\end{definition}

The category of e-hypergraphs has coproducts,  given by the disjoint union of e-hypergraphs,  and an initial object given by the empty e-hypergraph.  A concrete description of the pushout of two morphisms in this category is given in the appendix.  Generally,  the pushout of two e-hypergraph homomorphisms need not exist,  but we prove that it does when certain technical conditions are satisfied,  including that the two morphisms involved are monos and their shared domain is a discrete hypergraph.  

\begin{remark}
When we wish to consider $\phi(\mathcal{F}) \subseteq \mathcal{G}$ as an e-hypergraph in its own right,  we assign $\bot$ to be the immediate parent of all $x$ whose immediate parent is in $\mathcal{G}$ is outside $\phi(\mathcal{F})$.
\end{remark}

When modelling enriched string diagrams using e-hypergraphs,  we require to keep track of more than simply the ultimate external inputs and outputs of the diagram: each internal e-box has its own inputs and outputs,  which we must also keep track of.  Thus,  we introduce an \textit{extended} cospan construction.  Since the $\catname{EHyp(\Sigma)}$ does not have pushouts in general,  we skip straight to considering a category of extened cospans of discrete e-hypergraphs (\textit{i.e.},  discrete hypergraphs considered as e-hypergraphs in the obvious way),  for which pushouts do exist. 
\begin{definition}[Category of e-hypergraphs with interfaces]
    The category of \textit{e-hypergraphs with interfaces} $\Ecospans$ has discrete e-hypergraphs as objects,  with homsets $\Ecospans(n,m)$ consisting of isomorphism classes of \textit{extended cospans}, defined as follows:  
    \[
    n \xrightarrow{f_{ext}} n' \xrightarrow{f_{int}} \mathcal{G} \xleftarrow{g_{int}} m' \xleftarrow{g_{ext}} m
    \]
    where $\mathcal{G}$ is an e-hypergraph,  and $n, n', m, m'$ are discrete e-hypergraphs,  $f_{ext},f_{int},g_{ext},g_{int}$ are monomorphisms in $\catname{EHyp(\Sigma)}$,  and the image of $f_{ext};f_{int}$ and of $g_{ext};g_{int}$ consist exclusively of top-level vertices,  and that that vertices in the strictly internal interface (defined below) are not top-level. 

This justifies calling $n$  \textit{external input interfaces} and $n'$ \textit{internal input (output) interfaces}.  We call $n' \setminus f_{ext}(n)$  the \textit{strictly internal input interfaces}.  We do analogously for the \emph{output interfaces},  with respect to $m$,  $m'$ and $m' \setminus g_{ext}(m)$.  
We occasionally conflate $f_{ext}$ with $f_{ext};f_{int}$ when it is clear from context,  and also conflate $n, n', m$ and $m'$ with their images in $\mathcal{G}$. 
Given an edge $e \in E_\mathcal{G}$ such that $l(e) = \bot$,  we call the \textit{inputs of $e$} the intersection of the strictly internal input interface of $\mathcal{G}$ with the immediate successors of $e$,  and analogously for the \emph{outputs of $e$}.  
    
    Two cospans are isomorphic if there exist isomorphisms $\alpha$, $\beta$ and $\gamma$ making the following diagram commute.
    \[
    \scalebox{0.75}{
        \tikzfig{combinatorial_semantics/isomorphic_e_cospans}
    }
    \]
Composition of two morphisms $h_1 : n \to m$ and $h_2 : m \to k$ is computed in two stages.
First, $\mathcal{H} = \mathcal{F} +_{f_{ext}, g_{ext}} \mathcal{G}$ is computed,  as shown below. 

% https://q.uiver.app/#q=WzAsMTAsWzAsMCwiZXh0KFgpIl0sWzEsMSwiWCJdLFsyLDIsIkEiXSxbMywwLCJZIl0sWzQsMCwiZXh0KFkpIl0sWzUsMCwiWSciXSxbNiwyLCJCIl0sWzcsMSwiWiJdLFs4LDAsImV4dChaKSJdLFs0LDMsIl57XFx1bGNvcm5lcn1BK197Zl97ZXh0fTtmLGdfe2V4dH07Z31CIl0sWzAsMV0sWzEsMl0sWzMsMiwiZiJdLFs0LDMsImZfe2V4dH0iXSxbNCw1LCJnX3tleHR9IiwyXSxbNSw2LCJnIiwyXSxbNyw2XSxbOCw3XSxbMiw5XSxbNiw5XV0=

\[
\trimbox{0cm 0cm 0cm 1cm}{
\adjustbox{scale=0.9,center}
{\tikzfig{combinatorial_semantics/pushout_e_cospans}}
}
\]
Then, new feet for $\mathcal{H}$ are computed as below
\[
n \xrightarrow{f_{ext};\iota_1} n' \uplus (m'' \setminus m) \xrightarrow{h_{1}} \mathcal{H} \xleftarrow{h_2} k' \uplus (m' \setminus m) \xleftarrow{g'_{ext};\iota_1} k
\]
where
\[
    h_1 = [ f_{int};p_1, ~g_{int}|_{m'' \setminus m};p_2 ]
\qquad
    h_2 = [ g'_{int};p_2, ~f'_{int}|_{m' \setminus m};p_1 ]
\]
% \[
% \begin{tikzcd}
% Y_{ext} \arrow[d] & 0 \arrow[l] \arrow[d]    \\
% Y'          & Y' \setminus Y_{ext} \arrow[l]
% \end{tikzcd}
% \]
% and then the disjoint union is just a coproduct. 
% where $g'$ is the restriction of $g$ to ${Y' \setminus Y_{ext}}$ and $f'$ the restriction of $f$ to $Y \setminus Y_{ext}$. 
The identity of composition is given by the obvious extended cospan of identities. 
$\Ecospans$ inherits a symmetric monoidal structure from the coproduct (and initial object) structure of $\catname{EHyp({\Sigma}})$,  analogously to Definition~\ref{def:cspd}.  
\end{definition}
CHRIS: UPDATE DIAGRAMS TO USE MY NEW NOTATION,  TAKE LESS VERTICAL SPACE.  FIND CLEANER WAY TO WRITE NEW FEET.  USE $\iota$ FOR INJECTIONS

As in the standard cospan construction,  it is necessary to consider isomorphism classes of cospans since composition (defined by pushout) is associative only up-to isomorphism (since pushouts are unique only up-to isomorphism). 
Unlike in the previous section,  we require (extended) cospans to consist of monomorphisms.  This is to ensure the existence of the pushouts needed for composition,  since pushouts do not necessarily exist in $\textbf{EHyp}(\Sigma)$.  This also means that we omit the monomorphism condition from the following definition.  We additionally introduce a notion of \textit{well-typing} of e-hypergraphs,  which ensures each component of an e-box has the same number of inputs (outputs) as every other component. 

% https://q.uiver.app/#q=WzAsNSxbMCwwLCJYICsgWSJdLFsyLDAsIlggKyBZIl0sWzQsMCwiWSArIFgiXSxbNiwwLCJZICsgWCJdLFs4LDAsIlkgKyBYIl0sWzAsMSwiaWRfWCArIGlkX1kiXSxbMSwyLCJcXHNpZ21hX3tYLFl9Il0sWzQsMywiaWRfWSArIGlkX1giLDJdLFszLDIsImlkX1kgKyBpZF9YIiwyXV0=



\begin{definition}[Category of well-typed MDA e-hypergraphs with interfaces]
We call an extended cospan in $\Ecospans$,  as below,   \textit{monogamous directed acyclic (MDA)} if
\[
n \xrightarrow{f_{ext}} n' \xrightarrow{f_{int}} \mathcal{G} \xleftarrow{g_{int}} m' \xleftarrow{g_{ext}} m
\]
\begin{enumerate}
        \item underlying hypergraph of $\mathcal{G}$ is directed acyclic; 
       % \item $f_{ext}$, $f_{int}$, $g_{ext}$ and $g_{int}$ are monomorphisms; 
        \item The in-degree and out-degree of every vertex is at most 1; 
        \item Vertices with in-degree $0$ are precisely the image of $f_{int}$; 
        \item Vertices with out-degree $0$ are precisely the image of $g_{int}$; 
        % the item below is not assumed by the definition of a cospan of e-hypergraphs
        % \item $[v) = \varnothing$ for all $v$ in the image of $f_{ext};f$, and for all $v$ in the image of $g_{ext};g$. 
\end{enumerate}
\label{def:monogamy_ehyp} 

Further,  consider the sets of input and output vertices,  $I$ and $O$ respectively,  of a hierarchical edge $e$ of an e-hypergraph $\mathcal{G}$. 
The consistency relation of $\mathcal{G}$ partitions $I$ and $O$.  
We call $e$ \emph{well-typed} if the size of each partition of $I$ is $|s(e)|$ and the size of each partition of $O$ is $|t(e)|$.
We will call an MDA-extended-cospan in $\MdaEcospans$ \emph{well-typed} if all hierarchical edges in its apex are well-typed.

We denote by $\MdaEcospans$ the subcategory of $\Ecospans$ consisting of well-typed MDA-extended-cospans. 
\end{definition}
Note,  $\MdaEcospans$ is indeed a category,  and in fact inherits the symmetric monoidal structure of $\Ecospans$:  it is easy to check that identities,  the monoidal unit,  symmetry,  and the composition and tensor product of any two well-typed cospans are all (again) well-typed.  

Unlike in the previous section,  in order to give an equivalence with $\textbf{PROP}^+(\Sigma)$,  we must first develop the theory of DPOI rewriting for e-hypergraphs.  This is beacuse the equations for semilattice enrichment are not intended to be subsumed by the e-hypergraph representation.  Instead,  we will treat them via rewriting,  as we do with equations of the signature.  This is because the semilattice equations involve sharing and copying, operations on string diagrams which are not usually quotiented away, cf. string diagrams for Cartesian categories. 

\section{DPOI-Rewriting for E-Hypergraphs}

CHRIS: REMARK THAT WE CANNOT DEAL WITH SIGNATURES WITH $f:0 \to 0$ MORPHISMS, AND WHY!
Because extended cospans have a more general notion of interface, DPOI rewriting as presented in Section \ref{sec:combinatorial-semantics} needs some adjustments.
First, the existence of \textit{internal} interfaces needs to be accounted for,  and in particular that internal interfaces are not necessarily preserved during rewriting.
The former means that we wish a rewrite rule to be a pair of \textit{extended} cospans of e-hypergraphs with matching external interfaces.
\[
    i \xrightarrow{} i' \xrightarrow{} \mathcal{L} \xleftarrow{} j' \xleftarrow{} j
\qquad \text{and} \qquad
    i \xrightarrow{} i'' \xrightarrow{} \mathcal{R} \xleftarrow{} j'' \xleftarrow{} j
\]
We will next use the fact that cospans
\[
    i \xrightarrow{} i' \xrightarrow{} \mathcal{L} \xleftarrow{} j' \xleftarrow{} j
\qquad \text{and} \qquad
    0 \xrightarrow{} 0 \xrightarrow{} \mathcal{L} \xleftarrow{} i' + j' \xleftarrow{} i + j
\]
endcode the same data and only consider cospans of the form
\[
\mathcal{L} \xleftarrow{} i' + j' \xleftarrow{} i + j \xrightarrow{} i'' + j'' \xrightarrow{} \mathcal{R}
\] to fit the DPO formalism.
We will futher omit the arrows $0 \to 0 \to \mathcal{L}$.
To illustrate the non-preservation of internal interfaces, consider the rewrite rule above and the following e-hypergraph with interfaces to perform the rewrite on
% \[\langle x \xrightarrow{} x' \xrightarrow{} \mathcal{L} \xleftarrow{} y' \xleftarrow{} y, x \xrightarrow{} x'' \xrightarrow{} \mathcal{R} \xleftarrow{} y'' \xleftarrow{} y \rangle \]
% such that $x' \not \cong x''$ and $y' \not \cong y''$ and consider the following e-hypergraph to perform the rewrite on
\[
    \mathcal{G} \xleftarrow{} n' + k' \xleftarrow{} n + k
\] such that there is a matching $m : \mathcal{L} \to \mathcal{G}$  and assume $i' \not \cong i''$ and $j' \not \cong j''$.
When removing the occurence of $\mathcal{L}$ from $\mathcal{G}$, \emph{i.e.}, by computing the pushout complement, the internal interfaces of $\mathcal{G}$ should be modified to exclude the vertices that were a part of (the image of) $\mathcal{L}$'s strict internal interfaces.
Then, when gluing $\mathcal{R}$ into the created context, we need to introduce strict internal interfaces of $\mathcal{R}$ into this context.
In particular, it means that the internal interfaces of the resulting cospan of e-hypergraphs
\[
    \mathcal{H} \xleftarrow{} n'' + k'' \xleftarrow{} n + k 
\]
not necessarily coincides with the internal interfaces of the initial cospan.
% The input interface on the left-hand side of the rule is $\{1, 2\}$, while the input interface on the right-hand side of the rule is $\{1,2,5,6,7,8\}$.
% Note that the outermost interfaces are preserved.

% Another concern is when we delete the occurrence of the left-hand side of a rewrite rule from an e-hypergraph we also modify this e-hypergraph's interfaces.
% Consider a hypothetical DPO square below in Figure~\ref{fig:interface_change_example} where long arrows denote matching between carriers of cospans.

% The first row of the diagram shows the span for a rewrite rule of $\langle f + g, f \rangle$ which is like a projection rule.
% Note once again the difference between the interfaces of the left-hand and right-hand sides of the rewrite rule.
% The entry in the middle of the span depicts the outermost interfaces which are preserved.
% The second row depicts the e-hypergraph to be rewritten on the left and the result of the rewrite on the right.
% The result is obtained by first deleting the image of the left-hand side of the rewrite rule from the initial e-hypergraph (depicted in the middle) and then gluing the right-hand side of the rewrite rule into it. 
% Note that the interfaces of the initial e-hypergraph and the residual e-hypergraph are different. 
% Here, the outermost and the whole interfaces for the eventual e-hypergraph coincide, but if the nested-ness of the initial e-hypergraph was more intense the result could have inner interfaces as well as we would remove the interfaces of the inner edges when deleting the image of the left-hand side part of the rule from the initial e-hypergraph.

To account for such changes in the interfaces, consider additional structure on DPOI rewriting for $\catname{EHyp({\Sigma})}$, summarised in the definition below.
\begin{definition}[Extended DPOI (EDPOI) rewriting]
\label{def:dpoi-e}
Given a span of morphisms 
\[
    \mathcal{G} \xleftarrow{} n' + k' \xleftarrow{} n + k \xrightarrow{} n'' + k'' \xrightarrow{} \mathcal{H}
\]
in $\catname{EHyp(\Sigma)}$, we say $\mathcal{G}$ \textit{rewrites to} $\mathcal{H}$ \textit{with external interface} $n + k$ \textit{via a rewrite rule} 
\[
    \mathcal{L} \xleftarrow{} i' + j' \xleftarrow{} i + j \xrightarrow{} i'' + j'' \xrightarrow{} \mathcal{R}
\]
if there exists an object $\mathcal{C}$ and morphisms which complete the following commutative diagram such that the two marked squares are pushouts.
% \[\begin{tikzcd}
% 	&&&& {i + j} \\
% 	{l_i+l_o} && L &&&& R && {r_i+r_o} \\
% 	\\
% 	{g_i+g_o} && {G^{\urcorner}} && C && {^{\ulcorner}H} && {h_i+h_o} \\
% 	\\
% 	&&&& {n+m}
% 	\arrow[color={rgb,255:red,214;green,92;blue,92}, from=1-5, to=2-3]
% 	\arrow[color={rgb,255:red,214;green,92;blue,92}, from=1-5, to=2-7]
% 	\arrow["m", color={rgb,255:red,214;green,92;blue,92}, from=2-3, to=4-3]
% 	\arrow["{[i_c,j_c]}", color={rgb,255:red,214;green,92;blue,92}, from=1-5, to=4-5]
% 	\arrow[color={rgb,255:red,214;green,92;blue,92}, from=2-7, to=4-7]
% 	\arrow["{[n_c,m_c]}"', color={rgb,255:red,214;green,92;blue,92}, from=6-5, to=4-5]
% 	\arrow[color={rgb,255:red,214;green,92;blue,92}, from=4-5, to=4-7]
% 	\arrow[color={rgb,255:red,214;green,92;blue,92}, from=4-5, to=4-3]
% 	\arrow[color={rgb,255:red,214;green,92;blue,92}, from=6-5, to=4-3]
% 	\arrow[color={rgb,255:red,214;green,92;blue,92}, from=6-5, to=4-7]
% 	\arrow[from=2-1, to=2-3]
% 	\arrow["{[f_i,f_o]}", from=2-1, to=4-1]
% 	\arrow[from=4-1, to=4-3]
% 	\arrow[from=2-9, to=2-7]
% 	\arrow[from=4-9, to=4-7]
% 	\arrow["{[h_i,h_o]}"{description}, from=2-9, to=4-9]
% 	\arrow[from=6-5, to=4-9]
% 	\arrow[from=6-5, to=4-1]
% 	\arrow["{[i_l,j_l]}"{description}, from=1-5, to=2-1]
% 	\arrow["{[i_r,j_r]}"{description}, from=1-5, to=2-9]
% \end{tikzcd}\]


% https://q.uiver.app/#q=WzAsMTEsWzIsMCwiTCJdLFs0LDAsInhfe2V4dH0gKyB5X3tleHR9Il0sWzIsMiwiR157XFx1cmNvcm5lcn0iXSxbNCwyLCJDIl0sWzQsNCwibl97ZXh0fSttX3tleHR9Il0sWzAsMCwibF9pK2xfbyJdLFswLDIsImdfaStnX28iXSxbNiwwLCJSIl0sWzYsMiwiXntcXHVsY29ybmVyfUgiXSxbOCwyLCJoX2kraF9vIl0sWzgsMCwicl9pK3JfbyJdLFsxLDAsIiIsMCx7ImNvbG91ciI6WzAsNjAsNjBdfV0sWzAsMiwibSIsMCx7ImNvbG91ciI6WzAsNjAsNjBdfSxbMCw2MCw2MCwxXV0sWzEsMywiW2lfYyxqX2NdIiwwLHsiY29sb3VyIjpbMCw2MCw2MF19LFswLDYwLDYwLDFdXSxbNCwzLCJbbl9jLG1fY10iLDIseyJjb2xvdXIiOlswLDYwLDYwXX0sWzAsNjAsNjAsMV1dLFszLDIsIiIsMix7ImNvbG91ciI6WzAsNjAsNjBdfV0sWzQsMiwiIiwyLHsiY29sb3VyIjpbMCw2MCw2MF19XSxbNSwwXSxbNiwyXSxbNCw4LCIiLDAseyJjb2xvdXIiOlswLDYwLDYwXX1dLFszLDgsIiIsMCx7ImNvbG91ciI6WzAsNjAsNjBdfV0sWzcsOCwiIiwyLHsiY29sb3VyIjpbMCw2MCw2MF19XSxbMSw3LCIiLDIseyJjb2xvdXIiOlswLDYwLDYwXX1dLFsxMCw3XSxbOSw4XV0=
\[
 \scalebox{0.75}{
    \tikzfig{combinatorial_semantics/DPOI_square}
 }
\]
\end{definition}
To guarantee that the rewriting yields a monogamous directed acyclic e-hypergraph boundary complement also requires a revised definition.

\begin{definition}[Boundary complement in $\WellTypedMdaEcospans$]
\label{def:boundary_new}

% https://q.uiver.app/#q=WzAsNyxbMiwwLCJMIl0sWzQsMCwieF97ZXh0fSArIHlfe2V4dH0iXSxbMiwyLCJHXntcXHVyY29ybmVyfSJdLFs0LDIsIkMiXSxbNCw0LCJuX3tleHR9K21fe2V4dH0iXSxbMCwwLCJsX2krbF9vIl0sWzAsMiwiZ19pK2dfbyJdLFsxLDAsIiIsMCx7ImNvbG91ciI6WzAsNjAsNjBdfV0sWzAsMiwibSIsMCx7ImNvbG91ciI6WzAsNjAsNjBdfSxbMCw2MCw2MCwxXV0sWzEsMywiW2lfYyxqX2NdIiwwLHsiY29sb3VyIjpbMCw2MCw2MF19LFswLDYwLDYwLDFdXSxbNCwzLCJbbl9jLG1fY10iLDIseyJjb2xvdXIiOlswLDYwLDYwXX0sWzAsNjAsNjAsMV1dLFszLDIsIiIsMix7ImNvbG91ciI6WzAsNjAsNjBdfV0sWzQsMiwiIiwyLHsiY29sb3VyIjpbMCw2MCw2MF19XSxbNSwwXSxbNiwyXV0=

For monogamous extended cospans 
\[
    i \xrightarrow{} i' \xrightarrow{} \mathcal{L} \xleftarrow{} j' \xleftarrow{} j
\quad\text{ and }\quad
    n \xrightarrow{} n' \xrightarrow{} \mathcal{G} \xleftarrow{} k' \xleftarrow{} k
\] and mono $f : \mathcal{L} \to \mathcal{G}$, a pushout complement 
\[
    i + j \to \mathcal{L}^{\bot} \to \mathcal{G}
\] 
as depicted in the square below
\[
\scalebox{0.75}{

    \tikzfig{combinatorial_semantics/DPOI_pushout_complement}
}
\]

is a \textit{boundary} complement if the following holds
\begin{enumerate}
    \item $[c_1,c_2]$ is mono 
    \item there exist $d_1 : n \to \mathcal{C}$ and $d_2 : k \to \mathcal{C}$ making the above triangle commute
    \item there exists a \textit{not necessarily well-typed} mda-cospan
    \[
    n \xrightarrow{} l + j \xrightarrow{[g_1,c_2]} \mathcal{L}^{\bot} \xleftarrow{[g_2,c_1]} r + i \xleftarrow{} k
    \]
\end{enumerate}

where $l$ and $r$ are
\[
    l = n' \setminus (i' \setminus i)
\quad\text{ and }\quad
    r = k' \setminus (j' \setminus j).
\]
Because $\mathcal{L}^{\bot}$ is essentially $\mathcal{G}$ with $\mathcal{L}$ removed, apart from the part that has a pre-image in $i + j$, there is an obvious morphism from $l \to \mathcal{L}^{\bot}$ which is $g_1 = g_{int} |_{D}$ where
\[
    D = \{ v \in n' \text{ such that } \not \exists u \in (i' \setminus i) ~ . ~ g_{int}(v) = f'_{int};f(u) \}
\]
Similarly for $r \to \mathcal{L}^{\bot}$, which we denote as $g_2$.
Then there exists a morphism $n \to l$, because there is a morphism $n \to n'$ and the external interfaces of $n'$ and $l$ are the same.
That is, it is a morphism $f: n \to l$ such that $d_1 = f;g_1$.
Similarly for $k \to r$.
\end{definition}

The notion of a boundary complement above is essentially the same as the one from Section~\ref{sec:combinatorial-semantics}.
The only difference is that we account for internal interfaces to require monogamous-ness and these interfaces must be computed explicitly to define the monogamous cospan.
%
%\begin{figure}
%    \centering
%    \[
%    \scalebox{0.5}{\tikzfig{combinatorial_semantics/interfaces_change_example}}\]
%    \caption{Hypothetical DPO square for $\catname{MACsp_{D}(EHyp_{\Sigma})}$}
%    \label{fig:interface_change_example}
%\end{figure}

% The second point above means that when cutting the mono-occurrence of $L$ out from $G$ we also need to remove the inner interfaces of $L$ from the whole interface of $G$. \question{According to the pushout squares above, $c_i$ is constructed by removing from $g_i$ everything from $l_i$ which does not have a pre-image in $i$, i.e., everything except the outermost interfaces (same holds for $c_o$)}

\begin{remark}
Note that cospan 
\[
    n \xrightarrow{} l + j \xrightarrow{} C \xleftarrow{} r + i \xleftarrow{} k
\] is not necessarily well-typed.
The cospan's input internal interface may contain nodes that previously were a part of the output internal interface and similarly for output internal interface.
\end{remark}

\begin{remark}
The uniqueness and existence properties of boundary complements as defined above are discussed in the appendix (Proposition~\ref{prop:boundary_complement} and Proposition~\ref{prop:complement_existence}).
\end{remark}


% \begin{proposition}[Proposition~\ref{prop:boundary_complement} restatement]
%     The boundary complement in~\ref{def:boundary_new} when exists is unique.
% \end{proposition}

\begin{definition}[Subgraph]

A \textit{subgraph} of an e-hypergraph 
\[
    \mathcal{G} = \{V_{\mathcal{G}}, E_{\mathcal{G}}, s_{\mathcal{G}}, t_{\mathcal{G}}, l, <_{G},\consistency_{\mathcal{G}}\}
\]
is an e-hypergraph 
\[
    \mathcal{H} = \{V_{\mathcal{H}}, E_{\mathcal{H}}, s_{\mathcal{H}}, t_{\mathcal{H}}, l, <_{H},\consistency_{\mathcal{H}}\}
\] such that $V_{\mathcal{H}} \subseteq V_{\mathcal{G}}$, $E_{\mathcal{H}} \subseteq E_{\mathcal{G}}$ and such that $<_{\mathcal{H}}$ and $\consistency_{\mathcal{H}}$ both satisfy the properties from~\ref{def:e-homo}.
\end{definition}

\begin{definition}[Down-closed subgraph]
    We call a subgraph $\mathcal{H}$ of an e-hypergraph $\mathcal{G}$ \emph{down-closed} if for all $e \in E_{\mathcal{H}}$,   all children of $r$ are also in $\mathcal{H}$.
\end{definition}    

\begin{definition}[Convex down-closed match] 
    We call $m : L \to G$ in $\catname{EHyp(\Sigma)}$ a \textit{convex down-closed match} if
    
    \begin{enumerate}
        \item $m$ is a monomorphism
        \item $m(L)$ is a convex down-closed subgraph of $G$
        \item $[m(v_i)) = [m(v_j))$ for all $v_i,v_j$ that have a pre-image in $V_{Z}$.
        \item $\consistency^{\mu}(m(v_i)) = \consistency^{\mu}(m(v_j))$ for all $v_i,v_j$ that have a pre-image in $V_{Z}$.
    \end{enumerate}
\end{definition}

The conditions (3)-(4), in particular, prohibit a match $\{f \mapsto f, g \mapsto g\}$ in $\mathcal{L} =$ $\scalebox{0.4}{\tikzfig{combinatorial_semantics/f_times_g}}$ and $\mathcal{G} =$ $\scalebox{0.4}{\tikzfig{combinatorial_semantics/f_plus_g_inline}}$.

We are now ready to define the \textit{convex} rewriting for e-hypergraphs with interfaces which we will later use to show the equivalence between $\textsf{PROP}(\Sigma)$ and $\WellTypedMdaEcospans$.
It will be analogous to the one from Definition~\ref{def:convex_dpo} but again, to make sure the resulting cospan of e-hypergraphs is monogamous we will have to construct internal interfaces separately.
We will also limit matches to convex down-closed ones both to guarantee an mda result and so that the result is a well-defined e-hypergraph.

\begin{definition}[Convex EDPOI rewriting]
    Let $\mathfrak{R}$ be a set of EDPOI rewrite rules.
    Then, given 
    \[
        \mathcal{G} \xleftarrow{} n' + k' \xleftarrow{} n + k
    \quad 
    \text{and} 
    \quad
        \mathcal{H} \xleftarrow{} n'' + k'' \xleftarrow{} n + k
    \] in $\catname{EHyp(\Sigma)}$ with the external interfaces $n + k$, $\mathcal{G}$ \textit{rewrites convexly into} $\mathcal{H}$ \textit{with the outermost interface} $n + k$ --- notation $( \mathcal{G} \xleftarrow{} n + k) \Rrightarrow_{\mathfrak{R}}^{+} (\mathcal{H} \xleftarrow{} n + k)$ --- if there exists a rule 
    \[
        \mathcal{L} \xleftarrow{} i' + j' \xleftarrow{} i + j \xrightarrow{} i'' + j'' \xrightarrow{} \mathcal{R}
    \] 
    with the external interfaces $i + j$ in $\mathfrak{R}$ and object $\mathcal{C}$ and cospan arrows $i + j \xrightarrow{} \mathcal{C} \xleftarrow{} n + k$ 
    such that the diagram of Definition~\ref{def:dpoi-e} commutes and its marked squares are pushouts, and the following conditions hold

    \begin{enumerate}
        \label{dpoi-e:assumptions}
        \item $m : \mathcal{L} \to \mathcal{G}$ is a convex down-closed match;
        \item $i + j \to \mathcal{C} \to \mathcal{G}$ is a boundary complement in the leftmost pushout.
    \end{enumerate}
\end{definition}
and
% The internal interfaces of the resulting e-hypergraph $\mathcal{H}$ from the cospan
%  \[
%     \mathcal{H} \xleftarrow{} n'' + k'' \xleftarrow{} n + k
% \]
\begin{align*}
&n'' = (i'' \setminus i) + l\\
&k'' = (j'' \setminus j) + r\\
&n'' \to \mathcal{H} = [f_1,f_2] \text{ where }\\
&f_1 : i'' \setminus i \to \mathcal{R} \to \mathcal{H}\\ 
&f_2 : l \to \mathcal{C} \to \mathcal{H} 
\end{align*}
Since both $f_1$ and $f_2$ are monos, their copairing is also a mono. 
Similarly for $k'' \to \mathcal{H}$.

\begin{proposition}
    $n \xrightarrow{} n'' \xrightarrow{} \mathcal{H} \xleftarrow{} k'' \xleftarrow{} k$ is a well-typed mda-cospan.
\end{proposition}
    

Above we defined rewriting for cospans with empty input interfaces, when we will further build a correspondence between $\textsf{PROP}(\Sigma)^{+}$ and $\WellTypedMdaEcospans$ we will operate with cospans with non-empty input interfaces as well, so below we formulate what it means to rewrite cospans with non-empty input interfaces.

\begin{definition}[Convex EDPOI in $\WellTypedMdaEcospans$]
    
We say that an \textit{mda-cospan}
\[
    n \xrightarrow{} n' \xrightarrow{} \mathcal{G} \xleftarrow{} k' \xleftarrow{} k
\]
\textit{rewrites convexly into another mda-cospan}

\[
    n \xrightarrow{} n'' \xrightarrow{} \mathcal{H} \xleftarrow{} k'' \xleftarrow{} k
\]

under a rewrite rule 
% \[
%     \langle x_{ext} \xrightarrow{a_1} l_{i} \xrightarrow{a_2} L \xleftarrow{b_2} l_{o} \xleftarrow{b_1} y_{ext}, 
%     x_{ext} \xrightarrow{a_1} r_{i} \xrightarrow{a_2} R \xleftarrow{b_2} r_{o} \xleftarrow{b_1} y_{ext} \rangle
% \]

\[\mathcal{L} \xleftarrow{} i' + j' \xleftarrow{} i + j \xrightarrow{} i'' + j'' \xrightarrow{} \mathcal{R}\]

if 
\begin{align*}    
    \mathcal{G} \xleftarrow{} n + k \Rrightarrow^{+} \mathcal{H} \xleftarrow{} n + k
\end{align*}
under the same rewrite rule.
We will use the same $\Rrightarrow^{+}$ and the concrete definition will be clear from the context.

\end{definition}

\begin{remark}
There is a minor limitation for EDPOI rewriting above in that it is unable to express rewriting
for rules that contain an edge with no inputs and outputs on their right-hand side (such edges correspond to morphisms of type $0 \to 0$).
This is because there is no way to impose both consistency and child relation of such an edge as it has no incident nodes in its context.
We claim that this is only a minor limitation because in practice such edges (morphisms) with no
incident nodes correspond to ‘scalars’, if we consider for example a category of vector spaces, and scalars are usually removed by being absorbed by vectors rather than introduced during rewrites.
\end{remark}

\section{Soundness and Completeness}\label{sec:soundness-and-completeness}

CHRIS: INTRO. 

\begin{figure}
    \[
    \scalebox{0.55}{
    \tikzfig{combinatorial_semantics/f_plus_g_new}
    }
    \]
    \caption{$+$ of two morphisms in $\Ecospans$}
    \label{fig:A+B}
\end{figure}


Recall from Section \ref{sec:e-hypergraphs} that $ \WellTypedMdaEcospans$ has a symmetric monoidal structure inherited from the coproduct structure of $\textbf{EHypI}(\Sigma)$.  
Recall further that typed $\Sigma^+$-terms are those categorical combinator terms freely constructed from generators $c \in \Sigma$, $\textsf{id}_1$, $\sigma_{1,1}$, $(;\!)$ and $\otimes$,  and $f+g$.  We will write $\Sigma^+(n,m)$ for the set of $\Sigma^+$-terms of type $n \to m$.  

We wish to specify a set of DPOI rewrite rules corresponding to those in Figure \ref{fig:string-equations}.  In order to do this,  we specify a function which maps  uninterpreted $\Sigma^+$-terms into $\WellTypedMdaEcospans$ morphisms,  and which also extends the expected interpretation of terms in $\WellTypedMdaEcospans$ (as given by the free functor from $\textbf{PROP}(\Sigma)$ induced by the interpretation of $\Sigma$ as itself,  detailed in \cite{bonchi_string_2022-2}). 
\begin{definition}[Interpretation function] 
%Let $\llbracket - \rrbracket: \textbf{PROP}(\Sigma) \to \WellTypedMdaEcospans$ be the unique SMC-functor induced by the interpretation sending $\Sigma$ to itself.  
Let $\llbracket - \rrbracket_{n,m}: \Sigma^+(n,m) \to \WellTypedMdaEcospans(n,m)$ be the function defined by induction on the type derivation of $\Sigma$-terms by 
\begin{align*}
	\llbracket \id \rrbracket_{n,m} &= \id  &	\llbracket \phi ; \psi \rrbracket_{n,m} &= \llbracket \phi \rrbracket_{n,m} ; \llbracket \psi \rrbracket_{n,m} \\
	\llbracket 1 \rrbracket_{n,m} &= 1 & \llbracket f \otimes g \rrbracket_{n,m} &= \llbracket f \rrbracket^+_{n,m} \otimes \llbracket g \rrbracket_{n,m} \\
	\llbracket \sym \rrbracket_{n,m} &= \sym  & \llbracket c \rrbracket_{n,m} &= c   \\ 
	\llbracket f+g \rrbracket_{n,m} &= \llbracket f \rrbracket_{n,m} + \llbracket g \rrbracket^+_{n,m}
\end{align*}
where $c \in \Sigma$ and $+$ in $\WellTypedMdaEcospans$ is defined by Figure \ref{fig:A+B}.  We will omit the subscripts in $\llbracket - \rrbracket_{n,m}$ where it is clear from context. 
\end{definition}

Let the function $\llbracket - \rrbracket$ extend in the obvious way to apply to equations (\textit{i.e.}, pairs of $\Sigma^+$-terms). 
% \update{below definition depends on whether we require the homomorphism to reflect the conflicts}
CHRIS: COMMENT THAT WE QUOTIENT TO PHRASE CATEGORICALLY OUR RESULTS. 
\begin{definition}[Quotient by rewrites]  
Given a set of equations $\mathcal{E}$,  we denote by $\WellTypedMdaEcospans/\mathcal{E}$ the category $\WellTypedMdaEcospans$ quotiented by the following relation. 
\[
	f \sim g \quad \text{if} \quad f \Rrightarrow^{+,*}_{\llbracket \mathcal E \rrbracket} g ~ . 
\]
\end{definition}
In particular,  let $\mathcal{S}$ be the set equations of Figure \ref{fig:string-equations},  \textit{i.e.},  the semilattice equations over $\Sigma^+$-terms. 
This quotient in fact turns the interpretation function into a proper functor $\llbracket - \rrbracket: \textbf{PROP}^+(\Sigma) \to \WellTypedMdaEcospans/{\mathcal{S}}$,  which can further be quotiented to account for extra equations $\mathcal E$ arising in symmetric monoidal theories,  as below. 
\[
	\llbracket - \rrbracket_{\mathcal E}: \textbf{SMT}^+(\Sigma, \mathcal E) \to \WellTypedMdaEcospans/{\mathcal{S,E}}
\]

Note that not all pushouts (or pushout complements) in $\textbf{MEHypI}(\Sigma)$ are guaranteed to exist: however,  pushouts (and pushout complements) for rewrites generated from $\Sigma$-equations and those generated from the semilattice equations on $\Sigma^+$-terms do exist.  
%Let $\mathcal E$ be an arbitrary set of $\Sigma$-equations. 
Thus we have the following result. 
\begin{proposition}[Soundness]
\label{prop:soundness}
The category $\WellTypedMdaEcospans/{\mathcal{S}}$ is a semilattice-enriched PROP. 
\end{proposition}
It immediately follows that $\WellTypedMdaEcospans/{\mathcal{S,E}}$ is a semilattice-enriched PROP,  and $\llbracket - \rrbracket_{\mathcal E}$ is the free semilattice-enriched functor from $\textbf{SMT}^+(\Sigma, \mathcal E)$ induced by the interpretation of $\Sigma$ as itself. 
Note that the symmetric monoidal equations are absorbed in the hypergraph representation,  but the semilattice equations are covered by the fact we have quotiented our representation by certain rewrites. 

CHRIS: NOTE ALSO WEAK NORMAL FORM FOR $\Sigma^+$-TERMS?
The equations of Figure~\ref{fig:string-equations} -- excepting the commutativity equation -- can all be directed in an obvious way to form a terminating rewrite system,  which results in a cospan in \textit{weak normal form}. 
\begin{proposition}[Weak normal form]
\label{prop:wnormal_form}
For each cospan $f$ in ${\WellTypedMdaEcospans}/{\mathcal{S}}$ there is a \textit{weak normal form} such that 
\[
	f = f_1 + \ldots + f_n
\]
 such that each $f_i$ contains no hierarchical edges,  and for all $i \neq j$ we have $f_i \neq f_j$.
\end{proposition}    

This normal form can be used to prove the main theorem of the paper: the (full) completeness of our combinatorial representation of $\textbf{SMT}^{+}(\Sigma, \mathcal {E} )$. 
\begin{theorem}[Completeness]
We have the following equivalence of categories
\[
	\textbf{SMT}^{+}(\Sigma, \mathcal {E} ) \cong \WellTypedMdaEcospans / \mathcal{S,E}~.
\]
\end{theorem}
\begin{proof}
The equivalence is given by the functor $\llbracket - \rrbracket$.  First, note that the functor is surjective on objects,  so it suffices to prove the functor is both full and faithful.  In each case,  the result follows by a normal form argument in combination with relying on the equivalence $(*)$ $\textbf{SMT}(\Sigma, \mathcal E) \cong \textbf{MHypI}(\Sigma)/\mathcal{E}$ of symmetric monoidal theories and (appropriately quotiented) plain MDA cospans which is given by the restriction of $\llbracket - \rrbracket$ to $\textbf{SMT}(\Sigma, \mathcal E)$ as a subcategory of $\textbf{SMT}^{+}(\Sigma, \mathcal {E} )$ (note that cospans embed in extended cospans when the internal interface is isomorphic to the external interface); see Theorem 35 of ~\cite{bonchi_string_2022-2}.  

To see that the functor is faithful,  we prove that $f \neq g$ in $\textbf{SMT}^+(\Sigma, \mathcal E)$ implies $\llbracket f \rrbracket \neq \llbracket g \rrbracket$.  First,  calculate weak normal form $\Sigma^+$-terms of $f$ and $g$ as $f_1 + \ldots + f_n$ and $g_1 + \ldots + g_m$,  respectively.  Applying the functor $\llbracket - \rrbracket$,  we see that 
\begin{align*}
	\llbracket f \rrbracket &= \llbracket f_1 + \ldots + f_n \rrbracket &&= \llbracket f_1 \rrbracket + \ldots + \llbracket f_n \rrbracket \\
	\llbracket g \rrbracket &= \llbracket g_1 + \ldots + g_m \rrbracket &&= \llbracket g_1 \rrbracket + \ldots + \llbracket g_m \rrbracket ~ . 
\end{align*}
In particular,  note that $\llbracket - \rrbracket$ preserves weak normal forms.  Therefore $\llbracket f_1 \rrbracket + \ldots + \llbracket f_n \rrbracket$ and $\llbracket g_1 \rrbracket + \ldots + \llbracket g_m \rrbracket$ are weak normal forms.  Thus if $n \neq m$ we have that $\llbracket f \rrbracket \neq \llbracket g \rrbracket $.  Otherwise,  if $n = m$,  we have that there for every permutation $\sigma$ there exists an index $i$ such that $f_i \neq g_{\sigma(i)}$,  and thus by $(*)$ that $\llbracket f_i \rrbracket \neq \llbracket g_{\sigma(i)} \rrbracket $.  This implies that $\llbracket f \rrbracket \neq \llbracket g \rrbracket $. 

To see that the functor is full,  consider a cospan $f$ in $\WellTypedMdaEcospans$.  We can find an equivalent weak normal form $f_1 + \ldots + f_n$,  where each $f_i$ is a plain MDA cospan.  Thus,  by $(*)$ we can find morphisms $g_i$ such that $\llbracket g_i \rrbracket = f_i$.  Thus,  we have a morphism $g_1 + \ldots + g_n$ such that $\llbracket g_1 + \ldots + g_n \rrbracket = \llbracket g_1 \rrbracket + \ldots \llbracket g_n \rrbracket = f_1 + \ldots + f_n$,  as required. 
\end{proof}

Unfolding the definitions,  we can spell out the previous theorem in terms of DPO-rewriting. 
\begin{corollary}[Completeness of rewriting]
For any $f, g \in \textbf{SMT}^{+}(\Sigma, \mathcal{E})$,  we have
\[
	f = g \quad \iff \quad \llbracket f \rrbracket \Rrightarrow^{+,*}_{\mathcal{S}, \mathcal{E}} \llbracket g \rrbracket~ . 
\]
 \end{corollary}
%
%\begin{theorem}[Theorem 35~\cite{bonchi_string_2022-2}]
%
%    $a \Rightarrow_{R} b$ iff $\llangle {}^{\ulcorner} a {}^{\urcorner} \rrangle \Rrightarrow_{\llangle {}^\ulcorner R {}^\urcorner \rrangle} \llangle {}^{\ulcorner}b {}^{\urcorner} \rrangle$.
%    Where $\llangle \cdot \rrangle : \textsf{PROP}(\Sigma) + \textsf{Frob} \to \catname{Csp_{D}(Hyp_{\Sigma})}$ and $\Rrightarrow$ is a convex rewriting relation for morphisms in $\catname{Hyp_{\Sigma}}$.
%\end{theorem}
%
%\begin{proposition}
%    $\llangle {}^{\ulcorner} a {}^{\urcorner} \rrangle \Rrightarrow_{\llangle {}^\ulcorner R {}^\urcorner \rrangle} \llangle {}^{\ulcorner}b {}^{\urcorner} \rrangle$ iff $[\mathcal{J}(a)] \Rrightarrow_{[R]}^{+} [\mathcal{J}(b)]$.
%     Note that $a$ and $b$ are from $\textsf{PROP}(\Sigma)$.
%\end{proposition}
%
%\begin{theorem}
%    $a \Rightarrow_{\langle l, r \rangle}^{+} b$ in $\textsf{PROP}^{+}$ iff $[a] \Rrightarrow_{\langle [l],[r] \rangle} [b]$ in $\sfrac{\WellTypedMdaEcospans}{\mathcal{S}}$.
%\end{theorem}
CHRIS: CONCLUDING STATEMENT.  COMMENT ABOUT GENERALIZATION TO DIRECTED REWRITES. 

\section{Conclusion}

We have seen how e-graphs over algebraic theories can be expressed in terms of Cartesian categories enriched over a semilattice. 
In fact, e-graphs are an instance of a more general construction that can account for monoidal theories in terms of SMCs,  similarly enriched.  
Having described a translation of e-graphs into this categorical framework, a combinatorial representation of morphisms in the free category is also provided. 
As expected, this representation factors out the structural SMC equations, while remaining sensitive to the complexity-relevant equations induced by the enrichment.  The design of such a representation and its corresponding rewrite theory proved to be delicate, and, together with its proof of completeness, constitute the main technical contributions of the paper.  

In the future,  we intend to investigate a number of natural extensions to mathematical treatment of (acyclic) e-graphs developed here.
Some of these are: support for `functorial boxes'~\cite{mellies} (in addition to e-boxes), which have a variety of applications, including the Cartesian-closure required for the implementation of functional programming languages~\cite{GhicaZanasiTutorial}, as sketched in Fig. \ref{fig:app1}~(a); the `spiders' used by the ZX-calculus to model quantum circuits~\cite{coecke_interacting_2011,ZX}, as sketched in Fig. \ref{fig:app1}~(b); and  traces~\cite{Joyal, Hasegawa},  which can be used to express feedback in categorical models of digital circuits~\cite{GhicaJung, GhicaKaye},  and, indeed cycles in conventional e-graphs to encode infinite equivalence classes, as sketched in Fig.~\ref{fig:app2}. All these application domains stand to benefit from the use of optimisation techniques, which in turn can take advantage of the appropriate e-graph technique.  

\begin{figure}
\[
	\scalebox{0.75}{
	\tikzfig{conclusion/example-e-graphs}
	}
\]
\caption{E-graphs for functorial boxes and the ZX-calculus
DAN: THE LINE BETWEEN THE APPLICATION NODE AND THE BOX IS TOO LONG}
\label{fig:app1} 
\end{figure}
\begin{figure}
\[
	\scalebox{0.75}{
	\tikzfig{conclusion/example-traced}
	}
\]
\caption{E-graphs with cycles and e-hypergraphs with trace}
\label{fig:app2}
\end{figure}

In each case above,  we aim to combine our combinatorial representation with existing combinatorial representations of the relevant structure.  Indeed,  the hypergraph representation and DPO-rewriting theory of each case is already well-studied independently of any e-graph structure \cite{ghica_rewriting_2023,cite,cite,cite}. % traced comonoid
%The hierarchical ``e-box'' structure within string diagrams and their associated e-hypergraphs (categorically modelled by semilattice enrichment) is essentially orthogonal to these developments. Combining the two, to give notions of e-hypergraphs specifically suited to these particular monoidal theories should be conceptually straightforward.  However, as we have seen in this paper, the technical details can be delicate. 
Finally,  a term calculus (e-terms) can be reverse engineered from the string-diagram notation~\cite{ghica_structural_nominal}. Although term calculi are less important in the algorithmics of optimisation, they still play a role in specification and in aiding readability.  

\bibliographystyle{acm}
\bibliography{bibliography}

\appendix

\section{Proofs for Section \ref{sec:combinatorial-semantics}: Combinatorial Semantics}

\subsection{Proof of the existence of pushouts}

\begin{remark}
    Both $<$ and $\consistency$ can be considered as functions defined on $V_{\mathcal{F}} + E_{\mathcal{F}}$, i.e. on the coproduct of nodes and edges.
    To make things well-typed, we will use corresponding coproduct injections $\iota_{V} : {V_{\mathcal{F}}} \to V_{\mathcal{F}} + E_{\mathcal{F}}$ and $\iota_{E} : {E_{\mathcal{F}}} \to V_{\mathcal{F}} + E_{\mathcal{F}}$ when passing either node or edge into these functions.
    For example, an immediate successor of a node $x$ can be written functionally as $<_{\mathcal{F}}^{\mu}(\iota_{V_{\mathcal{F}}}(x))$.
\end{remark}

\begin{remark}
    Using functional notation we can reformulate the notion of a homomorphism between two e-hypergraphs in the following way.
    \begin{definition}
        \label{def:e-homo-2}    
        A \emph{homomorphism} $\phi: \mathcal{F} \to \mathcal{G}$ of e-hypergraphs $\mathcal{F},\mathcal{G}$ is a pair of functions $\phi_V : V_{\mathcal{F}} \to V_{\mathcal{G}}, \phi_E : E_{\mathcal{F}} \to E_{\mathcal{G}}$ such that
        
        \begin{enumerate}
            \item $\phi$ is hypergraph homomorphism
            
            \item When $[x) \not = \varnothing$, \[
                \phi_{E}(<_{\mathcal{F}}^{\mu}(\iota_{V_{\mathcal{F}}}(x))) = <_{\mathcal{G}}^{\mu}(\phi_{V};\iota_{V_{\mathcal{G}}}(x))
                \] when $x$ is a node,
                and
                \[
                \phi_{E}(<_{\mathcal{F}}^{\mu}(\iota_{E_{\mathcal{F}}}(x))) = <_{\mathcal{G}}^{\mu}(\phi_{E};\iota_{E_{\mathcal{G}}}(x))  
                \] when $x$ is an edge.          
                \item
            When $x \in E_{\mathcal{F}}$
            \[
                [\phi_{V};\iota_{V_{\mathcal{G}}}, \phi_{E};\iota_{E_{\mathcal{G}}} ]^{*}(\consistency_{\mathcal{F}}(\iota_{E_{\mathcal{F}}}(x)))
                \subseteq
                \consistency_{\mathcal{G}}(\phi_{E};\iota_{E_{\mathcal{G}}}(x))
            \]
            , where $\phi_{V};\iota_{V_{\mathcal{G}}} : V_{\mathcal{F}} \to V_{\mathcal{G}} + E_{\mathcal{G}}$, and similarly for $\phi_{E};\iota_{E_\mathcal{G}}$ so that $[\phi_{V};i_{V_{\mathcal{G}}}, \phi_{E};i_{E_{\mathcal{G}}}] : V_{\mathcal{F}} + E_{\mathcal{F}} \to  V_{\mathcal{G}} + E_{\mathcal{G}}$.
            And, when $x \in V_{\mathcal{F}}$
            \[
                [\phi_{V};\iota_{V_{\mathcal{G}}}, \phi_{E};\iota_{E_{\mathcal{G}}}]^{*}(\consistency_{\mathcal{F}}(\iota_{V_{\mathcal{F}}}(x)))
                \subseteq
                \consistency_{\mathcal{G}}(\phi_{V};\iota_{V_{\mathcal{G}}}(x))
            \]
            \end{enumerate}
    \end{definition}
\end{remark}

\begin{theorem}[Existence of pushouts in $\catname{EHyp_{\Sigma}}$]
\label{th:existence_of_pushouts}
Consider the following span in $\catname{EHyp_{\Sigma}}$
% https://q.uiver.app/#q=WzAsMyxbMCwwLCJaIl0sWzIsMCwiWCJdLFswLDIsIlkiXSxbMCwxLCJmIl0sWzAsMiwiZyIsMl1d
\[\begin{tikzcd}
	Z && X \\
	\\
	Y
	\arrow["f", from=1-1, to=1-3]
	\arrow["g"', from=1-1, to=3-1]
\end{tikzcd}\]
such that
\begin{enumerate}
\label{pushout:assumptions}
    \item $Z$ is a \textit{discrete} e-hypergraph.
    \item $f,g$ are monos.
    \item $[f_{V}(v_i)) = [f_{V}(v_j))$ and $[g_{V}(v_i)) = [g_{V}(v_j))$ for all $v_{i},v_{j}$ in $V_{Z}$.
    \item If $[f_{V}(v)) \not = \varnothing$ then $[g_{V}(v)) = \varnothing$ and if $[g_{V}(v)) \not = \varnothing$ then $[f_{V}(v)) = \varnothing$.
    \item $\consistency^{\mu}(f(v_i)) = \consistency^{\mu}(f(v_j))$ and $\consistency^{\mu}(g(v_i)) = \consistency^{\mu}(g(v_j))$ for all $v_i,v_j$ in $V_{Z}$.
\end{enumerate}    
then the pushout $X +_{f,g} Y$ exists.
\end{theorem}
\begin{proof}
    Consider the diagram below.
    \[
        \begin{tikzcd}
        Z \arrow[r, "f"] \arrow[d, "g"']                                   & X \arrow[d, "\sfrac{\iota_1}{\sim R}"] \arrow[rdd, "j_1", bend left] &   \\
        Y \arrow[r, "\sfrac{\iota_2}{\sim R}"] \arrow[rrd, "j_2"', bend right] & \sfrac{X+Y}{\sim R} \arrow[rd, "u"]                              &   \\
                                                                        &                                                                  & Q
        \end{tikzcd}
    \]
    Then, the pushout of e-hypergraphs $X$ and $Y$ is computed in two steps.
    First, a coproduct of $X+Y$ is computed which is 
    \[
        X + Y = \{V_{X} + V_{Y}, E_{X} + E_{Y}, s_{X+Y}, t_{X+Y}, \consistency_{X+Y}, <_{c,X+Y} \}
    \]
    where $s_{X+Y} : E_{X} + E_{Y} \to (V_{X} + V_{Y})^{*}$ which can be defined as a copairing $[s'_{X}, s'_{Y}] : E_{X} + E_{Y} \to (V_{X} + V_{Y})^{*}$ and $s'_{X} : E_{X} \to (V_{X} + V_{Y})^{*}$, $s'_{Y} : E_{Y} \to (V_{X} + V_{Y})^{*}$ defined as $s'_{X} = s_{X};\iota_{1,V}^{*}$ and $s'_{Y} = s_{Y};\iota_{2,V}^{*}$ where $\iota_1,\iota_2$ are corresponding coproduct injections, similarly for $t_{X+Y}, <_{c,X+Y}, \consistency_{X+Y}$.
    We will omit labels as they are irrelevant to pushout construction.
    Consider relations
    \begin{align*}    
    S_{V} &= \{\\
          &(x_i,y_j) \in (V_{X} + V_{Y}) \times (V_{X} + V_{Y})\; | \\
          &\exists z \in V_{Z} \; . \; x_i = f_{V};\iota_{1,V}(z) \text{ and } y_j = g_{V};\iota_{2,V}(z)\\
          &\text{ where $x_i \in V_{X}$ and $y_j \in V_{Y}$ }\\
          &\}
    \end{align*}
    \begin{align*}
    S_{E} &= \{\\
    &(x_i,y_j) \in (E_{X} + E_{Y}) \times (E_{X} + E_{Y})\; |\\
    &\exists z \in E_{Z} \; . \; x_i = f_{E};\iota_{1,E}(z) \text{ and } y_j = g_{E};\iota_{2,E}(z)\\
    &\text{ where $x_i \in E_{X}$ and $y_j \in E_{Y}$}\\
    &\}
    \end{align*}
and let relations $R_{V}$ and $R_{E}$ be their reflexive symmetric and transitive closures respectively.



    We then quotient the sets of edges and nodes in $X + Y$ by $R_{V},R_{E}$
    \begin{align*}
        \sfrac{X + Y}{\sim (R_{V},R_{E})} = \{&\\
            &\sfrac{V_{X} + V_{Y}}{\sim R_{V}}, \sfrac{E_{X} + E_{Y}}{\sim R_{E}}, \sfrac{s_{X+Y}}{\sim (R_{V},R_{E})},\\
            &\sfrac{t_{X,Y}}{\sim (R_{V},R_{E})}, \#_{\sfrac{X+Y}{\sim (R_{V},R_{E})}}, <_{c,\sfrac{X + Y}{\sim (R_{V},R_{E})}}\\
        & \}    
    \end{align*}
    We will then refer to $\sim (R_{V},R_{E})$ just as $\sim$, i.e. writing $\sfrac{V_{X} + V_{Y}}{\sim}$ and the exact relation will be clear from the context.
We have 
\[
    \sfrac{s_{X+Y}}{\sim} : \sfrac{E_{X} + E_{Y}}{\sim} \to (\sfrac{V_{X} + V_{Y}}{\sim})^{*}
\]
and there is an obvious surjective function $[-]_{V} : (V_{X} + V_{Y}) \to (\sfrac{V_{X} + V_{Y}}{\sim})$ that maps elements to their equivalence classes and $[-]_{V}^{*}$ is its extension to sequences. 
We then define $s_2 : E_{X} + E_{Y} \to (\sfrac{V_{X} + V_{Y}}{\sim})^{*} = s_{X+Y};[-]^{*}$ and then $\sfrac{s_{X+Y}}{\sim}([e]) = s_{X+Y};[-]^{*}(e) = [s_{X+Y}(e)]^{*}$.
There is also $[-] : E_{X} + E_{Y} \to \sfrac{E_{X} + E_{Y}}{\sim}$ and we will omit subscripts as the correct type will be clear from the argument.
We will also use subscripts when it is important to tell if an element of $E_{X} + E_{Y}$ has a pre-image in either $E_{X}$ or $E_{Y}$ by writing $e_{x}$ or $e_{y}$.
Likewise, $t_{\sfrac{X+Y}{\sim}}([e]) = [t_{X+Y}(e)]^{*}$.

So far, the construction matches the construction of the pushout in $\catname{Hyp_{\Sigma}}$ which can be found in~\cite{bonchi_string_2022-1} and hence $s_{\sfrac{X+Y}{\sim}}$ and $t_{\sfrac{X+Y}{\sim}}$ are well-defined and $[-]$ is a homomorphism with respect to sources and targets.

Recall that $<$ is essentially a transitive clousure of $<^{\mu}$ and hence we can first define 
    \[<_{\sfrac{X+Y}{\sim}}^{\mu}(\iota_{\sfrac{E_{X} + E_{Y}}{\sim}}[u]_{E})
    \] and 
    \[
        <_{\sfrac{X+Y}{\sim}}^{\mu}(\iota_{\sfrac{V_{X} + V_{Y}}{\sim}}[u]_{V})
    \] where $i_*$ are injections into $\sfrac{V_{X} + V_{Y}}{\sim} + \sfrac{E_{X} + E_{Y}}{\sim}$.
    We will consider several cases.
    Assume that $u$ is an element of $V_{X+Y}$ and
    \begin{enumerate}
        % \item $u$ has a pre-image $z$ in $V_{Z}$, $[z) \not = \varnothing$.
        %       The last requirement means that there necessarily exist $x = <_{c,X}^{\mu}(f_{E}(z)) = f_{E}(<_{c,Z}^{\mu}(z))$ and $y = <_{c,Y}^{\mu}(g_{E}(z)) = g_{E}(<_{c,Z}^{\mu}(z))$.
        %       We then define $<_{c,\sfrac{X+Y}{\sim}}^{\mu}([u]) = [<_{c,X+Y}^{\mu}(u)]$
        \item $u$ has a pre-image $z$ in $V_{Z}$ (by discreteness, $[z) = \varnothing$) and $[f_{V}(z)) = \varnothing$ $[g_{V}(z)) \not = \varnothing$.
              The last condition means that there exists $e_y = <_{c,Y}^{\mu}(i_{V_{Y}}(g_{V}(z)))$.
              We then define 
              \[
                <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}[u]) = [g_{V};i_{V_{Y}};<_{c,Y}^{\mu};i_{2,E}(z)] = [i_{2,E}(e_y)]
              \]
        \item $u$ has a pre-image $z$ in $V_{Z}$, (by discreteness, $[z) = \varnothing$) and $[f_{V}(z)) \not = \varnothing$ $[g_{V}(z)) = \varnothing$.
              The one before the last condition means that there exists $e_x = <_{c,X}^{\mu}(i_{V_{X}}(f_{V}(z)))$.
              We then define 
              \[
                <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}[u]) = [f_{V};i_{V_{X}};<_{c,X}^{\mu};i_{1,E}(z)] = [i_{1,E}(e_x)]
              \]
        \item $u$ has no pre-image in $Z$ and $<_{c,X+Y}^{\mu}(i_{V_{X} + V_{Y}}(u)) = e'$
        \[
            <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}[u]) = [<_{c,X+Y}^{\mu}(i_{V_{X} + V_{Y}}(u))] = [e']
        \]
        \item $u$ has no pre-image in $Z$ and $<_{c,X+Y}^{\mu}(i_{V_{X} + V_{Y}}(u))$ is undefined (i.e. $[u) = \varnothing$), but there exists $[e]$ such that $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e])) = [e']$ and $[u] \in t([e])$ or $[u] \in s([e])$, then
              \[ 
                <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}[u]) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}[e])
              \]
              Assumptions above guarantee that the predecessor of such node does not depend on the choice of $e$ if there are several of them.
    \end{enumerate}
    % \question{In the case when images of $f$ and $g$ are top-level the function is undefined. Shall we introduce bottom?}
    Now, if $u$ is an element of $E_{X+Y}$.
    We have the only case of $u$ having no pre-image in $E_{Z}$ because it is empty.
              Consider two cases.
              \begin{enumerate}
                \item  $<_{c,X+Y}^{\mu}(i_{E_{X} + E_{Y}}(u)) = u_1$.
                        Then we define
                    \[
                        <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}[u]) = [<_{c,X+Y}^{\mu}(i_{E_{X} + E_{Y}}(u))]
                    \]
                \item $[u) = \varnothing$ and for some $[v_i] \in s([u])$ and $[v_j] \in t([u])$ $[[v_i]) \not = \varnothing$ and $[[v_j]) \not = \varnothing$.
                      Then we define 
                    \[
                        <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}[u]) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}[v])
                    \] where $[v]$ is either in $s([u])$ or $t([u])$.
                     The second assumption in~\ref{pushout:assumptions} guarantees that all candidates for $[v]$ share the same predecessor, i.e. the definition does not depend on a particular $[v]$.
              \end{enumerate}
    We will also build this relation in steps, first we do steps for nodes (1) - (3), then step (1) for edges and finally, we will interleave step (2) for edges and step (4) for nodes until fixed point.
    Essentially, this interleaving means that nodes inherit the relation from incident edges and vice versa.
    Clearly, all the cases above are disjoint.

    Let's check that this is a well-defined function.
    Suppose $t_1, t_2$ are nodes and $t_1 \sim t_2$, then $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X}+V_{Y}}{\sim}}[t_1]) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}[t_2])$.
    $t_1 \sim t_2$ implies there is $z$ such that $t_1 = f_{V};i_{1,V}(z)$ and $t_2 = g_{V};i_{2,V}(z)$ and two cases
    \begin{itemize}
        \item $[f_{V}(z)) \not = \varnothing$ and $[g_{V}(t_2)) = \varnothing$
        \item $[f_{V}(z)) = \varnothing$ and $[g_{V}(t_2)) \not = \varnothing$
    \end{itemize} 
    Consider the first case, then, by definition.
    \[
        <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}[t_1]) = [f_{V};i_{V_{X}};<_{c,X}^{\mu};i_{1,E}(z)]
    \]
    and
    \[
        <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}[t_2]) = [f_{V};i_{V_{X}};<_{c,X}^{\mu};i_{1,E}(z)]
    \]
    so we have well-defined-ness on the nose. We do not need to check well-defined-ness for edges as $e_1 \sim e_2$ just implies $e_1 = e_2$ for edges.

    % \begin{itemize}
        % \item If there exists $z' = <_{c,Z}^{\mu}(z)$ then 
        % \[
        %     [<_{c,X+Y}^{\mu}(f_{E};i_{1,E}(z))] = [f_{E};i_{1,E}(<_{c,Z}^{\mu}(z))] = [f_{E};i_{1,E}(z')]
        % \]
        % \[
        %     [<_{c,X+Y}^{\mu}(g_{E};i_{2,E}(z))] = [g_{E};i_{2,E}(<_{c,Z}^{\mu}(z))] = [g_{E};i_{2,E}(z')]
        % \]
        % and
        % \[ 
        %     [f_{E};i_{1,E}(z')] = [g_{E};i_{2,E}(z')]
        % \]
        % by commutativity.
        % \item The other conditions satisfy functionality by definition.

    % \end{itemize}

    We also need to makes sure that $[]_{E} : E_{X} + E_{Y} \to \sfrac{E_{X} + E_{Y}}{\sim}$ and $[]_{V} : V_{X} + V_{Y} \to \sfrac{V_{X} + V_{Y}}{\sim}$ are homomorphisms.
    \begin{enumerate}
        \item $s_{X+Y};[]_{V}^{*}(e) = []_{E};s_{\sfrac{X+Y}{\sim}}(e)$
              This is the same as in $\catname{Hyp_{\Sigma}}$.
        \item $[<_{c,X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e))]_{E} = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([e]_{E}))$ for $e$ such that $[e) \not = \varnothing$.
              Note that by requiring $[e) \not = \varnothing$ we use the first definition for edges.
              This is homomorphic by definition. 
        \item $[<_{c,X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v))]_{E} = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v]_{V}))$.
              Let's make case analysis on $[v]_{V}$.
              \begin{itemize}
                \item $v$ has a pre-image $z$ in $V_{Z}$ such that $v = f_{V};i_{1,V}(z)$.
                    \begin{itemize}
                        \item If $[f_{V}(z)) = \varnothing$ and $[g_{V}(z)) \not = \varnothing$, then, because $i_{1,V}$ is a coproduct injection, it must be the case that $[i_{1,V}(f_{V}(z))) = \varnothing$ and we do not require any equalities for such $v$.
                        \item If $[f_{V}(z)) \not = \varnothing$ and $[g_{V}(z)) = \varnothing$, then,
                              by definition, we have $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{V_{X} + V_{Y}}[v]) = [f_{V};i_{V_{X}};<_{c,X}^{\mu};i_{1,E}(z)] = [i_{1,E}(<_{c,X}^{\mu}(f_{V};i_{V_{X}}(z)))] = [i_{1,E}(e_x)]$.
                              Because $i_{1,E}$ is a homomorphism, we also have $[<_{c,X+Y}^{\mu}(f_{V};i_{1,V};i_{V_{X} + V_{Y}}(z))] = [i_{1,E}(<_{c,X}^{\mu}(f_{V};i_{V_{X}}(z)))] = [i_{1,E}(e_x)]$.
                    \end{itemize}
                \item The case when $v = g_{V};i_{2,V}(z)$ is symmetric.
                \item If $v$ has no pre-image in $V_{Z}$ then homomorphism-ness of $[]_{V}$ is similar to the case for $[]_{E}$ above.
              \end{itemize}
    \end{enumerate}
    Then $<_{c,\sfrac{X+Y}{\sim}} : V_{\sfrac{X+Y}{\sim}} + E_{\sfrac{X+Y}{\sim}} \to (E_{\sfrac{X+Y}{\sim}})^{*}$ is defined as a transitive closure of $<_{c,\sfrac{X+Y}{\sim}}^{\mu}$.
        
    Let's now define $\consistency_{\sfrac{X+Y}{\sim}}^{\mu}$.
    We can consider the original consistency relation as a function $\consistency_{X+Y}^{\mu} : (V_{X} + V_{Y}) + (E_{X} + E_{Y}) \to 2^{(V_{X} + V_{Y}) + (E_{X} + E_{Y})}$.
    Quotienting the range of the function gives us $\consistency_{X+Y}'^{\mu} : V_{X} + V_{Y} + E_{X} + E_{Y} \to 2^{(\sfrac{V_{X} + V_{Y}}{\sim}) + \sfrac{(E_{X} + E_{Y})}{\sim}}$, which is essentially $\langle []_{V};i_{\sfrac{V_{X} + V_{Y}}{\sim}}, []_{E};i_{\sfrac{E_{X} + E_{Y}}{\sim}} \rangle^{*}$ (a copairing extended to sequences that we will further denote as $\langle []_{V}^{\consistency^{\mu}} []_{E}^{\consistency^{\mu}} \rangle$) applied to the return value of $\consistency_{X+Y}^{\mu}$.
    We then first define an auxiliary relation $\consistency^{\hashtag}$ for edges as
    \begin{enumerate}
        \item If $\consistency_{X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e)) \not = \varnothing$, then
                \begin{align*}
                    \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e]_{E})) =
                    \langle []_{V}^{\consistency}, []_{E}^{\consistency}\rangle^{*}(\consistency_{X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e)))
                \end{align*}
        \item $\consistency_{X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e)) = \varnothing$ and there exists $[v]$ in $s([e])$ or $t([e])$ such that $\consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v]) \not = \varnothing$, then
        \[
            \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e]_{E})) = \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{V_{X} + V_{Y}}([v]_{V}))
        \]
    \end{enumerate}
    

    and for nodes
    \begin{enumerate}

    \item If there exists $v' \in V_{X+Y}$ such that $\consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v')) \not = \varnothing$ and $v' \sim v$
    \[
        \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v]_{V})) = \langle []_{V}^{\consistency}, []_{E}^{\consistency} \rangle^{*}(\bigcup_{v' \in V_{X} + V_{Y} | [v']_{V} = [v]_{V}} \consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v')))
    \]
    \item If for all $v' \in V_{X+Y}$ such that $v' \sim v$, $\consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v')) = \varnothing$ and there exists $e \in E_{X+Y}$ such that either $[v] \in s([e])$ or $[v] \in t([e])$ and $\consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e])) \not = \varnothing$, then
    \[
        \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v]_{V})) = \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{E_{X} + E_{Y}}([e]_{E}))
    \]
    \end{enumerate}
    where $i_*$ are injections into $\sfrac{V_{X} + V_{Y}}{\sim} + \sfrac{E_{X} + E_{Y}}{\sim}$.
    We also build this relation step by step as the relation above: first steps (1) for nodes and edges and then we interleave steps for edges and for nodes. 

    We then define
    \[
      \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v])) = (\consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v])))^{c}
    \]
    \[
      \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e])) = (\consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e])))^{c}  
    \]
    where $c$ is a reflexive, symmetric and transitive closure.

    Again, we need to check that this is a well-defined function and that our $([]_{V},[]_{E})$ is indeed a homomorphism with respect to $\consistency^{\mu}$.

    \begin{itemize}
        \item Let us show well-definedness.
        \begin{itemize}

            \item  Assume that $v_1, v_2 \in V_{X+Y}$ and $v_1 \sim v_2$ then $\consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{E_{X} + E_{Y}}[v_1]) = \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{E_{X} + E_{Y}}[v_2])$.
              $v_1 \sim v_2$ implies there exists $z \in V_{Z}$ such that $v_1 = f_{V};i_{1,V}(z)$ and $v_2 = g_{V};i_{2,V}(z)$ and supposing that for any of $v_i$ $\consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v_i)) \not = \varnothing$, then
              \begin{align*}
                \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1])) = (\langle []_{V}^{\consistency}, []_{E}^{\consistency} \rangle^{*}(\bigcup_{v_i \in \{v_1, v_2\}} \consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v_i))))^{c}
                %      \langle []_{V}^{\hashtag}, []_{E}^{\hashtag} \rangle^{*}(\hashtag_{X+Y}(i_{E_{X} + E_{Y}}(t_1))) = \langle []_{V}^{\hashtag}, []_{E}^{\hashtag} \rangle^{*}(\hashtag_{X+Y}(f_{E};i_{1,E};i_{E_{X} + E_{Y}}(z)) = \\
                %      \text{By homomorphism-ness of $f_{E};i_{1,E}$} \\
                %      = \langle []_{V}^{\hashtag}, []_{E}^{\hashtag} \rangle^{*}(\langle f_{V};i_{1,V};i_{V_{X} + V_{Y}} ,f_{E};i_{1,E};i_{E_{X} + E_{Y}} \rangle^{*}(\hashtag_{Z}(i_{E_{Z}}(z)))
              \end{align*}
              Similarly,
              \[
                \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2])) = (\langle []_{V}^{\consistency}, []_{E}^{\consistency} \rangle^{*}(\bigcup_{v_i \in \{v_1, v_2\}} \consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v_i))))^{c}
              \]
              and we get well-definedness on the nose.
              We do not need to check well-definedness for edges as $e_1 \sim e_2$ implies $e_1 = e_2$.
            \item Now suppose that both $\consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v_1)) = \varnothing$ and $\consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v_2)) = \varnothing$.
                  This would mean that for all $v_i \in V_{Z}$ $\consistency^{\mu}(f_{V}(v)) = \varnothing$ and $\consistency^{\mu}(g_{V}(z)) = \varnothing$ and automatically
                  \[
                    \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1])) = \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2]))
                  \]
            \end{itemize}
        \item Putting $\phi = ([]_{V},[]_{E})$ into the definition of a homomorphism gives us
            \[
             \langle []_{V};i_{\sfrac{V_{X} + V_{Y}}{\sim}}, []_{E};i_{\sfrac{E_{X} + E_{Y}}{\sim}} \rangle^{*}(\consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(x)))
             \subseteq
             \consistency_{\sfrac{X+Y}{\sim}}^{\mu}([]_{V};i_{\sfrac{V_{X} + V_{Y}}{\sim}}(x))
             \]
            By definition, 
            \[
                \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}([]_{V};i_{\sfrac{V_{X} + V_{Y}}{\sim}}(x)) = \langle []_{V}^{\consistency}, []_{E}^{\consistency} \rangle^{*} (\bigcup_{x' \in V_{X} + V_{Y} | [x']_{V} = [x]_{V}} \consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(x)))
            \]
            and by recalling that $[]_V^{\consistency} = []_{V};i_{\sfrac{V_{X} + V_{Y}}{\sim}}$ and similarly for $[]_{E}^{\consistency}$ we get the inclusion $\subseteq \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}([]_{V};i_{\sfrac{V_{X} + V_{Y}}{\sim}}(x))$ and the latter is the subset of $\consistency_{\sfrac{X+Y}{\sim}}^{\mu}([]_{V};i_{\sfrac{V_{X} + V_{Y}}{\sim}}(x))$ because it is a closure.
            If $\consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(x)) = \varnothing$ then homomorphismness is true because empty set is a subset of any set.
            Similarly for edges.
    \end{itemize}

    Let's now prove the universal property.
    Let $u_{E}([i_{1,E}(x)]) = j_{1,E}(x)$ and $u_{E}([i_{2,E}(y)]) = j_2(y)$.
    We will need to check that this a well-defined function, while homomorphism-ness follows from homomorphism-ness of $j_{1,E}$ and $j_{2,E}$.

    Let's say that $t_1 \sim t_2$ then $u_{E}([t_1]) = u_{E}([t_2])$.
    $u_{E}([t_1]) = u_{E}(f_{E};i_{1,E}(z)) = j_1{f_{E}(z)}$ and $u_{E}([t_2]) = u_{E}(g_{E};i_{2,E}(z)) = j_{2}(g_{E}(z))$ which are equal by commutativity.
\end{proof}

\begin{lemma}
    \label{lemma:choice_of_nodes_agnostic}
    Suppose $[e) = \varnothing$ and there exists $[v_1] \in s([e])$ and $[v_2] \in s([e])$ such that $[[v_1]) \not = \varnothing$ and $[[v_2]) \not = \varnothing$, then $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{V_{X} + V_{Y}}([v_1])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{V_{X} + V_{Y}}([v_2]))$.
    \begin{proof}
        We will show the statement is true for the base case when $[v_1]$ and $[v_2]$ do not inherit their relations.
        In other words, $[[v_1]) \not = \varnothing$ and $[[v_2]) \not = \varnothing$ mean that was achieved after running steps (1)-(3) for nodes.
        From $[v_1] \in s([e])$ we get that there exists $v'_1$ such that $v_1 \sim v'_1$ and $v'_1 \in s(e)$ and similarly $v'_2 \sim v_2$.
        \begin{itemize}
            \item $v_1 = v'_1$, $v_1 \in s(e)$, and $v_2 = v'_2$, $v_2 \in s(e)$.
            \begin{itemize}
                \item $v_1$ has a pre-image $f_{V};i_{1,V}(z)$ and hence $[f_{V}(z)) = \varnothing$ (because $[e) = \varnothing$) and $v_2$ has a pre-image $f_{V};i_{1,V}(z')$.
                      Then, $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1])) = [i_{2,E}(e_{y})]$ and $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2])) = [i_{2,E}(e'_{y})]$.
                      Because $e_{y} = <_{c,Y}^{\mu}(i_{V_{Y}}(g_{V}(z)))$ and $e'_{y} = <_{c,Y}^{\mu}(i_{V_{Y}}(g_{V}(z')))$ we have $e_{y} = e'_{y}$ because under our assumptions nodes in the image of $g_{V}$ should share the same predecessor.
                      Hence, $[i_{2,E}(e_{y})] = [i_{2,E}(e'_{y})]$.
                \item Case for $v_1 = g_{V};i_{2,V}(z)$ is symmetric.
                \item Case when $v_1$ has no pre-image in $V_Z$ is not possible, because it would mean that $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1])) = [<_{c,X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v_1))]$ (according to step (3)) which is not possible as it would mean that $[e) \not = \varnothing$ (because $[v_1) \not = \varnothing$).
            \end{itemize}
            \item $v_1 \not = v'_1$ and $v'_2 \not = v_2$ and hence $v'_1 \in s(e)$ and $v'_2 \in s(e)$.
            \begin{itemize}
                \item $v'_1$ has a pre-image $f_{V};i_{1,V}(z)$ and hence $[f_{V}(z)) = \varnothing$ and $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v'_1])) = [i_{2,E}(e_{y})]$.
                      $v'_2$ has a pre-image $f_{V};i_{1,V}(z')$ and for the same reason 
                      \begin{align*}
                        &<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v'_1])) =\\ 
                        &[i_{2,E}(e_{y})] = [i_{2,E}(e'_{y})] =\\
                        &<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v'_2])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2]))
                    \end{align*}
                \item Case when $v'_1 = g_{V};i_{2,V}(z)$ is similar.
            \end{itemize}
            \item $v_1 = v'_1$, $v'_2 \sim v_2$ and $v_1 \in s(e)$, $v'_2 \in s(e)$.
            \begin{itemize}
                \item $v_1 = f_{V};i_{1,V}(z)$ and hence $v'_2 = f_{V};i_{1,V}(z')$ and $[f_{V}(z)) = \varnothing$ as well as $[f_{V}(z')) = \varnothing$.
                      Then, $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1])) = [i_{2,E}(e_{y})]$ and similarly $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2])) = [i_{2,E}(e'_{y})]$.
                      And by the following the same reasoning as above we get the equality.
                \item Case when $v_1 = g_{V};i_{2,V}(z)$ is similar.
            \end{itemize}
            \item The remaining case is similar.
        \end{itemize}
        The proofs for the cases when $[v_1] \in t([e])$ and $[v_2] \in t([e])$ and for the combinations of $t,s$ are similar.
    \end{proof}
\end{lemma}

\begin{lemma}
    \label{lemma:choice_of_edges_agnostic}
    Suppose $[v) = \varnothing$ and there exist $e_1$ and $e_2$ such that $[[e_1]) \not = \varnothing$ and $[[e_2]) \not = \varnothing$ and $[v] \in s([e_1])$, $[v] \in s([e_2])$.
    Then, $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_1])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_2]))$
    \begin{proof}
        We will again show the base case when $[e_1]$ and $[e_2]$ inherit the relation atmost at 1 step.
        That is, $[[e_1]) \not = \varnothing$ and $[[e_2]) \not = \varnothing$ mean that this was achieved after performing steps (1) - (2) for edges.
        We then have the following cases.
        \begin{itemize}
            \item $v \in s(e_1)$ and $v \in s(e_2)$.
                  The only possible case for $e_1$ and $e_2$ is that $[e_1) = \varnothing$ and $[e_2) = \varnothing$ (because $[v) = \varnothing$).
                  Then, 
                  \[
                    <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_1])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1]))
                  \], where $[v_1] \in s([e_1])$ and $[[v_1]) \not = \varnothing$.
                  And 
                  \[
                    <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_2])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2]))
                  \], where $[v_2] \in s([e_2])$ and $[[v_2]) \not = \varnothing$.
                  The cases are following.
                  \begin{itemize}
                    \item $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1])) = [i_{1,E}(e_{x})]$ and 
                          $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2])) = [i_{1,E}(e'_{x})]$. 
                          Then, $e'_{x} = e_{x}$ because the nodes in the image of $f$ should have the same predecessor.
                    \item $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1])) = [i_{1,E}(e_{x})]$ and 
                          $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2])) = [i_{2,E}(e_{y})]$
                          $e_1$ and $e_2$ should both have pre-image in either $E_{Y}$ or $E_{X}$ (because they are from the same connected component).
                          \begin{itemize}
                            \item $v_1 = f_{V};i_{1,V}(z)$ and $[f_{V}(z)) \not = \varnothing$.
                                  Then, necessarily, $v'_1 \in s(e_1)$ and $v_1 \sim v'_1$ and $v'_1 = g_{V};i_{2,V}(z)$ and hence $e_1$, $e_2$ have pre-image in $E_{Y}$.
                                  If $v_2 \in s(e_2)$ then it should have a pre-image in $V_{Y}$ and it can not be the case that $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2])) = [i_{2,E}(e_y)]$.
                                  If $v'_2 \in s(e_2)$ and $v_2 \sim v'_2$ then $v'_2$ has a pre-image in $V_{Y}$ and $v_2$ has a pre-image in $V_{X}$, i.e. $v_2 = f_{V};i_{1,V}(z_2)$. 
                                  The equation above implies that $[g_{V}(z_2)) \not = \varnothing$ which is not the case as $[v'_2) = \varnothing$.
                            \item $v_1 = g_{V};i_{2,V}(z_1)$ and $[g_{V}(z_1)) = \varnothing$. 
                                  Then, necessarily, $v_1 \in s(e_1)$ and $v_1 \sim v'_1$ and $v'_1 = f_{V};i_{1,V}(z_1)$ and hence $e_1$, $e_2$ have pre-image in $E_{Y}$.
                                  If $v_2 \in s(e_2)$ then it should have a pre-image in $V_{Y}$, i.e. $v_2 = g_{V};i_{2,V}(z_2)$ and then it should be $[g_{V}(z_2)) \not = \varnothing$ which is not the case.
                                  If $v'_2 \in s(e_2)$ then it should have a pre-image in $V_{Y}$, i.e. $v'_2 = g_{V};i_{2,V}(z_2)$ and then it should be $[g_{V}(z_2)) \not = \varnothing$ which is not the case.
                          \end{itemize}
                    \item Other cases are not possible, for example, $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X}+V_{Y}}{\sim}}([v_1])) = [i_{1,E}(e_{x})]$ and $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X}+V_{Y}}{\sim}}([v_2])) = [<_{c,X+Y}^{\mu}(i_{V_{X} + V_{Y}})(v_2)]$
                          would mean that $e_2$ has a predecessor because $v_2$ does and $v_2 \in s(e_2)$ because $v_2$ has no pre-image in $V_{Z}$. $[v_2]$ can not inherit the relation because we consider inheritance only upto 1 step: inheritance for $v_2$ would mean that $v$ inherits the relation in more than 1 step.
                  \end{itemize}
            \item $v' \in s(e_1)$ and $v \in s(e_2)$ and $v' \sim v$
                  Suppose $[e_1) \not = \varnothing$. Then,
                  \[
                    <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_1])) = [<_{c,X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e_1))]
                  \] and $[e_2) = \varnothing$ and
                  \[
                    <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_2])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2]))
                  \],
                  where $[v_2] \in s([e_2])$ and $[[v_2]) \not = \varnothing$.
                  \begin{itemize}
                    \item $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2])) = [i_{1,E}(e_x)]$.
                          If $v_2 = f_{V};i_{1,V}(z_2)$, then $[f_{V}(z_2)) \not = \varnothing$ and hence $v'_2 \in s(e_2)$ and $v'_2 \sim v_2$.
                          It should be the case that $v = g_{V};i_{2,V}(z)$ (if it had a pre-image in $V_{X}$ it would share the predecessor with the pre-image of $v_2$, but $[v) = \varnothing$) and $v' = f_{V};i_{1,V}(z)$, then $e_1$ has a pre-image in $E_{X}$ and $e_2$ has a pre-image in $E_{Y}$.
                          Then $v'$ and $v_2$ both have pre-image in $V_{X}$ and because of the assumption $[f_{V}(z)) = [f_{V}(z_2))$ and $[<_{c,X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e_1))] = [<_{c,X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v'))] = [i_{1,E}(e_x)] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2]))$.
                          The case when $v_2 = g_{V};i_{2,V}(z_2)$ is symmetric.
                    \item $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2])) = [<_{c,X+Y}^{\mu}(i_{V_{X} + V_{Y}})(v_2)]$ is not possible as it would mean that $v_2 \in s(e_2)$, but $[e_2) = \varnothing$.
                    \item $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e']))$ is also not possible as it would mean that $e_2$ inherits the relation in more than 1 step.
                \end{itemize}
                Cases $[e_1) = \varnothing$ and $[e_2) = \varnothing$ and $[e_1) = \varnothing$, $[e_2) \not = \varnothing$ are not possible.
            \item $v \in s(e_1)$ and $v' \in s(e_2)$ and $v' \sim v$
                  This is symmetric to the above.
            \item $v' \in s(e_1)$ and $v'' \in s(e_2)$ and $v' \sim v$, $v'' \sim v$. 
                  The last bit also means that $v'' \sim v'$, but because $f$ and $g$ are mono we have at most 2 elements in each equivalence class so it reduces to the cases above.
        \end{itemize}
        The proofs for the cases when $[v] \in t([e_1])$ and $[v] \in t([e_2])$ and for the combinations of $t,s$ are similar.
    \end{proof}
\end{lemma}

\begin{remark}
    To get the result for arbitrary number of steps we take the above lemmas as base case and procceed by induction on the number of steps.
\end{remark}

\begin{corollary}
    \label{corollary:nodes}
    If $[v) = \varnothing$ and $[[v]) \not = \varnothing$ then there exist $v''$ such that there exists an undirected path from $v$ to $v''$ and there exists $v' \sim v''$ such that
    \begin{align*}
         [v') \not = \varnothing,\\
         <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v']))
    \end{align*}
    In other words, there exists the node which initiates the inheritance for nodes that had no predecessor.
\end{corollary}
\begin{corollary}
    \label{corollary:edges}
    If $[e) = \varnothing$ and $[[e]) \not = \varnothing$ then there exist $[v]$ such that there is an undirected path from $e$ to $v$ and such that there exists $v' \sim v$
    \begin{align*}
        [v') \not = \varnothing,\\
        <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v']))
    \end{align*}  
    In other words, there exists the node which initiates the inheritance for edges that had no predecessor.
\end{corollary}

\begin{lemma}
    $<_{c,\sfrac{X+Y}{\sim}}^{\mu}$ is irreflexive, assymetric and respects connectivity.
    \begin{proof}
        We will separately consider each property.
        \begin{itemize}
            \item Suppose there exist $[e]$ such that $[e] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e]))$.
                  Then we have two cases.
                  \begin{itemize}
                    \item Assume $<_{c,X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e)) = e_1$, then  $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e])) = [e_1]$. 
                          This would mean that $e_1 = e$ which would mean that the relation $<_{c,X+Y}^{\mu}$ is not irreflexive because $e_1$ is the predecessor of $e$.
                    \item Assume $[e) = \varnothing$, then, by Corollary~\ref{corollary:edges} there exists $v$ such there is a path from $e$ to $v$ and there exists $v' \sim v$ and $[v') \not = \varnothing$ and therefore $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([v]))$.
                          \begin{itemize}
                            \item $v$ has a pre-image $f_{V};i_{1,V}(z)$ in $V_{Z}$ and since there is a path from $e$ to $v$ $[f_{V}(z)) = \varnothing$ and $v' = g_{V};i_{2,V}(z)$, $[g_{V}(z)) \not = \varnothing$.
                                  Then, $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v])) = [g_{V};i_{V_{Y}};<_{c,Y}^{\mu};i_{2,E}(z)] = [e]$.
                                  This means that $e$ has a pre-image in $E_{Y}$, but because there is a path from $e$ to $v$, $e$ should have a pre-image in $E_{X}$ (because $v$ has one in $V_{X}$). 
                                  Contradiction.
                            \item Case when $v = g_{V};i_{2,V}(z)$ is symmetric.
                          \end{itemize}
                  \end{itemize}                  
                    We do not need to check this requirement for nodes because a node can not be a predecessor.
            \item Let $e_1,e_2$ be edges. 
                  Then, if $[e_1] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_2]))$ it must not be the case that $[e_2] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_1]))$.
                  For $[e_1] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_2]))$ we have two cases.
                  \begin{itemize}
                    \item If $<_{c,X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e_2)) = e_3$ then $[e_1] = [e_3]$ which yields $e_1 = e_3$.
                          Having at the same time $[e_2] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_1]))$ gives us also two cases.
                    \begin{itemize}
                        \item $<_{c,X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e_1)) = e_4$ then $[e_2] = [e_4]$ and $e_2 = e_4$.
                         This would mean that $e_1$ is a predecessor of $e_2$ and vice versa which violates the e-hypergraphness of $X+Y$.
                        \item $[e_1) = \varnothing$ and then by Corollary~\ref{corollary:edges} there exists $v$ such that there is a path from $e_1$ to $v$ and there exists $v' \sim v$ such that $[v') \not = \varnothing$.
                              Then, $[e_2] = [<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v])]$.
                              \begin{itemize}
                                \item If $v$ has a pre-image $f_{V};i_{1,V}(z)$ in $V_{Z}$ (and hence $e_1$ has a pre-image in $E_{X}$) then necessarily $[f_{V}(z)) = \varnothing$ (because $[e_1) = \varnothing$) and hence $[g_{V}(z)) \not = \varnothing$.
                                      Then,
                                      \[
                                        [<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v])] = [i_{2,E}(e_y)] = [e_2]
                                      \]
                                      This means that $e_2$ has a pre-image in $E_{Y}$, but because $e_1$ is the predecessor of $e_2$ they both should have pre-image in either $E_{X}$ or $E_{Y}$.
                                \item Case when $v$ has a pre-image $g_{V};i_{2,V}(z)$ is symmetric to the above.
                              \end{itemize}
                        \end{itemize}
                        \item $[e_2) = \varnothing$ and by Corollary~\ref{corollary:edges} there exits $v_2$ such that there is a path from $e_2$ to $v_2$ and there exists $v'_2 \sim v_2$ such that $[v'_2) \not = \varnothing$. 
                              Then, 
                              \[
                                <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X}+E_{Y}}{\sim}}([e_2])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2])) = [e_1]
                              \]
                              The case when $[e_1) \not = \varnothing$ are similar to the above, so we will just jump to the interesting case when 
                              $[e_1) = \varnothing$ and
                              \[
                                <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X}+E_{Y}}{\sim}}([e_1])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1])) = [e_2]
                              \]
                              The cases we have are the following.
                              \begin{itemize}
                                \item $v_2 = f_{V};i_{1,V}(z_2)$ and necessarily $[f_{V}(z_2)) = \varnothing$ and $v'_2 = g_{V};i_{2,V}(z_2)$.
                                Then, $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2])) = [g_{V};i_{V_{Y}};<_{c,Y}^{\mu};i_{2,E}(z_2)] = [e_1]$ which also implies that $e_1$ has a pre-image in $E_{Y}$.
                                \begin{itemize}
                                    \item $v_1 = g_{V};i_{2,V}(z_1)$ (because there is a path from $e_1$ to $v_1$) and necessarily $[g_{V}(z_1)) = \varnothing$ (because $[e_1) = \varnothing$) and $v'_1 = f_{V};i_{1,V}(z_1)$.
                                    Then, $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1])) = [f_{V};i_{V_{X}};<_{c,X}^{\mu};i_{1,E}(z_1)] = [e_2]$  
                                    However, it means that $[f_{V}(z_2)) = \varnothing$ and $[f_{V}(z_1)) \not = \varnothing$ which violates our assumptions.
                                \end{itemize}
                                \item Case when $v_2 = g_{V};i_{2,V}(z_2)$ is symmetric.
                              \end{itemize}
                  \end{itemize} 
                  Once again, we do not need to check for nodes as a node can not be on the lefthand side of the relation.
            \item We need to show that if $[v] \in s([e_1])$ and $[e_2] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_1]))$ then $[e_2] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}[v])$.
                  $[e_2] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_1]))$ gives us two cases.
                  \begin{itemize}
                    \item If $<_{c,X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e_1)) = e_3$, then $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_1])) = [<_{c,X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e_1))] = [e_3] = [e_2]$ which means that $e_2$ is the predecessor of $e_1$.
                          $[v] \in s([e_1])$ means that there exists $v'$ such that $[v] = [v']$ and $v' \in s(e_1)$.
                          \begin{itemize}
                            \item $v = v'$ then $v \in s(e_1)$ and because $e_2$ is the predecessor of $e_1$ it is also a predecessor of $v$ because $X+Y$ is an e-hypergraph.
                                That is, $e_2 = <_{c,X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v))$ and we have $[e_2] = [<_{c,X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v))] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v]))$.
                            \item $v \sim v'$ which means there exists $z \in V_{Z}$ such that $v = f_{V};i_{1,V}(z)$ and $v' = g_{V};i_{2,V}(z)$ and $v' \in s(e_1)$.
                                  Once again, $e_2 = <_{c,X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e_1))$ implies $e_2 = <_{c,X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v'))$ and 
                                  \[
                                    [e_2] = [<_{c,X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v'))] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v'])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v]))
                                  \]
                            \end{itemize}
                    \item $[e_1) = \varnothing$ and by Corollary~\ref{corollary:edges} there exists $v_1$ such that there is a path from $e_1$ to $v_1$ and there exists $v'_1 \sim v_1$ such that $[v'_1) \not = \varnothing$.
                          Then, $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_1])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1]))$.
                          Suppose $v_1 = f_{V};i_{1,V}(z)$ and then $v'_1 = g_{V};i_{2,V}(z)$ and $[g_{V}(z)) \not = \varnothing$ and $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1])) = [g_{V};i_{V_{Y}};<_{c,Y}^{\mu};i_{2,E}(z)] = [e_2]$ and hence $e_2$ has a pre-image in $E_{Y}$.
                          \begin{itemize}
                            \item $v = v'$ and then $v \in s(e_1)$ and $[v) = \varnothing$.
                                  Because there is a path from $e_1$ to $v_1$ there is also a path from $v$ to $v_1$ and hence $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1])) = [e_2]$
                            \item $v \sim v'$ and $v' \in s(e_1)$ and $[v') = \varnothing$.
                                  By the same argument, 
                                  \[
                                    <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v'])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1])) = [e_2]
                                  \]
                          \end{itemize}                    
                  \end{itemize}
            \item Finally, we need to check that if $[v] \in s([e_1])$ and $[e_2] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v]))$ then $[e_2] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_1]))$.
            Once again, $[v] \in s([e_1])$ means that there exists $v' \in s(e_1)$ such that $v' \sim v$.
            \begin{itemize}
                \item $v' = v$ and hence $v \in s(e_1)$.
                \begin{itemize}
                    \item If $v$ has no pre-image in $V_{Z}$, then $[e_2] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v])) = [<_{c,X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v))]$.
                          This essentially means that $e_2$ is the predecessor of $v$ and, by e-hypergraphness of $X+Y$, $e_2 = <_{c,X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e_1))$ and $[e_2] = [<_{c,X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e_1))] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_1]))$ which is what we want.
                    \item $v$ has no pre-image in $V$ and $[v) = \varnothing$.
                          By Corollary~\ref{corollary:nodes} there exists $v'$ such that there is a path from $v$ to $v'$ and $v'' \sim v'$ such that $[v'') \not = \varnothing$.
                          Then, $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v'])) = [e_2]$.
                          Because $v \in s(e_1)$ there should also be a path from $e_1$ to $v'$ and $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_1])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v'])) = [e_2]$
                    \item $v$ has a pre-image $f_{V};i_{1,V}(z)$ and $[f_{V}(z)) \not = \varnothing$ and $[g_{V}(z)) = \varnothing$, then
                    \[ 
                        [e_2] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v])) = [f_{V};i_{V_{X}};<_{c,X}^{\mu};i_{1,E}(z)]
                    \]
                    This means that the pre-image of $e_2$ is the predecessor of $f_{V};(z)$ and hence $e_2$ should be the predecessor of $f_{V};i_{1,V}(z)$ and hence of $e_1$ since $v_1 \in s(e_1)$ and $X+Y$ is an e-hypergraph.
                    That is, $e_2 = <_{c,X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e_1))$ and $[e_2] = [<_{c,X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e_1))] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_1]))$.
                    \item $v$ has a pre-image $f_{V};i_{1,V}(z)$ and $[f_{V}(z)) = \varnothing$ and $[g_{V}(z)) \not = \varnothing$, then
                    \[ 
                        [e_2] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v])) = [i_{2,E}(e_y)]
                    \]
                    This means that $e_2$ has a pre-image in $E_{Y}$ and $[e_1) = \varnothing$ since $e_1$ necessarily has a pre-image in $E_{X}$.
                    Then, by definition, $<_{c,\sfrac{X+Y}{\sim}}^{\mu}([e_1]) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}[v]) = [i_{2,E}(e_y)] = [e_2]$.
                    \item Cases when $v$ has a pre-image $g_{V};i_{2,V}(z)$ are symmetric.
                \end{itemize}
                \item $v \sim v'$.
                    Follows by the same argument as above by recalling that $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v'])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v]))$.
            \end{itemize}    
        \end{itemize}
    \end{proof}
\end{lemma}

\begin{lemma}
    If for all $v' \in V_{X+Y}$ such that $v' \sim v$, $\consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v')) = \varnothing$ and there exist $e_1 \in E_{X+Y}$ such that either $[v] \in s([e_1])$ or $[v] \in t([e_1])$ and $\consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_1])) \not = \varnothing$ and $e_2 \in E_{X+Y}$ such that either $[v] \in s([e_2])$ or $[v] \in t([e_2])$ and $\consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_2])) \not = \varnothing$ then
    \[
      \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_1])) = \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e_2]))
    \]
    \begin{proof}
        The proof is analogous to the proof of an analogous lemma for $<_{c,\sfrac{X+Y}{\sim}}^{\mu}$.
    \end{proof}
\end{lemma}

\begin{lemma}
    If $\consistency_{X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e)) = \varnothing$ and there exist $v_1$ such that either $[v_1] \in s([e])$ or $[v_1] \in t([e])$ and $v_2$ such that either $[v_2] \in s([e])$ or $[v_2] \in t([e])$ and $\consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1])) \not = \varnothing$ and $\consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2])) \not = \varnothing$ then
    \[
        \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2])) = \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1]))
    \]
    \begin{proof}
        The proof is analogous to the proof of the analogous lemma for $<_{c,\sfrac{X+Y}{\sim}}^{\mu}$.
    \end{proof}
\end{lemma}

\begin{corollary}
    \label{corollary:consistency_nodes}
    If $\consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v)) = \varnothing$ and $\consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v])) \not = \varnothing$ then there exists $v'$ such that there is a path from $v$ to $v'$ and there exists $v'' \sim v'$ such that
    \[
        \consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v'')) \not = \varnothing
    \]
    \[
        \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v])) = \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v']))
    \]
\end{corollary}

\begin{corollary}
    \label{corollary:consistency_edges}
    If $\consistency_{X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e)) = \varnothing$ and $\consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e])) \not = \varnothing$ then there exists $v$ such that there is a path from $e$ to $v$ and there exists $v' \sim v$ such that
    \[
        \consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v')) \not = \varnothing
    \]
    \[
        \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e])) = \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v']))
    \]
\end{corollary}

\begin{lemma}
    $\consistency_{\sfrac{X+Y}{\sim}}^{\mu}$ satisfies properties~\ref{def:consistency_properties}.
    The property (1) is satisfied by construction because we explicitly perform a closure.
    Hence we need to check whether properties (2),(3) and (4) are satisfied.
    \begin{proof}
        \begin{itemize}
            \item Suppose $[v] \in s([e])$ and $[[v]) = [[e]) \not = \varnothing$, then it must be the case that $i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e]) \in \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v]))$.
                  $[v] \in s([e])$ means there exists $v' \in s(e)$ such that $v \sim v'$.
                  We then have two cases.
                  \begin{itemize}
                    \item $v = v'$ and then $v \in s(e)$.
                    \begin{itemize}
                        \item $[v) \not = \varnothing$ and then $[e) \not = \varnothing$ and necessarily $i_{E_{X} + E_{Y}}(e) \in \consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v))$.
                                By applying $([]_{V},[]_{E})$ we get 
                                \[
                                i_{\sfrac{E_{X}+E_{Y}}{\sim}}([e]) \in \langle []_{V};i_{\sfrac{V_{X} + V_{Y}}{\sim}},[]_{E};i_{\sfrac{E_{X} + E_{Y}}{\sim}}) \rangle^{*}(\consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v))) \subseteq \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}[v]) \subseteq \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}[v])
                                \]
                        \item $[v) = \varnothing$ and then $[e) = \varnothing$ then there exists $v'$ such that there is a path from $e$ to $v'$ and $v'' \sim v'$ such that $[v'') \not = \varnothing$.
                              It is then also the case that $\consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v)) = \varnothing$ and $\consistency_{X+Y}^{\mu}(i_{E_{X} + E_{Y}}(e)) = \varnothing$ and $\consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v'')) \not = \varnothing$.
                              Then, by definition, $\consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e])) = \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v])) = \consistency_{\sfrac{X+Y}{\sim}}^{\hashtag}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v'']))$ and by reflexivity $i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e]) \in \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{E_{X} + E_{Y}}{\sim}}([e])) = \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v]))$    
                    \end{itemize}
                    \item $v \sim v'$ follows by the same argument by using functionality, 
                        \[
                            \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}[v']) = \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}[v])
                        \]
                   \end{itemize}
                  \item The case when $[v] \in t([e])$ is symmetric.
                  \item If $i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1]) \in \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2]))$ then
                        $<_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X}+V_{Y}}{\sim}}([v_1])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X}+V_{Y}}{\sim}}([v_2]))$.
                        By definition, either
                        \[
                            \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2])) = (\langle []_{V}^{\consistency}, []_{E}^{\consistency} \rangle^{*} (\bigcup_{v' \in V_{X} + V_{Y} | [v']_{V} = [v_2]_{V}} \consistency_{X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v'))))^{c}
                        \]
                        which means that either $v_1 \consistency_{X+Y}^{\mu} v_2$ or $v'_1 \consistency_{X+Y}^{\mu} v_2$ and $v'_1 \sim v_1$, or $v_1 \consistency_{X+Y}^{\mu} v_2'$ and $v_2' \sim v_2$, or $v_1' \consistency_{X+Y}^{\mu}(v_2')$ and $v_1' \sim v_1$, $v_2' \sim v_2$.
                        Suppose, $v_1' \consistency_{X+Y}^{\mu} v_2$ and $v_1' \sim v_1$.
                        It implies that $[v_1') = [v_2)$ and that 
                        \[
                            <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1])) = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_1'])) = [<_{c,X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v_1'))] = [<_{c,X+Y}^{\mu}(i_{V_{X} + V_{Y}}(v_2))] = <_{c,\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2]))
                        \]
                        The rest cases are analogous.
                        Or there exists $v_3$ such that there is a path from $v_2$ to $v_3$ and there is $v_3' \sim v_3$ such that $\consistency_{X+Y}^{\mu}(v_3') \not = \varnothing$ and
                        \[
                            \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_2])) = \consistency_{\sfrac{X+Y}{\sim}}^{\mu}(i_{\sfrac{V_{X} + V_{Y}}{\sim}}([v_3]))
                        \]
                        Then the argument is the same but with using $v_3$ in place of $v_2$.
                    \item Case for edges is analogous.
        \end{itemize}
    \end{proof}
\end{lemma}

\begin{proposition}[$\sfrac{X+Y}{\sim}$ is an e-hypergraph]
For this we need to check that the defined relations satisfy all the needed properties.
\begin{proof}
    This proposition then follows by taking two lemmas above.
\end{proof}
\end{proposition}

\begin{definition}[Definition 3.16~\cite{bonchi_string_2022-1}]
Morphisms $\mathcal{K} \xrightarrow{f} \mathcal{L} \xrightarrow{m} \mathcal{G}$ satisfy the \textit{no-dangling} condition if, for every hyperedge not in the image of $m$, every node of its source and target is either (i) not in the image of $m$ or (ii) in the image of $f ; m$.
They satisfy the no-identification condition if any two nodes merged by $m$ are in the image of $f$.
\end{definition}

\begin{proposition}
\label{prop:complement_existence}
    Consider a pushout square in $\catname{EHyp_{\Sigma}}$ below
    % https://q.uiver.app/#q=WzAsNSxbMCwwLCJYIl0sWzIsMCwiWiJdLFsyLDIsIkMiXSxbMCwyLCJQXntcXHVyY29ybmVyfSJdLFsyLDUsIlxcYnVsbGV0Il0sWzEsMCwiaSIsMl0sWzEsMl0sWzIsM10sWzAsMywibSIsMl1d
% \[\begin{tikzcd}
% 	X && Z \\
% 	\\
% 	{P^{\urcorner}} && C \\
% 	\\
% 	\\
% 	&& \bullet
% 	\arrow["i"', from=1-3, to=1-1]
% 	\arrow[from=1-3, to=3-3]
% 	\arrow[from=3-3, to=3-1]
% 	\arrow["m"', from=1-1, to=3-1]
% \end{tikzcd}\]
\[
    \tikzfig{appendix/pushout_square}
\]
    Such that $m,f$ are monos and $\mathcal{K}$ is discrete.
    Then, pushout complement $\mathcal{K} \to \mathcal{L}^{\bot} \to \mathcal{G}$ exists if
    \begin{enumerate}
        \item $[m(v_i)) = [m(v_j))$ for all $v_i,v_j$ that have a pre-image in $V_{\mathcal{K}}$.
        \item $\consistency(m(v_i)) = \consistency(m(v_j))$ for all $v_i,v_j$ that have a pre-image in $V_{\mathcal{K}}$.
        \item The no-dangling condition holds.
    \end{enumerate}
\end{proposition}
\begin{proof}
    By requiring that $m$ is mono makes the no-identification condition satisfied on the nose.
    Then, no-dangling and no-identification conditions are necessary for pushout complement to exists~\cite{dpo}.
    Points (1)-(2) above guarantee that after removing from $\mathcal{G}$ everything in $\mathcal{L}$ that has no pre-image in $\mathcal{K}$ the arrow $\mathcal{K} \to \mathcal{L}^{\bot}$ will satisfy the assumptions~\ref{pushout:assumptions}.
\end{proof}

\begin{proposition}
\label{prop:boundary_complement}
    The boundary complement in~\ref{def:boundary_new} when exists is unique
    \begin{proof}
        The pushout in $EHyp_{\Sigma}$ should also be a pushout on the underlying sets of verticies and hyperedges.
        Hence, pushout complement should yield pushout complements for the corresponding sets.
        In particular,
          % https://q.uiver.app/#q=WzAsNSxbMCwwLCJWX3tMfSJdLFsyLDAsImxfe2l9ICsgbF97b30iXSxbNCwwLCJpK2oiXSxbMCwyLCJWX3tHfSJdLFs0LDIsIlZfe0N9Il0sWzIsMSwiYl97Vn0iXSxbMSwwLCJhX3tWfSJdLFswLDMsImZfe1Z9Il0sWzQsMywiZ197Vn0iLDJdLFsyLDQsImMiLDJdXQ==
    \begin{figure}[h!]
        \begin{subfigure}{0.45\textwidth}
            % \[\begin{tikzcd}
            %     {V_{L}} && {l_{i} + l_{o}} && {i+j} \\
            %     \\
            %     {V_{G}^{\urcorner}} &&&& {V_{C}}
            %     \arrow["{b_{V}}", from=1-5, to=1-3]
            %     \arrow["{a_{V}}", from=1-3, to=1-1]
            %     \arrow["{f_{V}}", from=1-1, to=3-1]
            %     \arrow["{g_{V}}"', from=3-5, to=3-1]
            %     \arrow["c"', from=1-5, to=3-5]
            % \end{tikzcd}\]
            \[
                \tikzfig{appendix/pushout_verticies}
            \]
        \end{subfigure}
        \hfill
        \begin{subfigure}{0.45\textwidth}
           % https://q.uiver.app/#q=WzAsNSxbMCwwLCJFX3tMfSJdLFsyLDAsIjAiXSxbNCwwLCIwIl0sWzAsMiwiRV97R31ee1xcdXJjb3JuZXJ9Il0sWzQsMiwiRV97Q30iXSxbMiwxLCJiX3tFfSJdLFsxLDAsImFfe0V9Il0sWzAsMywiZl97RX0iXSxbNCwzLCJnX3tFfSIsMl0sWzIsNCwiYyIsMl1d
        \[
        % \begin{tikzcd}
        %     {E_{L}} && 0 && 0 \\
        %     \\
        %     {E_{G}^{\urcorner}} &&&& {E_{C}}
        %     \arrow["{b_{E}}", from=1-5, to=1-3]
        %     \arrow["{a_{E}}", from=1-3, to=1-1]
        %     \arrow["{f_{E}}", from=1-1, to=3-1]
        %     \arrow["{g_{E}}"', from=3-5, to=3-1]
        %     \arrow["c"', from=1-5, to=3-5]
        % \end{tikzcd}
        \tikzfig{appendix/pushout_edges}
        \]
        \end{subfigure}
    \end{figure}
    $V$s and $E$s are sets of verticies and hyperedges respectively, marked squares are pushouts and $\mathcal{L}^{\bot}$s are pushout complements.
    Because $i+j$ is discrete, $E_{\mathcal{G}}$ is the disjoint union of $E_{\mathcal{L}}$ and $E_{\mathcal{L}^{\bot}}$ and hence $E_{\mathcal{L}^{\bot}} = E_{\mathcal{G}} \setminus E_{\mathcal{L}}$.
    Then, since all the arrows are monos, the first square can be rewritten as follows.
    \[
      % https://q.uiver.app/#q=WzAsNSxbMCwwLCJpICsgaiArIHggKyB5Il0sWzIsMCwiaStqICsgeCJdLFs0LDAsImkraiJdLFswLDIsImkgKyBqICsgeCArIHkgKyB6Il0sWzQsMiwiaSArIGogKyB3IFxcY29uZyBpICsgaiArIHoiXSxbMiwxLCJoX3tWLGV4dH0iLDJdLFsxLDAsImhfe1YsaW50fSIsMl0sWzAsMywibV97Vn0iLDJdLFs0LDMsImdfe1Z9Il0sWzIsNCwiYyIsMl1d
    \begin{tikzcd}
	{i + j + x + y} && {i+j + x} && {i+j} \\
	\\
	{i + j + x + y + z} &&&& {i + j + w \cong i + j + z}
	\arrow["{h_{V,ext}}"', from=1-5, to=1-3]
	\arrow["{h_{V,int}}"', from=1-3, to=1-1]
	\arrow["{m_{V}}"', from=1-1, to=3-1]
	\arrow["{g_{V}}", from=3-5, to=3-1]
	\arrow["c_{V}"', from=1-5, to=3-5]
\end{tikzcd}
    \]
    Because $i + j + x + y + w$ also yields a pushout it must be the case that $i+j+x+y+w \cong i + j + x + y + z$ and therefore $w \cong z$ and pushout complement for nodes is $i + j + z$ up to isomorphism.
    To show that pushout complement is unique we next need to show that source and target maps are unique.
    Suppose that there exist
    \[
        \mathcal{L}^{\bot}_{1} = (V_{\mathcal{L}^{\bot}}, E_{\mathcal{L}^{\bot}}, s_{1},t)
    \qquad
    \text{and}
    \qquad
        \mathcal{L}^{\bot}_{2} = (V_{\mathcal{L}^{\bot}},E_{\mathcal{L}^{\bot}},s_{2},t)
    \]
    Because $g$ is a homomorphism, it must be the case that $g_{V}^{*}(s_{1}(e)) = s_{\mathcal{G}}^{*}(g_{E}(e)) = g_{V}^{*}(s_{2}(e))$.
    Because $g$ is mono, $g_{V}^{*}(s_{1}(e)) = g_{V}^{*}(s_{2}(e))$ implies $s_{1}(e) = s_{2}(e)$.
    Similarly for targets.
    We also need to show that $<$ and $\consistency$ are unique.
    Suppose that there exist
    \[
        \mathcal{L}^{\bot}_{1} = (V_{\mathcal{L}^{\bot}}, E_{\mathcal{L}^{\bot}}, s,t, <_{1})
    \qquad
    \text{and}
    \qquad
        \mathcal{L}^{\bot}_{2} = (V_{\mathcal{L}^{\bot}},E_{\mathcal{L}^{\bot}},s,t, <_{2})
    \]
    Because $g$ is homomorphism, it must be the case that 
    \[
        g_{E}(<_{1}(\iota_{V_{\mathcal{L}^{\bot}}}(v))) = <_{\mathcal{G}}(\iota_{V_{\mathcal{G}}}(g_{V}(v))) = g_{E}(<_{2}(\iota_{V_{\mathcal{L}^{\bot}}}(v)))
    \]
    which implies $<_{2}(\iota_{V_{\mathcal{L}^{\bot}}}(v)) = <_{1}(\iota_{V_{\mathcal{L}^{\bot}}}(v))$ for all $v$ such that $[v) \not = \varnothing$.
    Similarly for edges.
    Now suppose that $<_{1}(\iota_{V_{\mathcal{L}^{\bot}}}(v)) = e$ and $<_{2}(\iota_{V_{\mathcal{L}^{\bot}}}(v))$ is undefined.
    Then, $g_{E}(e) = <_{\mathcal{G}}(\iota_{V_{\mathcal{G}}}(g_{V}(v)))$ and there exists $v' \in V_{\mathcal{L}}$ and $v'' \in V_{\mathcal{L}^{\bot}_{2}}$ such that $[v') \not = \varnothing$ and there is a path from $v$ to $v''$ and $v''$ and $v'$ share a pre-image in $i+j$.
    However, because there is a path from $v$ to $v''$ it must be the case that $[v'') \not = \varnothing$ in $\mathcal{L}^{\bot}_{1}$, but then it violates our assumptions as there exists some vertex $u$ in $i+j$ such that $v'' = c_{V}(u)$ and $[v'') \not = \varnothing$ and $v' = h_{V,ext};h_{V,int}(u)$ and $[v') \not = \varnothing$.
    Therefore we get a contradiction. 
    Similarly for edges.
    Finally, let's suppose there exist
    \[
        \mathcal{L}^{\bot}_{1} = (V_{\mathcal{L}^{\bot}}, E_{\mathcal{L}^{\bot}}, s,t, <, \consistency_{1})
    \quad
    \text{and}
    \quad
        \mathcal{L}^{\bot}_{2} = (V_{\mathcal{L}^{\bot}},V_{\mathcal{L}^{\bot}},s,t,<, \consistency_{2})
    \]
    Because $g$ is a homomorphism, we have
    \[
        [~g_{V};\iota_{V_{\mathcal{G}}}, g_{E};\iota_{E_{\mathcal{G}}}~]^{*}(\consistency_{\mathcal{L}^{\bot}_{1}}(\iota_{V_{\mathcal{L}^{\bot}}}(v))) \subseteq \consistency_{\mathcal{G}}(g_{V};\iota_{V_{\mathcal{G}}}(v))
    \]
    \[
        [~g_{V};\iota_{V_{G}}, g_{E};\iota_{E_{\mathcal{G}}}]^{*}(\consistency_{\mathcal{L}^{\bot}_{2}}(\iota_{V_{\mathcal{L}^{\bot}}}(v))) \subseteq \consistency_{\mathcal{G}}(g_{V};\iota_{V_{\mathcal{G}}}(v))
    \]
    \begin{itemize}
        \item If $\consistency_{\mathcal{G}}(g_{V};\iota_{V_{\mathcal{G}}}(v)) = \varnothing$ then both lefthand sides should be $\varnothing$ and therefore the relations are equal.
        \item Suppose that $\consistency_{\mathcal{G}}(g_{V};\iota_{V_{\mathcal{G}}}(v)) \not = \varnothing$ which further means that $[g_{V};\iota_{V_{\mathcal{G}}}(v)) \not = \varnothing$.
              Consider the following cases.
        \begin{itemize}
            \item $\consistency_{\mathcal{L}^{\bot}_{1}}(\iota_{V_{\mathcal{L}^{\bot}}}(v)) \subseteq \consistency_{\mathcal{L}^{\bot}_{2}}(\iota_{V_{\mathcal{L}^{\bot}}}(v))$.
                  This means that there exists $v'$ such that 
                  \[
                    v' \consistency_{\mathcal{L}^{\bot}_{2}} v
                    \quad
                    \text{and}
                    \quad
                    v' \not \consistency_{\mathcal{L}^{\bot}_{1}} v
                \]
                  Because $g_{V}(v) \consistency_{\mathcal{G}} g_{V}(v')$ it means that there exist $u,u'$ such that there is a path from $v$ to $u$ and from $v'$ to $u'$ and there exist $w,w' \in V_{\mathcal{L}}$ such that $w \consistency_{\mathcal{L}} w'$ and $w,u$ share pre-image in $i+j$ as well as $w',u'$.
                  This again contradicts our assumptions as $u \consistency_{\mathcal{L}^{\bot}_{2}} u'$ and $w \consistency_{\mathcal{L}} w'$.
            \item $\consistency_{\mathcal{L}^{\bot}_{1}}(\iota_{V_{\mathcal{L}^{\bot}}}(v)) \cap \consistency_{\mathcal{L}^{\bot}_{2}}(\iota_{V_{\mathcal{L}^{\bot}}}(v)) = \varnothing$
                  Similar to the above.
            \item $\consistency_{\mathcal{L}^{\bot}_{1}}(\iota_{V_{\mathcal{L}^{\bot}}}(v)) \cap \consistency_{\mathcal{L}^{\bot}_{2}}(\iota_{V_{\mathcal{L}^{\bot}}}(v)) \not = \varnothing$
                  Similar to the above.
        \end{itemize}
    \end{itemize}
    \end{proof}
    % \update{Can we check the proof? I haven't used all the conditions from monogamous-ness above.
    % Although, if the morphism $i+j \to L$ is mono, the complement is unique for not-monogamous hypergraphs as well.}
\end{proposition}


\section{Proofs for Section \ref{sec:soundness-and-completeness}: Soundness and Completeness}

\begin{proposition}[Proposition~\ref{prop:soundness} restatement]
The category $\WellTypedMdaEcospans/{\mathcal{S}}$ is a semilattice-enriched PROP. 
\end{proposition}
\begin{proof}
    To prove this statement we essentially need to show that the functor $\llbracket - \rrbracket$ is well-defined, \textit{i.e.}, if $f = g$ in $\textsf{PROP}^{+}(\Sigma)$ then $\llbracket f \rrbracket = \llbracket g \rrbracket$ in $\WellTypedMdaEcospans / \mathcal{S}$ or $\llbracket f \rrbracket \Rrightarrow_{\mathcal{S}}^{+,*} \llbracket g \rrbracket$ in $\WellTypedMdaEcospans$.
    $f = g$ implies that there is a sequence of SMC and enrichment equations such that when applied to $f$ it is turned into $g$.
    As $\textsf{PROP}^{+}(\Sigma)$ is quotiented by SMC equations we have the following contexts $\mathcal{C}$ for any term $f$ such that $f = \mathcal{C}[l]$ for some other term $l$.
    \[
        \mathcal{C} := [] ~|~ c_1 + \ldots + \mathcal{C} + \ldots + c_n ~|~ c_1 ; (id \otimes \mathcal{C}); c_2
    \]
    we will proceed by induction on the number of equation applied to make $f$ into $g$.
    \begin{itemize}
        \item Base case. $f = g$ implies that for some equation $l = r$ in Figure~\ref{fig:string-equations}, $f = \mathcal{C}[l]$ and $g = \mathcal{C}[r]$.
              We then note that every subterm of $f$ corresponds to a convex down-closed subgraph of $\llbracket f \rrbracket$ and hence so does $l$.
              By computing pushout complement we remove the image of $\llbracket l \rrbracket$ from $\llbracket f \rrbracket$ and replace it with $\llbracket r \rrbracket$ which yields $\llbracket g \rrbracket = \llbracket \mathcal{C} \rrbracket [\llbracket r \rrbracket] = \llbracket \mathcal{C}[r] \rrbracket$ and $\llbracket f \rrbracket \Rrightarrow^{+}_{l = r} \llbracket g \rrbracket$.
        \item Suppose $f = g$ by applying less than $n$ equations implies $\llbracket f \rrbracket \Rrightarrow^{+,*}_{\mathcal{S}} \llbracket g \rrbracket$
        \item Let $f = g$ by applying exactly $n$ equations and then $f = g'$ by applying first $n-1$ equations and $\llbracket f \rrbracket \Rrightarrow^{+,*}_{\mathcal{S}} \llbracket g' \rrbracket$ and $g' = g$ by applying one equation.
              By reusing the base case we have that $\llbracket g' \rrbracket \Rrightarrow^{+}_{l = r} \llbracket g \rrbracket$ and hence $\llbracket f \rrbracket \Rrightarrow^{+,*}_{\mathcal{S}} \llbracket g \rrbracket$.
    \end{itemize}
    The only thing that is left to show that pushout complement and pushout exist for every equation in $\mathcal{S}$.
    Suppose, $f = g$ by applying $l = r$ which is the top left equation from~\ref{fig:string-equations}.
    $\llbracket r \rrbracket$ is then given in Figure~\ref{fig:structural_rule_pushout}.
    \begin{figure*}
        \centering
        \[
            \scalebox{0.45}{
                \tikzfig{combinatorial_semantics/structural_rule_pushout}
            }
        \]
        \caption{The image of the top left equation from Figure~\ref{fig:string-equations} under $\llbracket - \rrbracket$}
        \label{fig:structural_rule_pushout}
    \end{figure*}

    After we identify a convex down-closed image of the left-hand side of this rule within a graph $\llbracket f \rrbracket$ we remove the image by keeping only the top-level verticies.
    Note that because the image of all $a$'s and $b$'s are top-level verticies, we are allowed to pick any monomorphism for our pushout complement.
    And for the same reason the pushout for the right square exists.
    Then we simply glue the right-hand side of the rule into the hole.
    Similar argument applies to other rules as well.
\end{proof}

\begin{proposition}[Proposition~\ref{prop:wnormal_form} restatement]

For each cospan $f$ in ${\WellTypedMdaEcospans}/{\mathcal{S}}$ there is a \textit{weak normal form} such that 
\[
    f = f_1 + \ldots + f_n
\]
such that each $f_i$ contains no hierarchical edges,  and for all $i \neq j$ we have $f_i \neq f_j$.
\end{proposition}    
\begin{proof}
    First, we apply the interpretation of the rules (1)-(4) from Figure~\ref{fig:string-equations} which reduces the number of edges and vertices until there is only one top-level edge which is hierarchical.
    There will be a redex for these rules as long as there are at least two connected edges at least one of which is hierarchical.
    The above steps therefore produce a form like \[f_1 + \ldots + f_n\] where each $f_i$ is also of the form $g_1 + \ldots + g_m$ and so on.
    Then we apply the interpretation of rules (5)-(6) and (8) which reduces the number of hierarchical edges at each step.
    Once again, there is a redex for such a rule as long as there are at least two hierarchical edges.
    This will yield a form $f_1 + \ldots + f_n$ such that each of $f_i$ does not contain any hierarchical edges and for $i \not = j$, $f_i \not = f_j$.
    The latter is guaranteed by rule (8).
\end{proof}   


\end{document}
